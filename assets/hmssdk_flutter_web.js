/*! For license information please see hmssdk_flutter_web.js.LICENSE.txt */
(()=>{var e={387:(e,t,i)=>{var r;!function(n){var s=Object.hasOwnProperty,a=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},o="object"==typeof process&&"function"==typeof process.nextTick,l="function"==typeof Symbol,c="object"==typeof Reflect,d="function"==typeof setImmediate?setImmediate:setTimeout,u=l?c&&"function"==typeof Reflect.ownKeys?Reflect.ownKeys:function(e){var t=Object.getOwnPropertyNames(e);return t.push.apply(t,Object.getOwnPropertySymbols(e)),t}:Object.keys;function h(){this._events={},this._conf&&p.call(this,this._conf)}function p(e){e&&(this._conf=e,e.delimiter&&(this.delimiter=e.delimiter),e.maxListeners!==n&&(this._maxListeners=e.maxListeners),e.wildcard&&(this.wildcard=e.wildcard),e.newListener&&(this._newListener=e.newListener),e.removeListener&&(this._removeListener=e.removeListener),e.verboseMemoryLeak&&(this.verboseMemoryLeak=e.verboseMemoryLeak),e.ignoreErrors&&(this.ignoreErrors=e.ignoreErrors),this.wildcard&&(this.listenerTree={}))}function v(e,t){var i="(node) warning: possible EventEmitter memory leak detected. "+e+" listeners added. Use emitter.setMaxListeners() to increase limit.";if(this.verboseMemoryLeak&&(i+=" Event name: "+t+"."),"undefined"!=typeof process&&process.emitWarning){var r=new Error(i);r.name="MaxListenersExceededWarning",r.emitter=this,r.count=e,process.emitWarning(r)}else console.error(i),console.trace&&console.trace()}var m=function(e,t,i){var r=arguments.length;switch(r){case 0:return[];case 1:return[e];case 2:return[e,t];case 3:return[e,t,i];default:for(var n=new Array(r);r--;)n[r]=arguments[r];return n}};function g(e,t){for(var i={},r=e.length,s=t?t.length:0,a=0;a<r;a++)i[e[a]]=a<s?t[a]:n;return i}function f(e,t,i){var r,n;if(this._emitter=e,this._target=t,this._listeners={},this._listenersCount=0,(i.on||i.off)&&(r=i.on,n=i.off),t.addEventListener?(r=t.addEventListener,n=t.removeEventListener):t.addListener?(r=t.addListener,n=t.removeListener):t.on&&(r=t.on,n=t.off),!r&&!n)throw Error("target does not implement any known event API");if("function"!=typeof r)throw TypeError("on method must be a function");if("function"!=typeof n)throw TypeError("off method must be a function");this._on=r,this._off=n;var s=e._observers;s?s.push(this):e._observers=[this]}function y(e,t,i,r){var a=Object.assign({},t);if(!e)return a;if("object"!=typeof e)throw TypeError("options must be an object");var o,l,c,d=Object.keys(e),u=d.length;function h(e){throw Error('Invalid "'+o+'" option value'+(e?". Reason: "+e:""))}for(var p=0;p<u;p++){if(o=d[p],!r&&!s.call(t,o))throw Error('Unknown "'+o+'" option');(l=e[o])!==n&&(c=i[o],a[o]=c?c(l,h):l)}return a}function T(e,t){return"function"==typeof e&&e.hasOwnProperty("prototype")||t("value must be a constructor"),e}function S(e){var t="value must be type of "+e.join("|"),i=e.length,r=e[0],n=e[1];return 1===i?function(e,i){if(typeof e===r)return e;i(t)}:2===i?function(e,i){var s=typeof e;if(s===r||s===n)return e;i(t)}:function(r,n){for(var s=typeof r,a=i;a-- >0;)if(s===e[a])return r;n(t)}}Object.assign(f.prototype,{subscribe:function(e,t,i){var r=this,n=this._target,s=this._emitter,a=this._listeners,o=function(){var r=m.apply(null,arguments),a={data:r,name:t,original:e};if(i){var o=i.call(n,a);!1!==o&&s.emit.apply(s,[a.name].concat(r))}else s.emit.apply(s,[t].concat(r))};if(a[e])throw Error("Event '"+e+"' is already listening");this._listenersCount++,s._newListener&&s._removeListener&&!r._onNewListener?(this._onNewListener=function(i){i===t&&null===a[e]&&(a[e]=o,r._on.call(n,e,o))},s.on("newListener",this._onNewListener),this._onRemoveListener=function(i){i===t&&!s.hasListeners(i)&&a[e]&&(a[e]=null,r._off.call(n,e,o))},a[e]=null,s.on("removeListener",this._onRemoveListener)):(a[e]=o,r._on.call(n,e,o))},unsubscribe:function(e){var t,i,r,n=this,s=this._listeners,a=this._emitter,o=this._off,l=this._target;if(e&&"string"!=typeof e)throw TypeError("event must be a string");function c(){n._onNewListener&&(a.off("newListener",n._onNewListener),a.off("removeListener",n._onRemoveListener),n._onNewListener=null,n._onRemoveListener=null);var e=R.call(a,n);a._observers.splice(e,1)}if(e){if(!(t=s[e]))return;o.call(l,e,t),delete s[e],--this._listenersCount||c()}else{for(r=(i=u(s)).length;r-- >0;)e=i[r],o.call(l,e,s[e]);this._listeners={},this._listenersCount=0,c()}}});var k=S(["function"]),E=S(["object","function"]);function b(e,t,i){var r,n,s,a=0,o=new e((function(l,c,d){function u(){n&&(n=null),a&&(clearTimeout(a),a=0)}i=y(i,{timeout:0,overload:!1},{timeout:function(e,t){return("number"!=typeof(e*=1)||e<0||!Number.isFinite(e))&&t("timeout must be a positive number"),e}}),r=!i.overload&&"function"==typeof e.prototype.cancel&&"function"==typeof d;var h=function(e){u(),l(e)},p=function(e){u(),c(e)};r?t(h,p,d):(n=[function(e){p(e||Error("canceled"))}],t(h,p,(function(e){if(s)throw Error("Unable to subscribe on cancel event asynchronously");if("function"!=typeof e)throw TypeError("onCancel callback must be a function");n.push(e)})),s=!0),i.timeout>0&&(a=setTimeout((function(){var e=Error("timeout");e.code="ETIMEDOUT",a=0,o.cancel(e),c(e)}),i.timeout))}));return r||(o.cancel=function(e){if(n){for(var t=n.length,i=1;i<t;i++)n[i](e);n[0](e),n=null}}),o}function R(e){var t=this._observers;if(!t)return-1;for(var i=t.length,r=0;r<i;r++)if(t[r]._target===e)return r;return-1}function C(e,t,i,r,n){if(!i)return null;if(0===r){var s=typeof t;if("string"===s){var a,o,l=0,c=0,d=this.delimiter,h=d.length;if(-1!==(o=t.indexOf(d))){a=new Array(5);do{a[l++]=t.slice(c,o),c=o+h}while(-1!==(o=t.indexOf(d,c)));a[l++]=t.slice(c),t=a,n=l}else t=[t],n=1}else"object"===s?n=t.length:(t=[t],n=1)}var p,v,m,g,f,y,T,S=null,k=t[r],E=t[r+1];if(r===n)i._listeners&&("function"==typeof i._listeners?(e&&e.push(i._listeners),S=[i]):(e&&e.push.apply(e,i._listeners),S=[i]));else{if("*"===k){for(o=(y=u(i)).length;o-- >0;)"_listeners"!==(p=y[o])&&(T=C(e,t,i[p],r+1,n))&&(S?S.push.apply(S,T):S=T);return S}if("**"===k){for((f=r+1===n||r+2===n&&"*"===E)&&i._listeners&&(S=C(e,t,i,n,n)),o=(y=u(i)).length;o-- >0;)"_listeners"!==(p=y[o])&&("*"===p||"**"===p?(i[p]._listeners&&!f&&(T=C(e,t,i[p],n,n))&&(S?S.push.apply(S,T):S=T),T=C(e,t,i[p],r,n)):T=C(e,t,i[p],p===E?r+2:r,n),T&&(S?S.push.apply(S,T):S=T));return S}i[k]&&(S=C(e,t,i[k],r+1,n))}if((v=i["*"])&&C(e,t,v,r+1,n),m=i["**"])if(r<n)for(m._listeners&&C(e,t,m,n,n),o=(y=u(m)).length;o-- >0;)"_listeners"!==(p=y[o])&&(p===E?C(e,t,m[p],r+2,n):p===k?C(e,t,m[p],r+1,n):((g={})[p]=m[p],C(e,t,{"**":g},r+1,n)));else m._listeners?C(e,t,m,n,n):m["*"]&&m["*"]._listeners&&C(e,t,m["*"],n,n);return S}function P(e,t,i){var r,n,s=0,a=0,o=this.delimiter,l=o.length;if("string"==typeof e)if(-1!==(r=e.indexOf(o))){n=new Array(5);do{n[s++]=e.slice(a,r),a=r+l}while(-1!==(r=e.indexOf(o,a)));n[s++]=e.slice(a)}else n=[e],s=1;else n=e,s=e.length;if(s>1)for(r=0;r+1<s;r++)if("**"===n[r]&&"**"===n[r+1])return;var c,d=this.listenerTree;for(r=0;r<s;r++)if(d=d[c=n[r]]||(d[c]={}),r===s-1)return d._listeners?("function"==typeof d._listeners&&(d._listeners=[d._listeners]),i?d._listeners.unshift(t):d._listeners.push(t),!d._listeners.warned&&this._maxListeners>0&&d._listeners.length>this._maxListeners&&(d._listeners.warned=!0,v.call(this,d._listeners.length,c))):d._listeners=t,!0;return!0}function _(e,t,i,r){for(var n,s,a,o,l=u(e),c=l.length,d=e._listeners;c-- >0;)n=e[s=l[c]],a="_listeners"===s?i:i?i.concat(s):[s],o=r||"symbol"==typeof s,d&&t.push(o?a:a.join(this.delimiter)),"object"==typeof n&&_.call(this,n,t,a,o);return t}function A(e){for(var t,i,r,n=u(e),s=n.length;s-- >0;)(t=e[i=n[s]])&&(r=!0,"_listeners"===i||A(t)||delete e[i]);return r}function w(e,t,i){this.emitter=e,this.event=t,this.listener=i}function I(e,t,i){if(!0===i)s=!0;else if(!1===i)r=!0;else{if(!i||"object"!=typeof i)throw TypeError("options should be an object or true");var r=i.async,s=i.promisify,a=i.nextTick,l=i.objectify}if(r||a||s){var c=t,u=t._origin||t;if(a&&!o)throw Error("process.nextTick is not supported");s===n&&(s="AsyncFunction"===t.constructor.name),t=function(){var e=arguments,t=this,i=this.event;return s?a?Promise.resolve():new Promise((function(e){d(e)})).then((function(){return t.event=i,c.apply(t,e)})):(a?process.nextTick:d)((function(){t.event=i,c.apply(t,e)}))},t._async=!0,t._origin=u}return[t,l?new w(this,e,t):this]}function D(e){this._events={},this._newListener=!1,this._removeListener=!1,this.verboseMemoryLeak=!1,p.call(this,e)}w.prototype.off=function(){return this.emitter.off(this.event,this.listener),this},D.EventEmitter2=D,D.prototype.listenTo=function(e,t,i){if("object"!=typeof e)throw TypeError("target musts be an object");var r=this;function s(t){if("object"!=typeof t)throw TypeError("events must be an object");var n,s=i.reducers,a=R.call(r,e);n=-1===a?new f(r,e,i):r._observers[a];for(var o,l=u(t),c=l.length,d="function"==typeof s,h=0;h<c;h++)o=l[h],n.subscribe(o,t[o]||o,d?s:s&&s[o])}return i=y(i,{on:n,off:n,reducers:n},{on:k,off:k,reducers:E}),a(t)?s(g(t)):s("string"==typeof t?g(t.split(/\s+/)):t),this},D.prototype.stopListeningTo=function(e,t){var i=this._observers;if(!i)return!1;var r,n=i.length,s=!1;if(e&&"object"!=typeof e)throw TypeError("target should be an object");for(;n-- >0;)r=i[n],e&&r._target!==e||(r.unsubscribe(t),s=!0);return s},D.prototype.delimiter=".",D.prototype.setMaxListeners=function(e){e!==n&&(this._maxListeners=e,this._conf||(this._conf={}),this._conf.maxListeners=e)},D.prototype.getMaxListeners=function(){return this._maxListeners},D.prototype.event="",D.prototype.once=function(e,t,i){return this._once(e,t,!1,i)},D.prototype.prependOnceListener=function(e,t,i){return this._once(e,t,!0,i)},D.prototype._once=function(e,t,i,r){return this._many(e,1,t,i,r)},D.prototype.many=function(e,t,i,r){return this._many(e,t,i,!1,r)},D.prototype.prependMany=function(e,t,i,r){return this._many(e,t,i,!0,r)},D.prototype._many=function(e,t,i,r,n){var s=this;if("function"!=typeof i)throw new Error("many only accepts instances of Function");function a(){return 0==--t&&s.off(e,a),i.apply(this,arguments)}return a._origin=i,this._on(e,a,r,n)},D.prototype.emit=function(){if(!this._events&&!this._all)return!1;this._events||h.call(this);var e,t,i,r,n,s,a=arguments[0],o=this.wildcard;if("newListener"===a&&!this._newListener&&!this._events.newListener)return!1;if(o&&(e=a,"newListener"!==a&&"removeListener"!==a&&"object"==typeof a)){if(i=a.length,l)for(r=0;r<i;r++)if("symbol"==typeof a[r]){s=!0;break}s||(a=a.join(this.delimiter))}var c,d=arguments.length;if(this._all&&this._all.length)for(r=0,i=(c=this._all.slice()).length;r<i;r++)switch(this.event=a,d){case 1:c[r].call(this,a);break;case 2:c[r].call(this,a,arguments[1]);break;case 3:c[r].call(this,a,arguments[1],arguments[2]);break;default:c[r].apply(this,arguments)}if(o)c=[],C.call(this,c,e,this.listenerTree,0,i);else{if("function"==typeof(c=this._events[a])){switch(this.event=a,d){case 1:c.call(this);break;case 2:c.call(this,arguments[1]);break;case 3:c.call(this,arguments[1],arguments[2]);break;default:for(t=new Array(d-1),n=1;n<d;n++)t[n-1]=arguments[n];c.apply(this,t)}return!0}c&&(c=c.slice())}if(c&&c.length){if(d>3)for(t=new Array(d-1),n=1;n<d;n++)t[n-1]=arguments[n];for(r=0,i=c.length;r<i;r++)switch(this.event=a,d){case 1:c[r].call(this);break;case 2:c[r].call(this,arguments[1]);break;case 3:c[r].call(this,arguments[1],arguments[2]);break;default:c[r].apply(this,t)}return!0}if(!this.ignoreErrors&&!this._all&&"error"===a)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");return!!this._all},D.prototype.emitAsync=function(){if(!this._events&&!this._all)return!1;this._events||h.call(this);var e,t,i,r,n,s,a=arguments[0],o=this.wildcard;if("newListener"===a&&!this._newListener&&!this._events.newListener)return Promise.resolve([!1]);if(o&&(e=a,"newListener"!==a&&"removeListener"!==a&&"object"==typeof a)){if(r=a.length,l)for(n=0;n<r;n++)if("symbol"==typeof a[n]){t=!0;break}t||(a=a.join(this.delimiter))}var c,d=[],u=arguments.length;if(this._all)for(n=0,r=this._all.length;n<r;n++)switch(this.event=a,u){case 1:d.push(this._all[n].call(this,a));break;case 2:d.push(this._all[n].call(this,a,arguments[1]));break;case 3:d.push(this._all[n].call(this,a,arguments[1],arguments[2]));break;default:d.push(this._all[n].apply(this,arguments))}if(o?(c=[],C.call(this,c,e,this.listenerTree,0)):c=this._events[a],"function"==typeof c)switch(this.event=a,u){case 1:d.push(c.call(this));break;case 2:d.push(c.call(this,arguments[1]));break;case 3:d.push(c.call(this,arguments[1],arguments[2]));break;default:for(i=new Array(u-1),s=1;s<u;s++)i[s-1]=arguments[s];d.push(c.apply(this,i))}else if(c&&c.length){if(c=c.slice(),u>3)for(i=new Array(u-1),s=1;s<u;s++)i[s-1]=arguments[s];for(n=0,r=c.length;n<r;n++)switch(this.event=a,u){case 1:d.push(c[n].call(this));break;case 2:d.push(c[n].call(this,arguments[1]));break;case 3:d.push(c[n].call(this,arguments[1],arguments[2]));break;default:d.push(c[n].apply(this,i))}}else if(!this.ignoreErrors&&!this._all&&"error"===a)return arguments[1]instanceof Error?Promise.reject(arguments[1]):Promise.reject("Uncaught, unspecified 'error' event.");return Promise.all(d)},D.prototype.on=function(e,t,i){return this._on(e,t,!1,i)},D.prototype.prependListener=function(e,t,i){return this._on(e,t,!0,i)},D.prototype.onAny=function(e){return this._onAny(e,!1)},D.prototype.prependAny=function(e){return this._onAny(e,!0)},D.prototype.addListener=D.prototype.on,D.prototype._onAny=function(e,t){if("function"!=typeof e)throw new Error("onAny only accepts instances of Function");return this._all||(this._all=[]),t?this._all.unshift(e):this._all.push(e),this},D.prototype._on=function(e,t,i,r){if("function"==typeof e)return this._onAny(e,t),this;if("function"!=typeof t)throw new Error("on only accepts instances of Function");this._events||h.call(this);var s,a=this;return r!==n&&(t=(s=I.call(this,e,t,r))[0],a=s[1]),this._newListener&&this.emit("newListener",e,t),this.wildcard?(P.call(this,e,t,i),a):(this._events[e]?("function"==typeof this._events[e]&&(this._events[e]=[this._events[e]]),i?this._events[e].unshift(t):this._events[e].push(t),!this._events[e].warned&&this._maxListeners>0&&this._events[e].length>this._maxListeners&&(this._events[e].warned=!0,v.call(this,this._events[e].length,e))):this._events[e]=t,a)},D.prototype.off=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");var i,r=[];if(this.wildcard){var n="string"==typeof e?e.split(this.delimiter):e.slice();if(!(r=C.call(this,null,n,this.listenerTree,0)))return this}else{if(!this._events[e])return this;i=this._events[e],r.push({_listeners:i})}for(var s=0;s<r.length;s++){var o=r[s];if(i=o._listeners,a(i)){for(var l=-1,c=0,d=i.length;c<d;c++)if(i[c]===t||i[c].listener&&i[c].listener===t||i[c]._origin&&i[c]._origin===t){l=c;break}if(l<0)continue;return this.wildcard?o._listeners.splice(l,1):this._events[e].splice(l,1),0===i.length&&(this.wildcard?delete o._listeners:delete this._events[e]),this._removeListener&&this.emit("removeListener",e,t),this}(i===t||i.listener&&i.listener===t||i._origin&&i._origin===t)&&(this.wildcard?delete o._listeners:delete this._events[e],this._removeListener&&this.emit("removeListener",e,t))}return this.listenerTree&&A(this.listenerTree),this},D.prototype.offAny=function(e){var t,i=0,r=0;if(e&&this._all&&this._all.length>0){for(i=0,r=(t=this._all).length;i<r;i++)if(e===t[i])return t.splice(i,1),this._removeListener&&this.emit("removeListenerAny",e),this}else{if(t=this._all,this._removeListener)for(i=0,r=t.length;i<r;i++)this.emit("removeListenerAny",t[i]);this._all=[]}return this},D.prototype.removeListener=D.prototype.off,D.prototype.removeAllListeners=function(e){if(e===n)return!this._events||h.call(this),this;if(this.wildcard){var t,i=C.call(this,null,e,this.listenerTree,0);if(!i)return this;for(t=0;t<i.length;t++)i[t]._listeners=null;this.listenerTree&&A(this.listenerTree)}else this._events&&(this._events[e]=null);return this},D.prototype.listeners=function(e){var t,i,r,s,a,o=this._events;if(e===n){if(this.wildcard)throw Error("event name required for wildcard emitter");if(!o)return[];for(s=(t=u(o)).length,r=[];s-- >0;)"function"==typeof(i=o[t[s]])?r.push(i):r.push.apply(r,i);return r}if(this.wildcard){if(!(a=this.listenerTree))return[];var l=[],c="string"==typeof e?e.split(this.delimiter):e.slice();return C.call(this,l,c,a,0),l}return o&&(i=o[e])?"function"==typeof i?[i]:i:[]},D.prototype.eventNames=function(e){var t=this._events;return this.wildcard?_.call(this,this.listenerTree,[],null,e):t?u(t):[]},D.prototype.listenerCount=function(e){return this.listeners(e).length},D.prototype.hasListeners=function(e){if(this.wildcard){var t=[],i="string"==typeof e?e.split(this.delimiter):e.slice();return C.call(this,t,i,this.listenerTree,0),t.length>0}var r=this._events,s=this._all;return!!(s&&s.length||r&&(e===n?u(r).length:r[e]))},D.prototype.listenersAny=function(){return this._all?this._all:[]},D.prototype.waitFor=function(e,t){var i=this,r=typeof t;return"number"===r?t={timeout:t}:"function"===r&&(t={filter:t}),b((t=y(t,{timeout:0,filter:n,handleError:!1,Promise,overload:!1},{filter:k,Promise:T})).Promise,(function(r,n,s){function a(){var s=t.filter;if(!s||s.apply(i,arguments))if(i.off(e,a),t.handleError){var o=arguments[0];o?n(o):r(m.apply(null,arguments).slice(1))}else r(m.apply(null,arguments))}s((function(){i.off(e,a)})),i._on(e,a,!1)}),{timeout:t.timeout,overload:t.overload})};var O=D.prototype;Object.defineProperties(D,{defaultMaxListeners:{get:function(){return O._maxListeners},set:function(e){if("number"!=typeof e||e<0||Number.isNaN(e))throw TypeError("n must be a non-negative number");O._maxListeners=e},enumerable:!0},once:{value:function(e,t,i){return b((i=y(i,{Promise,timeout:0,overload:!1},{Promise:T})).Promise,(function(i,r,n){var s;if("function"==typeof e.addEventListener)return s=function(){i(m.apply(null,arguments))},n((function(){e.removeEventListener(t,s)})),void e.addEventListener(t,s,{once:!0});var a,o=function(){a&&e.removeListener("error",a),i(m.apply(null,arguments))};"error"!==t&&(a=function(i){e.removeListener(t,o),r(i)},e.once("error",a)),n((function(){a&&e.removeListener("error",a),e.removeListener(t,o)})),e.once(t,o)}),{timeout:i.timeout,overload:i.overload})},writable:!0,configurable:!0}}),Object.defineProperties(O,{_maxListeners:{value:10,writable:!0,configurable:!0},_observers:{value:null,writable:!0,configurable:!0}}),(r=function(){return D}.call(t,i,t,e))===n||(e.exports=r)}()},692:e=>{var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},766:(e,t,i)=>{var r=i(962),n=i(776);t.cW=n,t.Qc=r.parse,r.parseParams,r.parseFmtpConfig,r.parsePayloads,r.parseRemoteCandidates,r.parseImageAttributes,r.parseSimulcastStreamList},962:(e,t,i)=>{var r=function(e){return String(Number(e))===e?Number(e):e},n=function(e,t,i){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var s=e.push?{}:n?t[e.name]:t;!function(e,t,i,n){if(n&&!i)t[n]=r(e[1]);else for(var s=0;s<i.length;s+=1)null!=e[s+1]&&(t[i[s]]=r(e[s+1]))}(i.match(e.reg),s,e.names,e.name),e.push&&t[e.push].push(s)},s=i(692),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},i=[],r=t;return e.split(/(\r\n|\r|\n)/).filter(a).forEach((function(e){var t=e[0],a=e.slice(2);"m"===t&&(i.push({rtp:[],fmtp:[]}),r=i[i.length-1]);for(var o=0;o<(s[t]||[]).length;o+=1){var l=s[t][o];if(l.reg.test(a))return n(l,r,a)}})),t.media=i,t};var o=function(e,t){var i=t.split(/=(.+)/,2);return 2===i.length?e[i[0]]=r(i[1]):1===i.length&&t.length>1&&(e[i[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],i=e.split(" ").map(r),n=0;n<i.length;n+=3)t.push({component:i[n],ip:i[n+1],port:i[n+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,i=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),i=!0),{scid:t,paused:i}}))}))}},776:(e,t,i)=>{var r=i(692),n=/%[sdv%]/g,s=function(e){var t=1,i=arguments,r=i.length;return e.replace(n,(function(e){if(t>=r)return e;var n=i[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}}))},a=function(e,t,i){var r=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var n=0;n<t.names.length;n+=1){var a=t.names[n];t.name?r.push(i[t.name][a]):r.push(i[t.names[n]])}else r.push(i[t.name]);return s.apply(null,r)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],l=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var i=t.outerOrder||o,n=t.innerOrder||l,s=[];return i.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(a(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(a(t,i,e))}))}))})),e.media.forEach((function(e){s.push(a("m",r.m[0],e)),n.forEach((function(t){r[t].forEach((function(i){i.name in e&&null!=e[i.name]?s.push(a(t,i,e)):i.push in e&&null!=e[i.push]&&e[i.push].forEach((function(e){s.push(a(t,i,e))}))}))}))})),s.join("\r\n")+"\r\n"}},539:e=>{"use strict";const t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){const i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((e=>0===e.indexOf(i)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const i={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let e=8;e<t.length;e+=2)switch(t[e]){case"raddr":i.relatedAddress=t[e+1];break;case"rport":i.relatedPort=parseInt(t[e+1],10);break;case"tcptype":i.tcpType=t[e+1];break;case"ufrag":i.ufrag=t[e+1],i.usernameFragment=t[e+1];break;default:void 0===i[t[e]]&&(i[t[e]]=t[e+1])}return i},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const i=e.component;"rtp"===i?t.push(1):"rtcp"===i?t.push(2):t.push(i),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){let t=e.substr(9).split(" ");const i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){const t={};let i;const r=e.substr(e.indexOf(" ")+1).split(";");for(let e=0;e<r.length;e++)i=r[e].trim().split("="),t[i[0].trim()]=i[1];return t},t.writeFmtp=function(e){let t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const r=[];Object.keys(e.parameters).forEach((t=>{void 0!==e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+i+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(i.attribute=e.substr(t+1,r-t-1),i.value=e.substr(r+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){const t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){const t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){const t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){const r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],n=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" ");for(let n=3;n<r.length;n++){const s=r[n],a=t.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(a){const r=t.parseRtpMap(a),n=t.matchPrefix(e,"a=fmtp:"+s+" ");switch(r.parameters=n.length?t.parseFmtp(n[0]):{},r.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(t.parseRtcpFb),i.codecs.push(r),r.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(r.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((e=>{i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){let r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=i.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((e=>{r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));let n=0;return i.codecs.forEach((e=>{e.maxptime>n&&(n=e.maxptime)})),n>0&&(r+="a=maxptime:"+n+"\r\n"),i.headerExtensions&&i.headerExtensions.forEach((e=>{r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){const i=[],r=t.parseRtpParameters(e),n=-1!==r.fecMechanisms.indexOf("RED"),s=-1!==r.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),o=a.length>0&&a[0].ssrc;let l;const c=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substr(17).split(" ").map((e=>parseInt(e,10)))));c.length>0&&c[0].length>1&&c[0][0]===o&&(l=c[0][1]),r.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:o,codecPayloadType:parseInt(e.parameters.apt,10)};o&&l&&(t.rtx={ssrc:l}),i.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:o,mechanism:s?"red+ulpfec":"red"},i.push(t))}})),0===i.length&&o&&i.push({ssrc:o});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,i.forEach((e=>{e.maxBitrate=d}))),i},t.parseRtcpParameters=function(e){const i={},r=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const n=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=n.length>0,i.compound=0===n.length;const s=t.matchPrefix(e,"a=rtcp-mux");return i.mux=s.length>0,i},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let i;const r=t.matchPrefix(e,"a=msid:");if(1===r.length)return i=r[0].substr(7).split(" "),{stream:i[0],track:i[1]};const n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return n.length>0?(i=n[0].value.split(" "),{stream:i[0],track:i[1]}):void 0},t.parseSctpDescription=function(e){const i=t.parseMLine(e),r=t.matchPrefix(e,"a=max-message-size:");let n;r.length>0&&(n=parseInt(r[0].substr(19),10)),isNaN(n)&&(n=65536);const s=t.matchPrefix(e,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substr(12),10),protocol:i.fmt,maxMessageSize:n};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substr(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){let i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,r){let n;const s=void 0!==i?i:2;return n=e||t.generateSessionId(),"v=0\r\no="+(r||"thisisadapterortc")+" "+n+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,i){const r=t.splitLines(e);for(let e=0;e<r.length;e++)switch(r[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[e].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){const i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const i=t.splitLines(e);for(let e=0;e<i.length;e++)if(i[e].length<2||"="!==i[e].charAt(1))return!1;return!0},e.exports=t},238:function(e,t,i){var r;!function(n,s){"use strict";var a="function",o="undefined",l="object",c="string",d="model",u="name",h="type",p="vendor",v="version",m="architecture",g="console",f="mobile",y="tablet",T="smarttv",S="wearable",k="embedded",E="Amazon",b="Apple",R="ASUS",C="BlackBerry",P="Google",_="Huawei",A="LG",w="Microsoft",I="Motorola",D="Samsung",O="Sony",N="Xiaomi",M="Zebra",L="Facebook",x=function(e){for(var t={},i=0;i<e.length;i++)t[e[i].toUpperCase()]=e[i];return t},U=function(e,t){return typeof e===c&&-1!==F(t).indexOf(F(e))},F=function(e){return e.toLowerCase()},G=function(e,t){if(typeof e===c)return e=e.replace(/^\s\s*/,"").replace(/\s\s*$/,""),typeof t===o?e:e.substring(0,255)},B=function(e,t){for(var i,r,n,o,c,d,u=0;u<t.length&&!c;){var h=t[u],p=t[u+1];for(i=r=0;i<h.length&&!c;)if(c=h[i++].exec(e))for(n=0;n<p.length;n++)d=c[++r],typeof(o=p[n])===l&&o.length>0?2===o.length?typeof o[1]==a?this[o[0]]=o[1].call(this,d):this[o[0]]=o[1]:3===o.length?typeof o[1]!==a||o[1].exec&&o[1].test?this[o[0]]=d?d.replace(o[1],o[2]):s:this[o[0]]=d?o[1].call(this,d,o[2]):s:4===o.length&&(this[o[0]]=d?o[3].call(this,d.replace(o[1],o[2])):s):this[o]=d||s;u+=2}},V=function(e,t){for(var i in t)if(typeof t[i]===l&&t[i].length>0){for(var r=0;r<t[i].length;r++)if(U(t[i][r],e))return"?"===i?s:i}else if(U(t[i],e))return"?"===i?s:i;return e},j={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},K={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[v,[u,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[v,[u,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[u,v],[/opios[\/ ]+([\w\.]+)/i],[v,[u,"Opera Mini"]],[/\bopr\/([\w\.]+)/i],[v,[u,"Opera"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[u,v],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[v,[u,"UCBrowser"]],[/\bqbcore\/([\w\.]+)/i],[v,[u,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[v,[u,"WeChat"]],[/konqueror\/([\w\.]+)/i],[v,[u,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[v,[u,"IE"]],[/yabrowser\/([\w\.]+)/i],[v,[u,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[u,/(.+)/,"$1 Secure Browser"],v],[/\bfocus\/([\w\.]+)/i],[v,[u,"Firefox Focus"]],[/\bopt\/([\w\.]+)/i],[v,[u,"Opera Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[v,[u,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[v,[u,"Dolphin"]],[/coast\/([\w\.]+)/i],[v,[u,"Opera Coast"]],[/miuibrowser\/([\w\.]+)/i],[v,[u,"MIUI Browser"]],[/fxios\/([-\w\.]+)/i],[v,[u,"Firefox"]],[/\bqihu|(qi?ho?o?|360)browser/i],[[u,"360 Browser"]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[u,/(.+)/,"$1 Browser"],v],[/(comodo_dragon)\/([\w\.]+)/i],[[u,/_/g," "],v],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[u,v],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[u],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[u,L],v],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[u,v],[/\bgsa\/([\w\.]+) .*safari\//i],[v,[u,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[v,[u,"Chrome Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[u,"Chrome WebView"],v],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[v,[u,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[u,v],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[v,[u,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[v,u],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[u,[v,V,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[u,v],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[u,"Netscape"],v],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[v,[u,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[u,v]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[m,"amd64"]],[/(ia32(?=;))/i],[[m,F]],[/((?:i[346]|x)86)[;\)]/i],[[m,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[m,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[m,"armhf"]],[/windows (ce|mobile); ppc;/i],[[m,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[m,/ower/,"",F]],[/(sun4\w)[;\)]/i],[[m,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[m,F]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[p,D],[h,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[d,[p,D],[h,f]],[/\((ip(?:hone|od)[\w ]*);/i],[d,[p,b],[h,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[p,b],[h,y]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[p,_],[h,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[d,[p,_],[h,f]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[d,/_/g," "],[p,N],[h,f]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[p,N],[h,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[p,"OPPO"],[h,f]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[p,"Vivo"],[h,f]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[d,[p,"Realme"],[h,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[p,I],[h,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[p,I],[h,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[p,A],[h,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[p,A],[h,f]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[p,"Lenovo"],[h,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[p,"Nokia"],[h,f]],[/(pixel c)\b/i],[d,[p,P],[h,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[p,P],[h,f]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[p,O],[h,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[p,O],[h,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[p,"OnePlus"],[h,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[p,E],[h,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[p,E],[h,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,p,[h,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[p,C],[h,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[p,R],[h,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[p,R],[h,f]],[/(nexus 9)/i],[d,[p,"HTC"],[h,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[p,[d,/_/g," "],[h,f]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[p,"Acer"],[h,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[p,"Meizu"],[h,f]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[p,"Sharp"],[h,f]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[p,d,[h,f]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[p,d,[h,y]],[/(surface duo)/i],[d,[p,w],[h,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[p,"Fairphone"],[h,f]],[/(u304aa)/i],[d,[p,"AT&T"],[h,f]],[/\bsie-(\w*)/i],[d,[p,"Siemens"],[h,f]],[/\b(rct\w+) b/i],[d,[p,"RCA"],[h,y]],[/\b(venue[\d ]{2,7}) b/i],[d,[p,"Dell"],[h,y]],[/\b(q(?:mv|ta)\w+) b/i],[d,[p,"Verizon"],[h,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[p,"Barnes & Noble"],[h,y]],[/\b(tm\d{3}\w+) b/i],[d,[p,"NuVision"],[h,y]],[/\b(k88) b/i],[d,[p,"ZTE"],[h,y]],[/\b(nx\d{3}j) b/i],[d,[p,"ZTE"],[h,f]],[/\b(gen\d{3}) b.+49h/i],[d,[p,"Swiss"],[h,f]],[/\b(zur\d{3}) b/i],[d,[p,"Swiss"],[h,y]],[/\b((zeki)?tb.*\b) b/i],[d,[p,"Zeki"],[h,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[p,"Dragon Touch"],d,[h,y]],[/\b(ns-?\w{0,9}) b/i],[d,[p,"Insignia"],[h,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[p,"NextBook"],[h,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[p,"Voice"],d,[h,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[p,"LvTel"],d,[h,f]],[/\b(ph-1) /i],[d,[p,"Essential"],[h,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[p,"Envizen"],[h,y]],[/\b(trio[-\w\. ]+) b/i],[d,[p,"MachSpeed"],[h,y]],[/\btu_(1491) b/i],[d,[p,"Rotor"],[h,y]],[/(shield[\w ]+) b/i],[d,[p,"Nvidia"],[h,y]],[/(sprint) (\w+)/i],[p,d,[h,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[p,w],[h,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[p,M],[h,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[p,M],[h,f]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[p,d,[h,g]],[/droid.+; (shield) bui/i],[d,[p,"Nvidia"],[h,g]],[/(playstation [345portablevi]+)/i],[d,[p,O],[h,g]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[p,w],[h,g]],[/smart-tv.+(samsung)/i],[p,[h,T]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[p,D],[h,T]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[p,A],[h,T]],[/(apple) ?tv/i],[p,[d,"Apple TV"],[h,T]],[/crkey/i],[[d,"Chromecast"],[p,P],[h,T]],[/droid.+aft(\w)( bui|\))/i],[d,[p,E],[h,T]],[/\(dtv[\);].+(aquos)/i],[d,[p,"Sharp"],[h,T]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[p,G],[d,G],[h,T]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[h,T]],[/((pebble))app/i],[p,d,[h,S]],[/droid.+; (glass) \d/i],[d,[p,P],[h,S]],[/droid.+; (wt63?0{2,3})\)/i],[d,[p,M],[h,S]],[/(quest( 2)?)/i],[d,[p,L],[h,S]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[p,[h,k]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[d,[h,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[h,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[h,y]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[h,f]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[p,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[v,[u,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[v,[u,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[u,v],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[v,u]],os:[[/microsoft (windows) (vista|xp)/i],[u,v],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[u,[v,V,j]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[u,"Windows"],[v,V,j]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[v,/_/g,"."],[u,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[u,"Mac OS"],[v,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[v,u],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[u,v],[/\(bb(10);/i],[v,[u,C]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[v,[u,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[v,[u,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[v,[u,"webOS"]],[/crkey\/([\d\.]+)/i],[v,[u,"Chromecast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[u,"Chromium OS"],v],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[u,v],[/(sunos) ?([\w\.\d]*)/i],[[u,"Solaris"],v],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[u,v]]},$=function(e,t){if(typeof e===l&&(t=e,e=s),!(this instanceof $))return new $(e,t).getResult();var i=e||(typeof n!==o&&n.navigator&&n.navigator.userAgent?n.navigator.userAgent:""),r=t?function(e,t){var i={};for(var r in e)t[r]&&t[r].length%2==0?i[r]=t[r].concat(e[r]):i[r]=e[r];return i}(K,t):K;return this.getBrowser=function(){var e,t={};return t.name=s,t.version=s,B.call(t,i,r.browser),t.major=typeof(e=t.version)===c?e.replace(/[^\d\.]/g,"").split(".")[0]:s,t},this.getCPU=function(){var e={};return e.architecture=s,B.call(e,i,r.cpu),e},this.getDevice=function(){var e={};return e.vendor=s,e.model=s,e.type=s,B.call(e,i,r.device),e},this.getEngine=function(){var e={};return e.name=s,e.version=s,B.call(e,i,r.engine),e},this.getOS=function(){var e={};return e.name=s,e.version=s,B.call(e,i,r.os),e},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return i},this.setUA=function(e){return i=typeof e===c&&e.length>255?G(e,255):e,this},this.setUA(i),this};$.VERSION="1.0.2",$.BROWSER=x([u,v,"major"]),$.CPU=x([m]),$.DEVICE=x([d,p,h,g,f,T,y,S,k]),$.ENGINE=$.OS=x([u,v]),typeof t!==o?(e.exports&&(t=e.exports=$),t.UAParser=$):i.amdO?(r=function(){return $}.call(t,i,t,e))===s||(e.exports=r):typeof n!==o&&(n.UAParser=$);var H=typeof n!==o&&(n.jQuery||n.Zepto);if(H&&!H.ua){var W=new $;H.ua=W.getResult(),H.ua.get=function(){return W.getUA()},H.ua.set=function(e){W.setUA(e);var t=W.getResult();for(var i in t)H.ua[i]=t[i]}}}("object"==typeof window?window:this)}},t={};function i(r){var n=t[r];if(void 0!==n)return n.exports;var s=t[r]={exports:{}};return e[r].call(s.exports,s,s.exports,i),s.exports}i.amdO={},i.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return i.d(t,{a:t}),t},i.d=(e,t)=>{for(var r in t)i.o(t,r)&&!i.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";var e={};i.r(e),i.d(e,{fixNegotiationNeeded:()=>Pe,shimAddTrackRemoveTrack:()=>Re,shimAddTrackRemoveTrackWithNative:()=>be,shimGetDisplayMedia:()=>fe,shimGetSendersWithDtmf:()=>Se,shimGetStats:()=>ke,shimGetUserMedia:()=>ge,shimMediaStream:()=>ye,shimOnTrack:()=>Te,shimPeerConnection:()=>Ce,shimSenderReceiverGetStats:()=>Ee});var t={};i.r(t),i.d(t,{shimAddTransceiver:()=>Le,shimCreateAnswer:()=>Fe,shimCreateOffer:()=>Ue,shimGetDisplayMedia:()=>Ae,shimGetParameters:()=>xe,shimGetUserMedia:()=>_e,shimOnTrack:()=>we,shimPeerConnection:()=>Ie,shimRTCDataChannel:()=>Me,shimReceiverGetStats:()=>Oe,shimRemoveStream:()=>Ne,shimSenderGetStats:()=>De});var r={};i.r(r),i.d(r,{shimAudioContext:()=>Je,shimCallbacksAPI:()=>Ve,shimConstraints:()=>Ke,shimCreateOfferLegacy:()=>We,shimGetUserMedia:()=>je,shimLocalStreamsAPI:()=>Ge,shimRTCIceServerUrls:()=>$e,shimRemoteStreamsAPI:()=>Be,shimTrackEventTransceiver:()=>He});var n={};function s(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];throw Error("[Immer] minified error nr: "+e+(i.length?" "+i.map((function(e){return"'"+e+"'"})).join(","):"")+". Find the full error at: https://bit.ly/3cXEKWf")}function a(e){return!!e&&!!e[H]}function o(e){return!!e&&(function(e){if(!e||"object"!=typeof e)return!1;var t=Object.getPrototypeOf(e);if(null===t)return!0;var i=Object.hasOwnProperty.call(t,"constructor")&&t.constructor;return i===Object||"function"==typeof i&&Function.toString.call(i)===W}(e)||Array.isArray(e)||!!e[$]||!!e.constructor[$]||h(e)||p(e))}function l(e,t,i){void 0===i&&(i=!1),0===c(e)?(i?Object.keys:J)(e).forEach((function(r){i&&"symbol"==typeof r||t(r,e[r],e)})):e.forEach((function(i,r){return t(r,i,e)}))}function c(e){var t=e[H];return t?t.i>3?t.i-4:t.i:Array.isArray(e)?1:h(e)?2:p(e)?3:0}function d(e,t){return 2===c(e)?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function u(e,t,i){var r=c(e);2===r?e.set(t,i):3===r?(e.delete(t),e.add(i)):e[t]=i}function h(e){return B&&e instanceof Map}function p(e){return V&&e instanceof Set}function v(e){return e.o||e.t}function m(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=q(e);delete t[H];for(var i=J(t),r=0;r<i.length;r++){var n=i[r],s=t[n];!1===s.writable&&(s.writable=!0,s.configurable=!0),(s.get||s.set)&&(t[n]={configurable:!0,writable:!0,enumerable:s.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function g(e,t){return void 0===t&&(t=!1),y(e)||a(e)||!o(e)||(c(e)>1&&(e.set=e.add=e.clear=e.delete=f),Object.freeze(e),t&&l(e,(function(e,t){return g(t,!0)}),!0)),e}function f(){s(2)}function y(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}function T(e){var t=z[e];return t||s(18,e),t}function S(){return F}function k(e,t){t&&(T("Patches"),e.u=[],e.s=[],e.v=t)}function E(e){b(e),e.p.forEach(C),e.p=null}function b(e){e===F&&(F=e.l)}function R(e){return F={p:[],l:F,h:e,m:!0,_:0}}function C(e){var t=e[H];0===t.i||1===t.i?t.j():t.O=!0}function P(e,t){t._=t.p.length;var i=t.p[0],r=void 0!==e&&e!==i;return t.h.g||T("ES5").S(t,e,r),r?(i[H].P&&(E(t),s(4)),o(e)&&(e=_(t,e),t.l||w(t,e)),t.u&&T("Patches").M(i[H].t,e,t.u,t.s)):e=_(t,i,[]),E(t),t.u&&t.v(t.u,t.s),e!==K?e:void 0}function _(e,t,i){if(y(t))return t;var r=t[H];if(!r)return l(t,(function(n,s){return A(e,r,t,n,s,i)}),!0),t;if(r.A!==e)return t;if(!r.P)return w(e,r.t,!0),r.t;if(!r.I){r.I=!0,r.A._--;var n=4===r.i||5===r.i?r.o=m(r.k):r.o;l(3===r.i?new Set(n):n,(function(t,s){return A(e,r,n,t,s,i)})),w(e,n,!1),i&&e.u&&T("Patches").R(r,i,e.u,e.s)}return r.o}function A(e,t,i,r,n,s){if(a(n)){var l=_(e,n,s&&t&&3!==t.i&&!d(t.D,r)?s.concat(r):void 0);if(u(i,r,l),!a(l))return;e.m=!1}if(o(n)&&!y(n)){if(!e.h.F&&e._<1)return;_(e,n),t&&t.A.l||w(e,n)}}function w(e,t,i){void 0===i&&(i=!1),e.h.F&&e.m&&g(t,i)}function I(e,t){var i=e[H];return(i?v(i):e)[t]}function D(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var r=Object.getOwnPropertyDescriptor(i,t);if(r)return r;i=Object.getPrototypeOf(i)}}function O(e){e.P||(e.P=!0,e.l&&O(e.l))}function N(e){e.o||(e.o=m(e.t))}function M(e,t,i){var r=h(t)?T("MapSet").N(t,i):p(t)?T("MapSet").T(t,i):e.g?function(e,t){var i=Array.isArray(e),r={i:i?1:0,A:t?t.A:S(),P:!1,I:!1,D:{},l:t,t:e,k:null,o:null,j:null,C:!1},n=r,s=Q;i&&(n=[r],s=Y);var a=Proxy.revocable(n,s),o=a.revoke,l=a.proxy;return r.k=l,r.j=o,l}(t,i):T("ES5").J(t,i);return(i?i.A:S()).p.push(r),r}function L(e){return a(e)||s(22,e),function e(t){if(!o(t))return t;var i,r=t[H],n=c(t);if(r){if(!r.P&&(r.i<4||!T("ES5").K(r)))return r.t;r.I=!0,i=x(t,n),r.I=!1}else i=x(t,n);return l(i,(function(t,n){r&&function(e,t){return 2===c(e)?e.get(t):e[t]}(r.t,t)===n||u(i,t,e(n))})),3===n?new Set(i):i}(e)}function x(e,t){switch(t){case 2:return new Map(e);case 3:return Array.from(e)}return m(e)}i.r(n),i.d(n,{removeExtmapAllowMixed:()=>et,shimAddIceCandidateNullOrEmpty:()=>tt,shimConnectionState:()=>Xe,shimMaxMessageSize:()=>Ye,shimParameterlessSetLocalDescription:()=>it,shimRTCIceCandidate:()=>Qe,shimSendThrowTypeError:()=>Ze});var U,F,G="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),B="undefined"!=typeof Map,V="undefined"!=typeof Set,j="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,K=G?Symbol.for("immer-nothing"):((U={})["immer-nothing"]=!0,U),$=G?Symbol.for("immer-draftable"):"__$immer_draftable",H=G?Symbol.for("immer-state"):"__$immer_state",W=("undefined"!=typeof Symbol&&Symbol.iterator,""+Object.prototype.constructor),J="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,q=Object.getOwnPropertyDescriptors||function(e){var t={};return J(e).forEach((function(i){t[i]=Object.getOwnPropertyDescriptor(e,i)})),t},z={},Q={get:function(e,t){if(t===H)return e;var i=v(e);if(!d(i,t))return function(e,t,i){var r,n=D(t,i);return n?"value"in n?n.value:null===(r=n.get)||void 0===r?void 0:r.call(e.k):void 0}(e,i,t);var r=i[t];return e.I||!o(r)?r:r===I(e.t,t)?(N(e),e.o[t]=M(e.A.h,r,e)):r},has:function(e,t){return t in v(e)},ownKeys:function(e){return Reflect.ownKeys(v(e))},set:function(e,t,i){var r=D(v(e),t);if(null==r?void 0:r.set)return r.set.call(e.k,i),!0;if(!e.P){var n=I(v(e),t),s=null==n?void 0:n[H];if(s&&s.t===i)return e.o[t]=i,e.D[t]=!1,!0;if(function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}(i,n)&&(void 0!==i||d(e.t,t)))return!0;N(e),O(e)}return e.o[t]===i&&"number"!=typeof i&&(void 0!==i||t in e.o)||(e.o[t]=i,e.D[t]=!0,!0)},deleteProperty:function(e,t){return void 0!==I(e.t,t)||t in e.t?(e.D[t]=!1,N(e),O(e)):delete e.D[t],e.o&&delete e.o[t],!0},getOwnPropertyDescriptor:function(e,t){var i=v(e),r=Reflect.getOwnPropertyDescriptor(i,t);return r?{writable:!0,configurable:1!==e.i||"length"!==t,enumerable:r.enumerable,value:i[t]}:r},defineProperty:function(){s(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.t)},setPrototypeOf:function(){s(12)}},Y={};l(Q,(function(e,t){Y[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}})),Y.deleteProperty=function(e,t){return Y.set.call(this,e,t,void 0)},Y.set=function(e,t,i){return Q.set.call(this,e[0],t,i,e[0])};var Z=function(){function e(e){var t=this;this.g=j,this.F=!0,this.produce=function(e,i,r){if("function"==typeof e&&"function"!=typeof i){var n=i;i=e;var a=t;return function(e){var t=this;void 0===e&&(e=n);for(var r=arguments.length,s=Array(r>1?r-1:0),o=1;o<r;o++)s[o-1]=arguments[o];return a.produce(e,(function(e){var r;return(r=i).call.apply(r,[t,e].concat(s))}))}}var l;if("function"!=typeof i&&s(6),void 0!==r&&"function"!=typeof r&&s(7),o(e)){var c=R(t),d=M(t,e,void 0),u=!0;try{l=i(d),u=!1}finally{u?E(c):b(c)}return"undefined"!=typeof Promise&&l instanceof Promise?l.then((function(e){return k(c,r),P(e,c)}),(function(e){throw E(c),e})):(k(c,r),P(l,c))}if(!e||"object"!=typeof e){if(void 0===(l=i(e))&&(l=e),l===K&&(l=void 0),t.F&&g(l,!0),r){var h=[],p=[];T("Patches").M(e,l,h,p),r(h,p)}return l}s(21,e)},this.produceWithPatches=function(e,i){if("function"==typeof e)return function(i){for(var r=arguments.length,n=Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];return t.produceWithPatches(i,(function(t){return e.apply(void 0,[t].concat(n))}))};var r,n,s=t.produce(e,i,(function(e,t){r=e,n=t}));return"undefined"!=typeof Promise&&s instanceof Promise?s.then((function(e){return[e,r,n]})):[s,r,n]},"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze)}var t=e.prototype;return t.createDraft=function(e){o(e)||s(8),a(e)&&(e=L(e));var t=R(this),i=M(this,e,void 0);return i[H].C=!0,b(t),i},t.finishDraft=function(e,t){var i=(e&&e[H]).A;return k(i,t),P(void 0,i)},t.setAutoFreeze=function(e){this.F=e},t.setUseProxies=function(e){e&&!j&&s(20),this.g=e},t.applyPatches=function(e,t){var i;for(i=t.length-1;i>=0;i--){var r=t[i];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}i>-1&&(t=t.slice(i+1));var n=T("Patches").$;return a(e)?n(e,t):this.produce(e,(function(e){return n(e,t)}))},e}(),X=new Z,ee=X.produce;X.produceWithPatches.bind(X),X.setAutoFreeze.bind(X),X.setUseProxies.bind(X),X.applyPatches.bind(X),X.createDraft.bind(X),X.finishDraft.bind(X);const te=ee,ie=function(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;const i=Object.keys(e);if(i.length!==Object.keys(t).length)return!1;for(let r=0;r<i.length;r++)if(!Object.prototype.hasOwnProperty.call(t,i[r])||!Object.is(e[i[r]],t[i[r]]))return!1;return!0};let re=!0,ne=!0;function se(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function ae(e,t,i){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return n.apply(this,arguments);const s=e=>{const t=i(e);t&&(r.handleEvent?r.handleEvent(t):r(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,s),n.apply(this,[e,s])};const s=r.removeEventListener;r.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return s.apply(this,arguments);if(!this._eventMap[t].has(i))return s.apply(this,arguments);const r=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,s.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function oe(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(re=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function le(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(ne=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function ce(){if("object"==typeof window){if(re)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function de(e,t){ne&&console.warn(e+" is deprecated, please use "+t+" instead.")}function ue(e){return"[object Object]"===Object.prototype.toString.call(e)}function he(e){return ue(e)?Object.keys(e).reduce((function(t,i){const r=ue(e[i]),n=r?he(e[i]):e[i],s=r&&!Object.keys(n).length;return void 0===n||s?t:Object.assign(t,{[i]:n})}),{}):e}function pe(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?pe(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach((t=>{pe(e,e.get(t),i)}))})))}function ve(e,t,i){const r=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const s=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&s.push(e)})),s.forEach((t=>{e.forEach((i=>{i.type===r&&i.trackId===t.id&&pe(e,i,n)}))})),n}const me=ce;function ge(e,t){const i=e&&e.navigator;if(!i.mediaDevices)return;const r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const r="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[n("min",i)]=r.ideal,t.optional.push(e),e={},e[n("max",i)]=r.ideal,t.optional.push(e)):(e[n("",i)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=r[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const a=t.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?t=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(t=["front"]),t)return i.mediaDevices.enumerateDevices().then((i=>{i=i.filter((e=>"videoinput"===e.kind));let a=i.find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!a&&i.length&&t.includes("back")&&(a=i[i.length-1]),a&&(e.video.deviceId=s.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=r(e.video),me("chrome: "+JSON.stringify(e)),n(e)}))}e.video=r(e.video)}return me("chrome: "+JSON.stringify(e)),n(e)},s=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=function(e,t,r){n(e,(e=>{i.webkitGetUserMedia(e,t,(e=>{r&&r(s(e))}))}))}.bind(i),i.mediaDevices.getUserMedia){const e=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(s(e))))))}}}function fe(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const r=i.video&&i.video.width,n=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:s||3}},r&&(i.video.mandatory.maxWidth=r),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function ye(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Te(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else ae(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Se(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function ke(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},s=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){i(s(n(e)))};return t.apply(this,[r,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(s(n(t)))},i])})).then(i,r)}}function Ee(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ve(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),ae(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>ve(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,r;return this.getSenders().forEach((i=>{i.track===e&&(t?r=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?r=!0:i=t),t.track===e))),r||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function be(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(r)&&this._shimmedLocalStreams[i.id].push(r):this._shimmedLocalStreams[i.id]=[i,r],r};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function Re(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return be(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{const t=this.getSenders().find((t=>t.track===e));if(t)throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}r.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}function a(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const s=this._streams[i.id];if(s)s.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const r=new e.MediaStream([t]);this._streams[i.id]=r,this._reverseStreams[r.id]=i,this.addStream(r)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=s(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=a(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const l=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=l.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Ce(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}))}function Pe(e,t){ae(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}function _e(e,t){const i=e&&e.navigator,r=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,r){de("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function Ae(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}function we(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ie(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}));const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,s]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(n,s)}}function De(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Oe(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),ae(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Ne(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){de("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Me(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Le(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:t}=r,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return r})}function xe(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Ue(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Fe(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Ge(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function Be(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function Ve(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,s=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,i){const r=n.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r};t.setLocalDescription=o,o=function(e,t,i){const r=s.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.setRemoteDescription=o,o=function(e,t,i){const r=a.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.addIceCandidate=o}function je(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(Ke(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,r){t.mediaDevices.getUserMedia(e).then(i,r)}.bind(t))}function Ke(e){return e&&void 0!==e.video?Object.assign({},e,{video:he(e.video)}):e}function $e(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let r=e.iceServers[i];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")?(de("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function He(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function We(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Je(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var qe=i(539),ze=i.n(qe);function Qe(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),r=ze().parseCandidate(e.candidate),n=Object.assign(i,r);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,ae(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function Ye(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=ze().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=ze().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},r=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},n=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},s=function(e,i){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const n=ze().matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?r=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(r=2147483637),r},a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=r(arguments[0]),t=n(e),i=s(arguments[0],e);let a;a=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>a}),this._sctp=o}return a.apply(this,arguments)}}function Ze(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const r=arguments[0],n=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},ae(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function Xe(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function et(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const i=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:i}):t.sdp=i}return i.apply(this,arguments)}}function tt(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.addIceCandidate;i&&0!==i.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function it(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const i=e.RTCPeerConnection.prototype.setLocalDescription;i&&0!==i.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return i.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return i.apply(this,[e]);const t="offer"===e.type?this.createOffer:this.createAnswer;return t.apply(this).then((e=>i.apply(this,[e])))})}const rt=function({window:i}={},s={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const a=ce,o=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=se(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=se(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=se(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(i),l={browserDetails:o,commonShim:n,extractVersion:se,disableLog:oe,disableWarnings:le,sdp:qe};switch(o.browser){case"chrome":if(!e||!Ce||!s.shimChrome)return a("Chrome shim is not included in this adapter release."),l;if(null===o.version)return a("Chrome shim can not determine version, not shimming."),l;a("adapter.js shimming chrome."),l.browserShim=e,tt(i,o),it(i),ge(i,o),ye(i),Ce(i,o),Te(i),Re(i,o),Se(i),ke(i),Ee(i),Pe(i,o),Qe(i),Xe(i),Ye(i,o),Ze(i),et(i,o);break;case"firefox":if(!t||!Ie||!s.shimFirefox)return a("Firefox shim is not included in this adapter release."),l;a("adapter.js shimming firefox."),l.browserShim=t,tt(i,o),it(i),_e(i,o),Ie(i,o),we(i),Ne(i),De(i),Oe(i),Me(i),Le(i),xe(i),Ue(i),Fe(i),Qe(i),Xe(i),Ye(i,o),Ze(i);break;case"safari":if(!r||!s.shimSafari)return a("Safari shim is not included in this adapter release."),l;a("adapter.js shimming safari."),l.browserShim=r,tt(i,o),it(i),$e(i),We(i),Ve(i),Ge(i),Be(i),He(i),je(i),Je(i),Qe(i),Ye(i,o),Ze(i),et(i,o);break;default:a("Unsupported browser!")}return l}({window:"undefined"==typeof window?void 0:window}),nt=rt;var st,at=i(766),ot=i(238),lt=new Uint8Array(16);function ct(){if(!st&&!(st="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return st(lt)}const dt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,ut=function(e){return"string"==typeof e&&dt.test(e)};for(var ht=[],pt=0;pt<256;++pt)ht.push((pt+256).toString(16).substr(1));const vt=function(e,t,i){var r=(e=e||{}).random||(e.rng||ct)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(var n=0;n<16;++n)t[i+n]=r[n];return t}return function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=(ht[e[t+0]]+ht[e[t+1]]+ht[e[t+2]]+ht[e[t+3]]+"-"+ht[e[t+4]]+ht[e[t+5]]+"-"+ht[e[t+6]]+ht[e[t+7]]+"-"+ht[e[t+8]]+ht[e[t+9]]+"-"+ht[e[t+10]]+ht[e[t+11]]+ht[e[t+12]]+ht[e[t+13]]+ht[e[t+14]]+ht[e[t+15]]).toLowerCase();if(!ut(i))throw TypeError("Stringified UUID is invalid");return i}(r)};var mt,gt=i(387),ft=Object.defineProperty,yt=Object.defineProperties,Tt=Object.getOwnPropertyDescriptors,St=Object.getOwnPropertySymbols,kt=Object.prototype.hasOwnProperty,Et=Object.prototype.propertyIsEnumerable,bt=(e,t,i)=>t in e?ft(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,Rt=(e,t)=>{for(var i in t||(t={}))kt.call(t,i)&&bt(e,i,t[i]);if(St)for(var i of St(t))Et.call(t,i)&&bt(e,i,t[i]);return e},Ct=(e,t)=>yt(e,Tt(t)),Pt=(e,t)=>{var i={};for(var r in e)kt.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(null!=e&&St)for(var r of St(e))t.indexOf(r)<0&&Et.call(e,r)&&(i[r]=e[r]);return i},_t=(e,t,i)=>new Promise(((r,n)=>{var s=e=>{try{o(i.next(e))}catch(e){n(e)}},a=e=>{try{o(i.throw(e))}catch(e){n(e)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,a);o((i=i.apply(e,t)).next())}));!function(e){e[e.VERBOSE=0]="VERBOSE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.TIME=4]="TIME",e[e.TIMEEND=5]="TIMEEND",e[e.ERROR=6]="ERROR",e[e.NONE=7]="NONE"}(mt||(mt={}));var At,wt,It,Dt,Ot,Nt,Mt="undefined"!=typeof window&&void 0!==window.expect,Lt=class{static v(e,...t){this.log(0,e,...t)}static d(e,...t){this.log(1,e,...t)}static i(e,...t){this.log(2,e,...t)}static w(e,...t){this.log(3,e,...t)}static e(e,...t){this.log(6,e,...t)}static time(e){this.log(4,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(5,"[HMSPerformanceTiming]",e,e)}static cleanUp(){performance.clearMarks(),performance.clearMeasures()}static log(e,t,...i){if(!(this.level.valueOf()>e.valueOf()))switch(e){case 0:console.log(t,...i);break;case 1:console.debug(t,...i);break;case 2:console.info(t,...i);break;case 3:console.warn(t,...i);break;case 6:console.error(t,...i);break;case 4:performance.mark(i[0]);break;case 5:{let e=i[0];try{let i=performance.measure(e,e);this.log(1,t,e,null==i?void 0:i.duration),performance.clearMarks(e),performance.clearMeasures(e)}catch(i){this.log(1,t,e,i)}break}}}};Lt.level=Mt?7:0,function(e){e[e.PEER_ADDED=0]="PEER_ADDED",e[e.PEER_REMOVED=1]="PEER_REMOVED",e[e.PEER_KNOCKED=2]="PEER_KNOCKED",e[e.ROOM_TYPE_CHANGED=3]="ROOM_TYPE_CHANGED",e[e.METADATA_UPDATED=4]="METADATA_UPDATED",e[e.SCREENSHARE_STARTED=5]="SCREENSHARE_STARTED",e[e.SCREENSHARE_STOPPED=6]="SCREENSHARE_STOPPED",e[e.DEFAULT_UPDATE=7]="DEFAULT_UPDATE",e[e.RECORDING_STATE_UPDATED=8]="RECORDING_STATE_UPDATED",e[e.BROWSER_RECORDING_STATE_UPDATED=9]="BROWSER_RECORDING_STATE_UPDATED",e[e.SERVER_RECORDING_STATE_UPDATED=10]="SERVER_RECORDING_STATE_UPDATED",e[e.RTMP_STREAMING_STATE_UPDATED=11]="RTMP_STREAMING_STATE_UPDATED",e[e.HLS_STREAMING_STATE_UPDATED=12]="HLS_STREAMING_STATE_UPDATED",e[e.ROOM_STATE=13]="ROOM_STATE"}(At||(At={})),function(e){e[e.PEER_JOINED=0]="PEER_JOINED",e[e.PEER_LEFT=1]="PEER_LEFT",e[e.AUDIO_TOGGLED=2]="AUDIO_TOGGLED",e[e.VIDEO_TOGGLED=3]="VIDEO_TOGGLED",e[e.BECAME_DOMINANT_SPEAKER=4]="BECAME_DOMINANT_SPEAKER",e[e.RESIGNED_DOMINANT_SPEAKER=5]="RESIGNED_DOMINANT_SPEAKER",e[e.STARTED_SPEAKING=6]="STARTED_SPEAKING",e[e.STOPPED_SPEAKING=7]="STOPPED_SPEAKING",e[e.ROLE_UPDATED=8]="ROLE_UPDATED",e[e.PEER_LIST=9]="PEER_LIST",e[e.NAME_UPDATED=10]="NAME_UPDATED",e[e.METADATA_UPDATED=11]="METADATA_UPDATED"}(wt||(wt={})),function(e){e[e.TRACK_ADDED=0]="TRACK_ADDED",e[e.TRACK_REMOVED=1]="TRACK_REMOVED",e[e.TRACK_MUTED=2]="TRACK_MUTED",e[e.TRACK_UNMUTED=3]="TRACK_UNMUTED",e[e.TRACK_DESCRIPTION_CHANGED=4]="TRACK_DESCRIPTION_CHANGED",e[e.TRACK_DEGRADED=5]="TRACK_DEGRADED",e[e.TRACK_RESTORED=6]="TRACK_RESTORED"}(It||(It={})),(Nt=Dt||(Dt={}))[Nt.DEFAULT=0]="DEFAULT",function(e){e.NONE="none",e.LOW="low",e.MEDIUM="medium",e.HIGH="high"}(Ot||(Ot={}));var xt,Ut,Ft,Gt,Bt={f:Ot.HIGH,h:Ot.MEDIUM,q:Ot.LOW};!function(e){e.VP8="vp8",e.VP9="vp9",e.H264="h264"}(xt||(xt={})),function(e){e.OPUS="opus"}(Ut||(Ut={})),function(e){e.audio="audio",e.video="video"}(Ft||(Ft={})),function(e){e[e.Publish=0]="Publish",e[e.Subscribe=1]="Subscribe"}(Gt||(Gt={}));var Vt,jt,Kt={WebSocketConnectionErrors:{FAILED_TO_CONNECT:1e3,WEBSOCKET_CONNECTION_LOST:1003},InitAPIErrors:{SERVER_ERRORS:2e3,INIT_CONFIG_NOT_AVAILABLE:2002,ENDPOINT_UNREACHABLE:2003,INVALID_TOKEN_FORMAT:2004},TracksErrors:{GENERIC_TRACK:3e3,CANT_ACCESS_CAPTURE_DEVICE:3001,DEVICE_NOT_AVAILABLE:3002,DEVICE_IN_USE:3003,DEVICE_LOST_MIDWAY:3008,NOTHING_TO_RETURN:3005,INVALID_VIDEO_SETTINGS:3006,CODEC_CHANGE_NOT_PERMITTED:3007,AUTOPLAY_ERROR:3008,OVER_CONSTRAINED:3009,NO_AUDIO_DETECTED:3010,SYSTEM_DENIED_PERMISSION:3011},WebrtcErrors:{CREATE_OFFER_FAILED:4001,CREATE_ANSWER_FAILED:4002,SET_LOCAL_DESCRIPTION_FAILED:4003,SET_REMOTE_DESCRIPTION_FAILED:4004,ICE_FAILURE:4005},WebsocketMethodErrors:{SERVER_ERRORS:5e3,ALREADY_JOINED:5001,CANNOT_JOIN_PREVIEW_IN_PROGRESS:5002},GenericErrors:{NOT_CONNECTED:6e3,SIGNALLING:6001,UNKNOWN:6002,NOT_READY:6003,JSON_PARSING_FAILED:6004,TRACK_METADATA_MISSING:6005,RTC_TRACK_MISSING:6006,PEER_METADATA_MISSING:6007,INVALID_ROLE:6008,PREVIEW_IN_PROGRESS:6009,MISSING_MEDIADEVICES:6010,MISSING_RTCPEERCONNECTION:6011},PlaylistErrors:{NO_ENTRY_TO_PLAY:8001,NO_ENTRY_IS_PLAYING:8002}},$t=class extends Error{constructor(e,t,i,r,n,s=!1){super(r),this.code=e,this.name=t,this.message=r,this.description=n,this.isTerminal=s,Object.setPrototypeOf(this,$t.prototype),this.action=i.toString()}toAnalyticsProperties(){return{error_name:this.name,error_code:this.code,error_message:this.message,error_description:this.description,action:this.action,is_terminal:this.isTerminal}}addNativeError(e){this.nativeError=e}};(jt=Vt||(Vt={})).NONE="NONE",jt.TRACK="TRACK",jt.INIT="INIT",jt.PUBLISH="PUBLISH",jt.UNPUBLISH="UNPUBLISH",jt.JOIN="JOIN",jt.SUBSCRIBE="SUBSCRIBE",jt.DATA_CHANNEL_SEND="DATA_CHANNEL_SEND",jt.RESTART_ICE="RESTART_ICE",jt.VIDEO_PLUGINS="VIDEO_PLUGINS",jt.AUDIO_PLUGINS="AUDIO_PLUGINS",jt.AUTOPLAY="AUTOPLAY",jt.RECONNECT_SIGNAL="RECONNECT_SIGNAL",jt.VALIDATION="VALIDATION",jt.PLAYLIST="PLAYLIST",jt.PREVIEW="PREVIEW";var Ht={FailedToConnect:(e,t="")=>new $t(Kt.WebSocketConnectionErrors.FAILED_TO_CONNECT,"WebsocketFailedToConnect",e,`[WS]: ${t}`,`[WS]: ${t}`),WebSocketConnectionLost:(e,t="")=>new $t(Kt.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,"WebSocketConnectionLost",e,"Network connection lost ",t)},Wt={ServerErrors:(e,t,i="")=>new $t(e,"ServerErrors",t,"[INIT]: Server error",i,!0),EndpointUnreachable:(e,t="")=>new $t(Kt.InitAPIErrors.ENDPOINT_UNREACHABLE,"EndpointUnreachable",e,"Endpoint is not reachable.",t),InvalidTokenFormat:(e,t="")=>new $t(Kt.InitAPIErrors.INVALID_TOKEN_FORMAT,"InvalidTokenFormat",e,`Token is not in proper JWT format - ${t}`,t,!0),InitConfigNotAvailable:(e,t="")=>new $t(Kt.InitAPIErrors.INIT_CONFIG_NOT_AVAILABLE,"InitError",e,`[INIT]: ${t}`,`[INIT]: ${t}`)},Jt={GenericTrack:(e,t="")=>new $t(Kt.TracksErrors.GENERIC_TRACK,"GenericTrack",e,`[TRACK]: ${t}`,`[TRACK]: ${t}`),CantAccessCaptureDevice:(e,t,i="")=>new $t(Kt.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,"CantAccessCaptureDevice",e,`User denied permission to access capture device - ${t}`,i),DeviceNotAvailable:(e,t,i="")=>new $t(Kt.TracksErrors.DEVICE_NOT_AVAILABLE,"DeviceNotAvailable",e,`[TRACK]: Capture device is no longer available - ${t}`,i),DeviceInUse:(e,t,i="")=>new $t(Kt.TracksErrors.DEVICE_IN_USE,"DeviceInUse",e,`[TRACK]: Capture device is in use by another application - ${t}`,i),DeviceLostMidway:(e,t,i="")=>new $t(Kt.TracksErrors.DEVICE_LOST_MIDWAY,"DeviceLostMidway",e,`Lost access to capture device midway - ${t}`,i),NothingToReturn:(e,t="")=>new $t(Kt.TracksErrors.NOTHING_TO_RETURN,"NothingToReturn",e,"There is no media to return. Please select either video or audio or both.",t),InvalidVideoSettings:(e,t="")=>new $t(Kt.TracksErrors.INVALID_VIDEO_SETTINGS,"InvalidVideoSettings",e,"Cannot enable simulcast when no video settings are provided",t),AutoplayBlocked:(e,t="")=>new $t(Kt.TracksErrors.AUTOPLAY_ERROR,"AutoplayBlocked",e,"Autoplay blocked because the user didn't interact with the document first",t),CodecChangeNotPermitted:(e,t="")=>new $t(Kt.TracksErrors.CODEC_CHANGE_NOT_PERMITTED,"CodecChangeNotPermitted",e,"Codec can't be changed mid call.",t),OverConstrained:(e,t,i="")=>new $t(Kt.TracksErrors.OVER_CONSTRAINED,"OverConstrained",e,`[TRACK]: Requested constraints cannot be satisfied with the device hardware - ${t}`,i),NoAudioDetected:(e,t="Please check the mic or use another audio input")=>new $t(Kt.TracksErrors.NO_AUDIO_DETECTED,"NoAudioDetected",e,"No audio input detected from microphone",t),SystemDeniedPermission:(e,t,i="")=>new $t(Kt.TracksErrors.SYSTEM_DENIED_PERMISSION,"SystemDeniedPermission",e,`Operating System denied permission to access capture device - ${t}`,i)},qt={CreateOfferFailed:(e,t="")=>new $t(Kt.WebrtcErrors.CREATE_OFFER_FAILED,"CreateOfferFailed",e,`[${e.toString()}]: Failed to create offer. `,t),CreateAnswerFailed:(e,t="")=>new $t(Kt.WebrtcErrors.CREATE_ANSWER_FAILED,"CreateAnswerFailed",e,`[${e.toString()}]: Failed to create answer. `,t),SetLocalDescriptionFailed:(e,t="")=>new $t(Kt.WebrtcErrors.SET_LOCAL_DESCRIPTION_FAILED,"SetLocalDescriptionFailed",e,`[${e.toString()}]: Failed to set offer. `,t),SetRemoteDescriptionFailed:(e,t="")=>new $t(Kt.WebrtcErrors.SET_REMOTE_DESCRIPTION_FAILED,"SetRemoteDescriptionFailed",e,`[${e.toString()}]: Failed to set answer. `,t),ICEFailure:(e,t="")=>new $t(Kt.WebrtcErrors.ICE_FAILURE,"ICEFailure",e,`[${e.toString()}]: Ice connection state FAILED`,t)},zt={ServerErrors:(e,t,i)=>new $t(e,"ServerErrors",t,i,i,!0),AlreadyJoined:(e,t="")=>new $t(Kt.WebsocketMethodErrors.ALREADY_JOINED,"AlreadyJoined",e,"[JOIN]: You have already joined this room.",t),CannotJoinPreviewInProgress:(e,t="")=>new $t(Kt.WebsocketMethodErrors.CANNOT_JOIN_PREVIEW_IN_PROGRESS,"CannotJoinPreviewInProgress",e,"[JOIN]: Cannot join if preview is in progress",t)},Qt={NotConnected:(e,t="")=>new $t(Kt.GenericErrors.NOT_CONNECTED,"NotConnected",e,"Client is not connected",t),Signalling:(e,t)=>new $t(Kt.GenericErrors.SIGNALLING,"Signalling",e,`Unknown signalling error: ${e.toString()} ${t} `,t),Unknown:(e,t)=>new $t(Kt.GenericErrors.UNKNOWN,"Unknown",e,`Unknown exception: ${t}`,t),NotReady:(e,t="")=>new $t(Kt.GenericErrors.NOT_READY,"NotReady",e,t,t),JsonParsingFailed:(e,t,i="")=>new $t(Kt.GenericErrors.JSON_PARSING_FAILED,"JsonParsingFailed",e,`Failed to parse JSON message - ${t}`,i),TrackMetadataMissing:(e,t="")=>new $t(Kt.GenericErrors.TRACK_METADATA_MISSING,"TrackMetadataMissing",e,"Track Metadata Missing",t),RTCTrackMissing:(e,t="")=>new $t(Kt.GenericErrors.RTC_TRACK_MISSING,"RTCTrackMissing",e,"RTC Track missing",t),PeerMetadataMissing:(e,t="")=>new $t(Kt.GenericErrors.PEER_METADATA_MISSING,"PeerMetadataMissing",e,"Peer Metadata Missing",t),ValidationFailed:(e,t)=>new $t(Kt.GenericErrors.INVALID_ROLE,"ValidationFailed",Vt.VALIDATION,e,t?JSON.stringify(t):""),InvalidRole:(e,t)=>new $t(Kt.GenericErrors.INVALID_ROLE,"InvalidRole",e,"Invalid role. Join with valid role",t,!0),PreviewAlreadyInProgress:(e,t="")=>new $t(Kt.GenericErrors.PREVIEW_IN_PROGRESS,"PreviewAlreadyInProgress",e,"[Preview]: Cannot join if preview is in progress",t),MissingMediaDevices:()=>new $t(Kt.GenericErrors.MISSING_MEDIADEVICES,"MissingMediaDevices",Vt.JOIN,"navigator.mediaDevices is undefined. 100ms SDK won't work on this website as WebRTC is not supported on HTTP endpoints(missing navigator.mediaDevices). Please ensure you're using the SDK either on localhost or a valid HTTPS endpoint.","",!0),MissingRTCPeerConnection:()=>new $t(Kt.GenericErrors.MISSING_RTCPEERCONNECTION,"MissingRTCPeerConnection",Vt.JOIN,"RTCPeerConnection which is a core requirement for WebRTC call was not found, this could be due to an unsupported browser or browser extensions blocking WebRTC","",!0)},Yt={PlatformNotSupported:(e,t="")=>new $t(7001,"PlatformNotSupported",e,"Check HMS Docs to see the list of supported platforms",t),InitFailed:(e,t="")=>new $t(7002,"InitFailed",e,"Plugin init failed",t),ProcessingFailed:(e,t="")=>new $t(7003,"ProcessingFailed",e,"Plugin processing failed",t),AddAlreadyInProgress:(e,t="")=>new $t(7004,"AddAlreadyInProgress",e,"Plugin add already in progress",t),DeviceNotSupported:(e,t="")=>new $t(7005,"DeviceNotSupported",e,"Check HMS Docs to see the list of supported devices",t)},Zt={NoEntryToPlay:(e,t)=>new $t(Kt.PlaylistErrors.NO_ENTRY_TO_PLAY,"NoEntryToPlay",e,"Reached end of playlist",t),NoEntryPlaying:(e,t)=>new $t(Kt.PlaylistErrors.NO_ENTRY_IS_PLAYING,"NoEntryIsPlaying",e,"No entry is playing at this time",t)},Xt="VALIDATIONS";function ei(e){return null!=e}var ti,ii=()=>{if(!ei(RTCPeerConnection)){let e=Qt.MissingRTCPeerConnection();throw Lt.e(Xt,e),e}},ri=()=>{if(!ei(navigator.mediaDevices)){let e=Qt.MissingMediaDevices();throw Lt.e(Xt,e),e}},ni="HMSConnection",si=class{constructor(e,t){this.candidates=new Array,this.role=e,this.signal=t}get iceConnectionState(){return this.nativeConnection.iceConnectionState}get connectionState(){return this.nativeConnection.connectionState}get action(){return this.role===Gt.Publish?Vt.PUBLISH:Vt.SUBSCRIBE}addTransceiver(e,t){return this.nativeConnection.addTransceiver(e,t)}createOffer(e,t){return _t(this,null,(function*(){try{let i=yield this.nativeConnection.createOffer(t);return Lt.d(ni,`[role=${this.role}] createOffer offer=${JSON.stringify(i,null,1)}`),function(e){return e.sdp.includes("usedtx=1")?e:{type:e.type,sdp:e.sdp.replace("useinbandfec=1","useinbandfec=1;usedtx=1")}}(function(e,t){var i;let r=(0,at.Qc)(e.sdp);if(!(null==(i=r.origin)?void 0:i.username.startsWith("mozilla")))return e;let n=t?Array.from(t.values()):[];return r.media.forEach((e=>{var t,i,r;let s=null==(t=e.msid)?void 0:t.split(" ")[0],a=null==(i=n.find((t=>t.type===e.type&&t.stream_id===s)))?void 0:i.track_id;a&&(e.msid=null==(r=e.msid)?void 0:r.replace(/\s(.+)/,` ${a}`))})),{type:e.type,sdp:(0,at.cW)(r)}}(i,e))}catch(e){throw qt.CreateOfferFailed(this.action,e.message)}}))}createAnswer(e){return _t(this,null,(function*(){try{let t=yield this.nativeConnection.createAnswer(e);return Lt.d(ni,`[role=${this.role}] createAnswer answer=${JSON.stringify(t,null,1)}`),t}catch(e){throw qt.CreateAnswerFailed(this.action,e.message)}}))}setLocalDescription(e){return _t(this,null,(function*(){try{Lt.d(ni,`[role=${this.role}] setLocalDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setLocalDescription(e)}catch(e){throw qt.SetLocalDescriptionFailed(this.action,e.message)}}))}setRemoteDescription(e){return _t(this,null,(function*(){try{Lt.d(ni,`[role=${this.role}] setRemoteDescription description=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.setRemoteDescription(e)}catch(e){throw qt.SetRemoteDescriptionFailed(this.action,e.message)}}))}addIceCandidate(e){return _t(this,null,(function*(){Lt.d(ni,`[role=${this.role}] addIceCandidate candidate=${JSON.stringify(e,null,1)}`),yield this.nativeConnection.addIceCandidate(e)}))}get remoteDescription(){return this.nativeConnection.remoteDescription}getSenders(){return this.nativeConnection.getSenders()}removeTrack(e){this.nativeConnection.removeTrack(e)}setMaxBitrate(e,t){return _t(this,null,(function*(){let i=this.getSenders().find((e=>{var i;return(null==(i=null==e?void 0:e.track)?void 0:i.id)===t.getTrackIDBeingSent()}));if(i){let t=i.getParameters();t.encodings.length>0&&(t.encodings[0].maxBitrate=1e3*e),yield i.setParameters(t)}else Lt.w(ni,`no sender found to setMaxBitrate for track - ${t.trackId}, sentTrackId - ${t.getTrackIDBeingSent()}`)}))}getStats(){return _t(this,null,(function*(){return yield this.nativeConnection.getStats()}))}close(){return _t(this,null,(function*(){this.nativeConnection.close()}))}},ai="renegotiation-callback-id",oi="ion-sfu",li="SUBSCRIBE_ICE_CONNECTION_CALLBACK_ID",ci=class extends si{constructor(e,t,i,r){super(Gt.Publish,e),this.observer=i,this.transport=r,this.nativeConnection=new RTCPeerConnection(t),this.nativeConnection.createDataChannel(oi,{protocol:"SCTP"}),this.nativeConnection.onicecandidate=({candidate:t})=>{t&&e.trickle(this.role,t)},this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)}}initAfterJoin(){this.nativeConnection.onnegotiationneeded=()=>_t(this,null,(function*(){Lt.d("HMSPublishConnection","onnegotiationneeded"),yield this.observer.onRenegotiationNeeded()}))}trackUpdate(e){this.transport.trackUpdate(e)}},di=class{constructor(e){this.tracks=new Array,this.nativeStream=e,this.id=e.id}},ui=class extends di{constructor(e,t){super(e),this.audio=!0,this.video=Ot.NONE,this.connection=t}setAudio(e){this.audio!==e&&(this.audio=e,this.syncWithApiChannel(!1))}setVideoLayerLocally(e,t){this.video=e,Lt.d(`[Remote stream] ${t} - ${this.id}`,`Setting layer field to - ${e}`)}setVideoLayer(e,t){this.setVideoLayerLocally(e,t),Lt.d(`[Remote stream] ${t} - ${this.id}`,`Switching to ${e} layer`),this.syncWithApiChannel()}getSimulcastLayer(){return this.video}isAudioSubscribed(){return this.audio}syncWithApiChannel(e=!0){let t={streamId:this.id,audio:this.audio};e&&(t.video=this.video,t.framerate=this.video),this.connection.sendOverApiDataChannel(JSON.stringify(t))}},hi=class{constructor(e,t,i){this.logIdentifier="",this.stream=e,this.nativeTrack=t,this.source=i}get enabled(){return this.nativeTrack.enabled}get trackId(){return this.firstTrackId||this.sdpTrackId||this.nativeTrack.id}getMediaTrackSettings(){return this.nativeTrack.getSettings()}setEnabled(e){return _t(this,null,(function*(){this.nativeTrack.enabled=e}))}setSdpTrackId(e){this.sdpTrackId=e}setFirstTrackId(e){this.firstTrackId=e}cleanup(){var e;null==(e=this.nativeTrack)||e.stop()}};!function(e){e.AUDIO="audio",e.VIDEO="video"}(ti||(ti={}));var pi,vi,mi=class extends hi{constructor(e,t,i){if(super(e,t,i),this.type=ti.AUDIO,this.audioElement=null,"audio"!==t.kind)throw new Error("Expected 'track' kind = 'audio'")}getVolume(){return this.audioElement?100*this.audioElement.volume:null}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.subscribeToAudio(0!==e&&this.enabled),this.audioElement&&(this.audioElement.volume=e/100)}setAudioElement(e){this.audioElement=e}getAudioElement(){return this.audioElement}getOutputDevice(){return this.outputDevice}cleanup(){super.cleanup(),this.audioElement&&(this.audioElement.srcObject=null,this.audioElement.remove(),this.audioElement=null)}setOutputDevice(e){return _t(this,null,(function*(){var t;if(this.audioElement)try{"function"==typeof this.audioElement.setSinkId&&(yield null==(t=this.audioElement)?void 0:t.setSinkId(e.deviceId),this.outputDevice=e)}catch(e){Lt.d("audio-track",e)}else Lt.d("audio-track","no audio element to set output")}))}removeSink(){var e;this.audioElement&&(null==(e=window.HMS)?void 0:e.AUDIO_SINK)&&(this.audioElement.srcObject=null,this.subscribeToAudio(!1))}addSink(){var e,t;if(!this.nativeTrack||!this.audioElement||!(null==(e=window.HMS)?void 0:e.AUDIO_SINK))return;let i=this.audioElement.srcObject;i instanceof MediaStream&&(null==(t=i.getAudioTracks()[0])?void 0:t.id)===this.nativeTrack.id||(this.audioElement.srcObject=new MediaStream([this.nativeTrack]),this.subscribeToAudio(!0))}subscribeToAudio(e){this.stream instanceof ui&&this.stream.setAudio(e)}},gi=class extends mi{setEnabled(e){var t=e=>super[e];return _t(this,null,(function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e),this.subscribeToAudio(e))}))}},fi=class extends hi{constructor(e,t,i){if(super(e,t,i),this.type=ti.VIDEO,this.sinkCount=0,"video"!==t.kind)throw new Error("Expected 'track' kind = 'video'")}hasSinks(){return this.sinkCount>0}addSink(e){this.addSinkInternal(e,this.nativeTrack)}removeSink(e){null!==e.srcObject&&(e.srcObject=null,this.sinkCount>0&&this.sinkCount--)}addSinkInternal(e,t){var i;let r=e.srcObject;null!==r&&r instanceof MediaStream&&(null==(i=r.getVideoTracks()[0])?void 0:i.id)===t.id||(e.srcObject=new MediaStream([t]),this.sinkCount++)}},yi=class extends fi{constructor(){super(...arguments),this._degraded=!1,this._degradedAt=null,this._layerDefinitions=[],this.history=new Ti}get degraded(){return this._degraded}get degradedAt(){return this._degradedAt}setEnabled(e){var t=e=>super[e];return _t(this,null,(function*(){e!==this.enabled&&(yield t("setEnabled").call(this,e))}))}preferLayer(e){!this.shouldSendVideoLayer(e,"preferLayer")||(this.stream.setVideoLayer(e,this.logIdentifier),this.pushInHistory(`uiPreferLayer-${e}`))}getSimulcastLayer(){return this.stream.getSimulcastLayer()}addSink(e){super.addSink(e),this.updateLayer("addSink"),this.pushInHistory("uiSetLayer-high")}removeSink(e){super.removeSink(e),this.updateLayer("removeSink"),this._degraded=!1,this.pushInHistory("uiSetLayer-none")}getSimulcastDefinitions(){return[...this._layerDefinitions]}setSimulcastDefinitons(e){this._layerDefinitions=e}setLayerFromServer(e,t){this._degraded=t,this._degradedAt=t?new Date:this._degradedAt,this.stream.setVideoLayerLocally(e,this.logIdentifier),this.pushInHistory(`sfuLayerUpdate-${e}`)}setDegradedFromSdk(e){this._degraded=e,this._degradedAt=e?new Date:this._degradedAt,this.updateLayer("sdkDegradation"),this.pushInHistory(e?"sdkDegraded-none":"sdkRecovered-high")}updateLayer(e){let t=this.degraded||!this.hasSinks()?Ot.NONE:Ot.HIGH;!this.shouldSendVideoLayer(t,e)||this.stream.setVideoLayer(t,this.logIdentifier)}pushInHistory(e){}shouldSendVideoLayer(e,t){let i=this.getSimulcastLayer();return!(!this.degraded||e!==Ot.NONE)||i!==e||(Lt.d(`[Remote Track] ${this.logIdentifier}`,`Not sending update, already on layer ${e}, source=${t}`),!1)}},Ti=class{constructor(){this.history=[]}push(e){e.time=(new Date).toISOString().split("T")[1],this.history.push(e)}},Si=class extends si{constructor(e,t,i){super(Gt.Subscribe,e),this.TAG="[HMSSubscribeConnection]",this.remoteStreams=new Map,this.pendingMessageQueue=[],this.handlePendingApiMessages=()=>{this.pendingMessageQueue.length>0&&(Lt.d(this.TAG,"Found pending message queue, sending messages"),this.pendingMessageQueue.forEach((e=>this.sendOverApiDataChannel(e))),this.pendingMessageQueue.length=0)},this.observer=i,this.nativeConnection=new RTCPeerConnection(t),this.initNativeConnectionCallbacks()}initNativeConnectionCallbacks(){this.nativeConnection.oniceconnectionstatechange=()=>{this.observer.onIceConnectionChange(this.nativeConnection.iceConnectionState)},this.nativeConnection.onconnectionstatechange=()=>{this.observer.onConnectionStateChange(this.nativeConnection.connectionState)},this.nativeConnection.ondatachannel=e=>{e.channel.label===oi&&(this.apiChannel=new class{constructor(e,t,i=""){this.TAG="HMSDataChannel",this.nativeChannel=e,this.observer=t,this.metadata=i,e.onmessage=e=>{this.observer.onMessage(e.data)}}get id(){return this.nativeChannel.id}get label(){return this.nativeChannel.label}get readyState(){return this.nativeChannel.readyState}send(e){Lt.d(this.TAG,`[${this.metadata}] Sending [size=${e.length}] message=${e}`),this.nativeChannel.send(e)}close(){this.nativeChannel.close()}}(e.channel,{onMessage:e=>{this.observer.onApiChannelMessage(e)}},`role=${this.role}`),e.channel.onopen=this.handlePendingApiMessages)},this.nativeConnection.onicecandidate=e=>{null!==e.candidate&&this.signal.trickle(this.role,e.candidate)},this.nativeConnection.ontrack=e=>{var t;let i=e.streams[0],r=i.id;if(!this.remoteStreams.has(r)){let e=new ui(i,this);this.remoteStreams.set(r,e),i.onremovetrack=t=>{let i=e.tracks.findIndex((e=>e.nativeTrack.id===t.track.id));if(i>=0){let t=e.tracks[i];this.observer.onTrackRemove(t),e.tracks.splice(i,1),0===e.tracks.length&&this.remoteStreams.delete(r)}}}let n=this.remoteStreams.get(r),s=new("audio"===e.track.kind?gi:yi)(n,e.track),a=function(e,t){var i;if(!(null==e?void 0:e.sdp)||!t)return;let r=(0,at.Qc)(e.sdp).media.find((e=>ei(e.mid)&&parseInt(e.mid)===parseInt(t)));return null==(i=null==r?void 0:r.msid)?void 0:i.split(" ")[1]}(this.remoteDescription,null==(t=e.transceiver)?void 0:t.mid);a&&s.setSdpTrackId(a),n.tracks.push(s),this.observer.onTrackAdd(s)}}sendOverApiDataChannel(e){this.apiChannel&&"open"===this.apiChannel.readyState?this.apiChannel.send(e):(Lt.w(this.TAG,`API Data channel not ${this.apiChannel?"open":"present"}, queueing`,e),this.pendingMessageQueue.push(e))}close(){var e=e=>super[e];return _t(this,null,(function*(){var t;yield e("close").call(this),null==(t=this.apiChannel)||t.close()}))}},ki=class{constructor(e){this.key=e,this.storage=null}getStorage(){return Ri&&(this.storage=window.localStorage),this.storage}get(){var e;let t=null==(e=this.getStorage())?void 0:e.getItem(this.key);return t?JSON.parse(t):void 0}set(e){var t;let i=JSON.stringify(e);null==(t=this.getStorage())||t.setItem(this.key,i)}clear(){var e;null==(e=this.getStorage())||e.removeItem(this.key)}},Ei=new ot.UAParser,bi="undefined"==typeof window&&!(null==(pi=Ei.getBrowser().name)?void 0:pi.toLowerCase().includes("electron")),Ri="undefined"!=typeof window,Ci=function(){if(bi)return"hmsclient/0.2.4";let e=Ei.getDevice(),t=Ei.getBrowser(),i=Ei.getOS();return e.type?`hmsclient/0.2.4 ${i.name}/${i.version} (${e.vendor}_${e.type}_/_${t.name}_${t.version})`:`hmsclient/0.2.4 ${i.name}/${i.version} (${t.name}_${t.version})`}(),Pi="InitService";!function(e){e.JOIN="join",e.OFFER="offer",e.ANSWER="answer",e.TRICKLE="trickle",e.TRACK_UPDATE="track-update",e.BROADCAST="broadcast",e.ANALYTICS="analytics",e.SERVER_ERROR="on-error",e.SERVER_WARNING="on-warning",e.SDK_NOTIFICATION="sdk-notification",e.LEAVE="leave",e.END_ROOM="end-room",e.PING="ping",e.ROLE_CHANGE_REQUEST="role-change-request",e.ROLE_CHANGE="role-change",e.TRACK_UPDATE_REQUEST="track-update-request",e.PEER_LEAVE_REQUEST="peer-leave-request",e.CHANGE_TRACK_MUTE_STATE_REQUEST="change-track-mute-state-request",e.START_RTMP_OR_RECORDING_REQUEST="rtmp-start",e.STOP_RTMP_AND_RECORDING_REQUEST="rtmp-stop",e.UPDATE_PEER_METADATA="peer-update",e.START_HLS_STREAMING="hls-start",e.STOP_HLS_STREAMING="hls-stop"}(vi||(vi={}));var _i=class{constructor(e=1/0){this.capacity=e,this.storage=[]}size(){return this.storage.length}toList(){return this.storage.slice(0)}enqueue(e){this.size()===this.capacity&&this.dequeue(),this.storage.push(e)}dequeue(){return this.storage.shift()}aggregate(e){return e(this.storage)}};function Ai(e){if(e<0)throw Error("`ms` should be a positive integer");return new Promise((t=>setTimeout(t,e)))}var wi,Ii=class{constructor(){this._volume=1,this._codec=Ut.OPUS,this._maxBitrate=32,this._deviceId="default",this._advanced=[{googEchoCancellation:{exact:!0}},{googExperimentalEchoCancellation:{exact:!0}},{autoGainControl:{exact:!0}},{noiseSuppression:{exact:!0}},{googHighpassFilter:{exact:!0}},{googAudioMirroring:{exact:!0}}]}volume(e){if(!(0<=e&&e<=1))throw Error("volume can only be in range [0.0, 1.0]");return this._volume=e,this}codec(e){return this._codec=e,this}maxBitrate(e){if(e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Di(this._volume,this._codec,this._maxBitrate,this._deviceId,this._advanced)}},Di=class{constructor(e,t,i,r,n){this.volume=e,this.codec=t,this.maxBitrate=i,this.deviceId=r,this.advanced=n}toConstraints(){return{deviceId:this.deviceId,advanced:this.advanced}}toAnalyticsProperties(){return{audio_bitrate:this.maxBitrate,audio_codec:this.codec}}},Oi=class{constructor(){this._width=320,this._height=180,this._codec=xt.VP8,this._maxFramerate=30,this._maxBitrate=150,this._advanced=[]}setWidth(e){return this._width=e,this}setHeight(e){return this._height=e,this}codec(e){return this._codec=e,this}maxFramerate(e){if(e&&e<=0)throw Error("maxFramerate should be >= 1");return this._maxFramerate=e,this}maxBitrate(e,t=!0){if("number"==typeof e&&e<=0)throw Error("maxBitrate should be >= 1");return this._maxBitrate=e,!this._maxBitrate&&t&&(this._maxBitrate=15e4),this}deviceId(e){return this._deviceId=e,this}advanced(e){return this._advanced=e,this}build(){return new Ni(this._width,this._height,this._codec,this._maxFramerate,this._deviceId,this._advanced,this._maxBitrate)}},Ni=class{constructor(e,t,i,r,n,s,a){this.width=e,this.height=t,this.codec=i,this.maxFramerate=r,this.maxBitrate=a,this.deviceId=n,this.advanced=s}toConstraints(){return{width:this.width,height:this.height,frameRate:this.maxFramerate,deviceId:this.deviceId}}toAnalyticsProperties(){return{width:this.width,height:this.height,video_bitrate:this.maxBitrate,framerate:this.maxFramerate,video_codec:this.codec}}},Mi=class{constructor(){this._video=(new Oi).build(),this._audio=(new Ii).build(),this._screen=(new Oi).build(),this._simulcast=!1}video(e){return this._video=e,this}audio(e){return this._audio=e,this}screen(e){return this._screen=e,this}simulcast(e){return this._simulcast=e,this}build(){if(null===this._audio&&null===this._video)throw Jt.NothingToReturn(Vt.TRACK);if(null===this._video&&this._simulcast)throw Jt.InvalidVideoSettings(Vt.TRACK,"Cannot enable simulcast when no video settings are provided");return new Li(this._video,this._audio,this._simulcast,this._screen||void 0)}},Li=class{constructor(e,t,i,r=null){this.video=e,this.audio=t,this.simulcast=i,this.screen=r}toAnalyticsProperties(){let e={audio_enabled:null!==this.audio,video_enabled:null!==this.video};return this.audio&&(e=Rt(Rt({},this.audio.toAnalyticsProperties()),e)),this.video&&(e=Rt(Rt({},this.video.toAnalyticsProperties()),e)),e}};!function(e){e.ROOM_STATE="room-state",e.PEER_JOIN="on-peer-join",e.PEER_LEAVE="on-peer-leave",e.PEER_LIST="peer-list",e.TRACK_METADATA_ADD="on-track-add",e.TRACK_UPDATE="on-track-update",e.CHANGE_TRACK_MUTE_STATE_UPDATE="on-change-track-mute-state-request",e.ACTIVE_SPEAKERS="active-speakers",e.CONNECTION_QUALITY="on-connection-quality-update",e.SFU_STATS="sfu-stats",e.ON_SFU_TRACK_LAYER_UPDATE="on-track-layer-update",e.BROADCAST="on-broadcast",e.ROLE_CHANGE="on-role-change",e.POLICY_CHANGE="on-policy-change",e.ROLE_CHANGE_REQUEST="on-role-change-request",e.TRACK_UPDATE_REQUEST="on-track-update-request",e.PEER_UPDATE="on-peer-update",e.PEER_LEAVE_REQUEST="on-peer-leave-request",e.UNSUPPORTED="unsupported",e.RTMP_START="on-rtmp-start",e.RTMP_STOP="on-rtmp-stop",e.RECORDING_START="on-record-start",e.RECORDING_STOP="on-record-stop",e.HLS_START="on-hls-start",e.HLS_STOP="on-hls-stop"}(wi||(wi={}));var xi=class{constructor({sender:e,message:t,type:i="chat",recipientPeer:r,recipientRoles:n,time:s}){this.sender=e,this.message=t,this.type=i,this.recipientPeer=r,this.recipientRoles=n,this.time=s}toSignalParams(){var e,t;let i=null==(e=this.recipientRoles)?void 0:e.map((e=>e.name)),r=null==(t=this.recipientPeer)?void 0:t.peerId,n={info:{message:this.message,type:this.type}};return(null==i?void 0:i.length)&&(n.roles=i),r&&(n.peer_id=r),n}},Ui=class{constructor({peerId:e,name:t,isLocal:i,customerUserId:r,metadata:n,role:s,joinedAt:a}){this.customerUserId="",this.metadata="",this.auxiliaryTracks=[],this.name=t,this.peerId=e,this.isLocal=i,this.customerUserId=r,this.metadata=n,this.joinedAt=a,s&&(this.role=s)}updateRole(e){this.role=e}updateName(e){this.name=e}updateMetadata(e){this.metadata=e}},Fi=class{};Fi.makePeerId=()=>vt();var Gi,Bi,Vi,ji,Ki=class extends Ui{constructor(e){super(Ct(Rt({},e),{peerId:Fi.makePeerId(),isLocal:!0})),this.isLocal=!0,this.auxiliaryTracks=[]}},$i=class extends Ui{constructor(e){super(Ct(Rt({},e),{isLocal:!1})),this.isLocal=!1,this.auxiliaryTracks=[],this.fromRoomState=!1,this.fromRoomState=!!e.fromRoomState}},Hi=e=>e?new Date(e):void 0;function Wi(e,t){let i=function(e,t=""){if("chrome"===nt.browserDetails.browser&&"NotAllowedError"===e.name&&e.message.includes("denied by system"))return Jt.SystemDeniedPermission(Vt.TRACK,t,e.message);if("firefox"===nt.browserDetails.browser&&"NotFoundError"===e.name){let i=Jt.SystemDeniedPermission(Vt.TRACK,t,e.message);return i.description=`Capture device is either blocked at Operating System level or not available - ${t}`,i}switch(e.name){case"OverconstrainedError":return Jt.OverConstrained(Vt.TRACK,t,e.constraint);case"NotAllowedError":return Jt.CantAccessCaptureDevice(Vt.TRACK,t,e.message);case"NotFoundError":return Jt.DeviceNotAvailable(Vt.TRACK,t,e.message);case"NotReadableError":return Jt.DeviceInUse(Vt.TRACK,t,e.message);case"TypeError":return Jt.NothingToReturn(Vt.TRACK,e.message);default:return function(e,t){let i=e.toLowerCase();return i.includes("device not found")?Jt.DeviceNotAvailable(Vt.TRACK,t,e):i.includes("permission denied")?Jt.CantAccessCaptureDevice(Vt.TRACK,t,e):Jt.GenericTrack(Vt.TRACK,e)}(e.message,t)}}(e,t);return i.addNativeError(e),i}function Ji(e){return"canvas"in e||"MediaStreamAudioDestinationNode"===e.label||""===e.label}!function(e){e.UNKNOWN="unknown(video or audio)",e.AUDIO="audio",e.VIDEO="video",e.AV="audio, video",e.SCREEN="screen"}(Gi||(Gi={})),function(e){e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE"}(Bi||(Bi={})),function(e){e.PLATFORM_NOT_SUPPORTED="PLATFORM_NOT_SUPPORTED",e.DEVICE_NOT_SUPPORTED="DEVICE_NOT_SUPPORTED"}(Vi||(Vi={})),function(e){e.CUSTOM="CUSTOM",e.LOCAL="LOCAL",e.HMS="HMS"}(ji||(ji={}));var qi,zi,Qi=function(){if(Ri&&window){let e=window.location.hostname;return"localhost"===e||"127.0.0.1"===e?ji.LOCAL:e.includes("app.100ms.live")?ji.HMS:ji.CUSTOM}return ji.CUSTOM}(),Yi=class{constructor({name:e,level:t,properties:i,includesPII:r,timestamp:n}){this.metadata={peer:{}},this.name=e,this.level=t,this.includesPII=r||!1,this.properties=i||{},this.timestamp=n||(new Date).getTime(),this.event_id=vt(),this.device_id=(()=>{let e="",t=new ki("hms-analytics-deviceId"),i=t.get();return i?e=i:(e=vt(),t.set(e)),e})()}toSignalParams(){return{name:this.name,info:Ct(Rt({},this.properties),{timestamp:this.timestamp,domain:Qi}),timestamp:(new Date).getTime()}}};!function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"}(qi||(qi={})),function(e){e[e.VERBOSE=0]="VERBOSE",e[e.INFO=1]="INFO",e[e.ERROR=2]="ERROR",e[e.OFF=3]="OFF"}(zi||(zi={}));var Zi=class{static failure(e,t){let i=zi.ERROR,r=Rt({plugin_name:e},t.toAnalyticsProperties());return new Yi({name:"mediaPlugin.failed",level:i,properties:r})}static audioPluginFailure(e,t,i){let r=zi.ERROR,n=Rt({plugin_name:e,sampleRate:t},i.toAnalyticsProperties());return new Yi({name:"mediaPlugin.failed",level:r,properties:n})}static audioPluginStats({pluginName:e,duration:t,loadTime:i,sampleRate:r}){let n=zi.INFO;return new Yi({name:"mediaPlugin.stats",level:n,properties:{plugin_name:e,duration:t,load_time:i,sampleRate:r}})}static stats({pluginName:e,duration:t,loadTime:i,avgPreProcessingTime:r,avgProcessingTime:n,inputFrameRate:s,pluginFrameRate:a}){let o=zi.INFO;return new Yi({name:"mediaPlugin.stats",level:o,properties:{plugin_name:e,duration:t,load_time:i,avg_preprocessing_time:r,avg_processing_time:n,input_frame_rate:s,plugin_frame_rate:a}})}},Xi="AudioPluginsAnalytics",er="AudioPluginsManager",tr=new class{constructor(){this.storage=new ki("hms-device-selection"),this.remember=!1,this.TAG="HMSDeviceStorage"}setDevices(e){this.devices=e}rememberDevices(e){this.remember=e}updateSelection(e,{deviceId:t,groupId:i}){if(!this.devices||!this.remember)return;let r=this.devices[e].find((e=>this.isSame({deviceId:t,groupId:i},e)));if(!r)return void Lt.w(this.TAG,`Could not find device with deviceId: ${t}, groupId: ${i}`);let n=this.storage.get()||{};n[e]=r,this.storage.set(n)}getSelection(){if(this.remember)return this.storage.get()}cleanup(){this.remember=!1,this.devices=void 0}isSame(e,t){return e.deviceId===t.deviceId&&(e.groupId===t.groupId||!e.groupId)}};function ir(e,t){return function(i){return i in e&&e[i]!==t[i]}}var rr,nr,sr=class extends mi{constructor(e,t,i,r,n=(new Ii).build()){super(e,t,i),this.eventBus=r,this.handleSettingsChange=e=>_t(this,null,(function*(){let t=this.stream,i=ir(e,this.settings);i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrate(e.maxBitrate,this)),i("advanced")&&(yield this.nativeTrack.applyConstraints(e.toConstraints()))})),this.handleDeviceChange=(e,t=!1)=>_t(this,null,(function*(){ir(e,this.settings)("deviceId")&&(yield this.replaceTrackWith(e),t||tr.updateSelection("audioInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId}))})),e.tracks.push(this),this.settings=n,"default"===n.deviceId&&!Ji(t)&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new class{constructor(e,t){this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.analytics=new class{constructor(e){this.eventBus=e,this.initTime={},this.addedTimestamps={},this.pluginAdded={},this.pluginSampleRate={}}added(e,t){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.pluginSampleRate[e]=t}removed(e){if(this.pluginAdded[e]){let t={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],sampleRate:this.pluginSampleRate[e]};this.eventBus.analytics.publish(Zi.audioPluginStats(t)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(Zi.audioPluginFailure(e,this.pluginSampleRate[e],t)),this.clean(e))}initWithTime(e,t){return _t(this,null,(function*(){if(this.initTime[e])return void Lt.i(Xi,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),Lt.i(Xi,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let i=Yt.InitFailed(Vt.AUDIO_PLUGINS,`failed during initialization of plugin${t.message||t}`);throw Lt.e(Xi,i),this.failure(e,i),i}i&&(this.initTime[e]=i)}))}timeInMs(e){return _t(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.pluginAdded[e],delete this.pluginSampleRate[e]}}(t),this.createAudioContext()}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e){return _t(this,null,(function*(){var t;let i=null==(t=e.getName)?void 0:t.call(e);if(i){if(this.pluginAddInProgress){let e=Yt.AddAlreadyInProgress(Vt.AUDIO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.added(i,this.audioContext.sampleRate),this.analytics.failure(i,e),Lt.w("can't add another plugin when previous add is in progress"),e}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e)}finally{this.pluginAddInProgress=!1}}else Lt.w("no name provided by the plugin")}))}addPluginInternal(e){return _t(this,null,(function*(){var t;let i=null==(t=e.getName)?void 0:t.call(e);if(this.pluginsMap.get(i))Lt.w(er,`plugin - ${i} already added.`);else{yield this.validateAndThrow(i,e);try{0===this.pluginsMap.size?yield this.initAudioNodes():this.prevAudioNode&&this.prevAudioNode.disconnect(),this.analytics.added(i,this.audioContext.sampleRate),yield this.analytics.initWithTime(i,(()=>_t(this,null,(function*(){return e.init()})))),this.pluginsMap.set(i,e),yield this.processPlugin(e),yield this.connectToDestination()}catch(e){throw Lt.e(er,"failed to add plugin",e),e}}}))}validatePlugin(e){return e.checkSupport(this.audioContext)}validateAndThrow(e,t){return _t(this,null,(function*(){let i=this.validatePlugin(t);if(i.isSupported)Lt.i(er,`plugin is supported,- ${t.getName()}`);else{if(this.analytics.added(e,this.audioContext.sampleRate),i.errType===Vi.PLATFORM_NOT_SUPPORTED){let t=Yt.PlatformNotSupported(Vt.AUDIO_PLUGINS,"platform not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}if(i.errType===Vi.DEVICE_NOT_SUPPORTED){let t=Yt.DeviceNotSupported(Vt.AUDIO_PLUGINS,"audio device not supported, see docs");throw this.analytics.failure(e,t),yield this.cleanup(),t}}}))}removePlugin(e){return _t(this,null,(function*(){yield this.removePluginInternal(e),0===this.pluginsMap.size?(yield this.cleanup(),Lt.i(er,"No plugins left, stopping plugins loop"),yield this.hmsTrack.setProcessedTrack(void 0)):yield this.reprocessPlugins()}))}cleanup(){return _t(this,null,(function*(){var e,t,i;for(let e of this.pluginsMap.values())yield this.removePluginInternal(e);yield this.hmsTrack.setProcessedTrack(void 0),null==(e=this.sourceNode)||e.disconnect(),null==(t=this.prevAudioNode)||t.disconnect(),null==(i=this.outputTrack)||i.stop(),this.sourceNode=void 0,this.destinationNode=void 0,this.prevAudioNode=void 0,this.outputTrack=void 0}))}closeContext(){return _t(this,null,(function*(){var e;null==(e=this.audioContext)||e.close(),this.audioContext=void 0}))}reprocessPlugins(){return _t(this,null,(function*(){if(0===this.pluginsMap.size||!this.sourceNode)return;let e=Array.from(this.pluginsMap.values());yield this.cleanup(),yield this.initAudioNodes();for(let t of e)yield this.addPlugin(t)}))}initAudioNodes(){return _t(this,null,(function*(){if(this.audioContext){if(!this.sourceNode){let e=new MediaStream([this.hmsTrack.nativeTrack]);this.sourceNode=this.audioContext.createMediaStreamSource(e)}if(!this.destinationNode){this.destinationNode=this.audioContext.createMediaStreamDestination(),this.outputTrack=this.destinationNode.stream.getAudioTracks()[0];try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw Lt.e(er,"error in setting processed track",e),e}}}}))}processPlugin(e){return _t(this,null,(function*(){try{let t=yield e.processAudioTrack(this.audioContext,this.prevAudioNode||this.sourceNode);this.prevAudioNode&&this.prevAudioNode.connect(t),this.prevAudioNode=t}catch(t){let i=e.getName();Lt.e(er,`error in processing plugin ${i}`,t),yield this.removePluginInternal(e)}}))}connectToDestination(){return _t(this,null,(function*(){try{this.prevAudioNode&&this.destinationNode&&this.prevAudioNode.context===this.destinationNode.context&&this.prevAudioNode.connect(this.destinationNode)}catch(e){Lt.e(er,"error in connecting to destination node",e)}}))}removePluginInternal(e){return _t(this,null,(function*(){var t;let i=null==(t=e.getName)?void 0:t.call(e);this.pluginsMap.get(i)?(Lt.i(er,`removing plugin ${i}`),this.pluginsMap.delete(i),e.stop(),this.analytics.removed(i)):Lt.w(er,`plugin - ${i} not found to remove.`)}))}createAudioContext(){this.audioContext||(-1!==navigator.userAgent.indexOf("Firefox")?this.audioContext=new AudioContext:this.audioContext=new AudioContext({sampleRate:48e3}))}}(this,r),this.setFirstTrackId(t.id)}replaceTrackWith(e){return _t(this,null,(function*(){let t=this.nativeTrack,i=this.enabled,r=Boolean(this.audioLevelMonitor);null==t||t.stop();let n=yield function(e){return _t(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({audio:!!e&&e.toConstraints()})).getAudioTracks()[0]}catch(e){throw Wi(e,Gi.AUDIO)}}))}(e);n.enabled=i;let s=this.stream;yield s.replaceSenderTrack(t,this.processedTrack||n),yield s.replaceStreamTrack(t,n),this.nativeTrack=n,r&&this.initAudioLevelMonitor();try{yield this.pluginsManager.reprocessPlugins()}catch(e){this.eventBus.audioPluginFailed.publish(e)}}))}setEnabled(e){var t=e=>super[e];return _t(this,null,(function*(){e!==this.enabled&&(e&&Ji(this.nativeTrack)&&(yield this.replaceTrackWith(this.settings)),yield t("setEnabled").call(this,e),e&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),this.eventBus.localAudioEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this))}))}isPublishedTrackId(e){return this.publishedTrackId===e}setSettings(e,t=!1){return _t(this,null,(function*(){let i=this.buildNewSettings(e);yield this.handleDeviceChange(i,t),Ji(this.nativeTrack)||(yield this.handleSettingsChange(i)),this.settings=i}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e){return _t(this,null,(function*(){return this.pluginsManager.addPlugin(e)}))}removePlugin(e){return _t(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}setProcessedTrack(e){return _t(this,null,(function*(){if(!e)return this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),void(this.processedTrack=void 0);e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)}))}initAudioLevelMonitor(){this.audioLevelMonitor&&this.destroyAudioLevelMonitor(),Lt.d("HMSLocalAudioTrack","Monitor Audio Level for",this,this.getMediaTrackSettings().deviceId),this.audioLevelMonitor=new class{constructor(e,t,i){this.track=e,this.audioLevelEvent=t,this.silenceEvent=i,this.TAG="[TrackAudioLevelMonitor]",this.audioLevel=0,this.isMonitored=!1,this.interval=100,this.historyInterval=700,this.history=new _i(this.historyInterval/this.interval),this.detectSilence=()=>_t(this,null,(function*(){let e=0;for(;this.isMonitored;){if(this.track.enabled){if(!this.isSilentThisInstant())break;if(e++,e>10){this.silenceEvent.publish({track:this.track});break}}yield Ai(30)}}));try{let e=new MediaStream([this.track.nativeTrack]);this.analyserNode=this.createAnalyserNodeForStream(e)}catch(e){Lt.w(this.TAG,"Unable to initialize AudioContext",e)}}start(){this.stop(),this.isMonitored=!0,Lt.d(this.TAG,"Starting track Monitor",this.track),this.loop().then((()=>Lt.d(this.TAG,"Stopping track Monitor",this.track)))}stop(){this.analyserNode?(this.sendAudioLevel(0),this.isMonitored=!1):Lt.d(this.TAG,"AudioContext not initialized")}loop(){return _t(this,null,(function*(){for(;this.isMonitored;)this.sendAudioLevel(this.getMaxAudioLevelOverPeriod()),yield Ai(this.interval)}))}sendAudioLevel(e=0){if(e=e>35?e:0,Math.abs(this.audioLevel-e)>5){this.audioLevel=e;let t={track:this.track,audioLevel:this.audioLevel};this.audioLevelEvent.publish(t)}}getMaxAudioLevelOverPeriod(){if(!this.analyserNode)return void Lt.d(this.TAG,"AudioContext not initialized");let e=this.calculateAudioLevel();return void 0!==e&&this.history.enqueue(e),this.history.aggregate((e=>Math.max(...e)))}calculateAudioLevel(){if(!this.analyserNode)return void Lt.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(e);let t=.009,i=t;for(let t of e)i=Math.max(i,(t-128)/128);let r=(Math.log(t)-Math.log(i))/Math.log(t);return Math.ceil(Math.min(Math.max(100*r,0),100))}isSilentThisInstant(){if(!this.analyserNode)return void Lt.d(this.TAG,"AudioContext not initialized");let e=new Uint8Array(this.analyserNode.fftSize);return this.analyserNode.getByteTimeDomainData(e),!e.some((e=>128!==e&&0!==e))}createAnalyserNodeForStream(e){let t=new AudioContext,i=t.createAnalyser();return t.createMediaStreamSource(e).connect(i),i}}(this,this.eventBus.trackAudioLevelUpdate,this.eventBus.localAudioSilence),this.audioLevelMonitor.start(),this.audioLevelMonitor.detectSilence()}destroyAudioLevelMonitor(){var e;null==(e=this.audioLevelMonitor)||e.stop(),this.audioLevelMonitor=void 0}cleanup(){var e=e=>super[e];return _t(this,null,(function*(){var t;e("cleanup").call(this),yield this.pluginsManager.cleanup(),yield this.pluginsManager.closeContext(),null==(t=this.processedTrack)||t.stop(),this.destroyAudioLevelMonitor()}))}getTrackIDBeingSent(){return this.processedTrack?this.processedTrack.id:this.nativeTrack.id}getTrackBeingSent(){return this.processedTrack||this.nativeTrack}buildNewSettings(e){let{volume:t,codec:i,maxBitrate:r,deviceId:n,advanced:s}=Rt(Rt({},this.settings),e);return new Di(t,i,r,n,s)}};!function(e){e.TRANSFORM="TRANSFORM",e.ANALYZE="ANALYZE"}(rr||(rr={})),function(e){e["2D"]="2d",e.WEBGL="webgl",e.WEBGL2="webgl2"}(nr||(nr={}));var ar=class{constructor(){this.total=0,this.count=0}add(e){this.count++,this.total+=e}getAvg(){return Math.floor(this.total/this.count)}reset(){this.total=0,this.count=0}},or="VideoPluginsAnalytics",lr=320,cr=240,dr="VideoPluginsManager",ur="HMSLocalStream",hr=class extends di{constructor(){super(...arguments),this.connection=null}setConnection(e){this.connection=e}addTransceiver(e,t){let i=[];if(e instanceof Er)if(t.length>0)Lt.v(ur,"Simulcast enabled with layers",t),i.push(...t);else{let t={active:this.nativeStream.active};e.settings.maxBitrate&&!bi&&(t.maxBitrate=e.settings.maxBitrate),i.push(t)}let r=this.connection.addTransceiver(e.nativeTrack,{streams:[this.nativeStream],direction:"sendonly",sendEncodings:i});return this.setPreferredCodec(r,e.nativeTrack.kind),r}setMaxBitrate(e,t){return _t(this,null,(function*(){var i;yield null==(i=this.connection)?void 0:i.setMaxBitrate(e,t)}))}setPreferredCodec(e,t){}replaceTrack(e,t){return _t(this,null,(function*(){yield this.replaceSenderTrack(e,t),e.stop(),this.replaceStreamTrack(e,t)}))}replaceStreamTrack(e,t){this.nativeStream.addTrack(t),this.nativeStream.removeTrack(e)}replaceSenderTrack(e,t){return _t(this,null,(function*(){var i;let r=null==(i=this.connection)?void 0:i.getSenders().find((t=>t.track&&t.track.id===e.id));void 0!==r?yield r.replaceTrack(t):Lt.w(ur,`No sender found for trackId=${e.id}`)}))}removeSender(e){let t=0;this.connection.getSenders().forEach((i=>{var r,n;if((null==(r=i.track)?void 0:r.id)===e.trackId||(null==(n=i.track)?void 0:n.id)===e.getTrackIDBeingSent()){this.connection.removeTrack(i),t+=1;let r=this.tracks.indexOf(e);-1!==r?this.tracks.splice(r,1):Lt.e(ur,`Cannot find ${e.trackId} in locally stored tracks`)}})),1!==t&&Lt.e(ur,`Removed ${t} sender's, expected to remove 1`)}trackUpdate(e){var t;null==(t=this.connection)||t.trackUpdate(e)}},pr=class{static connect(e,t,i=new Date,r=new Date,n){let s=this.eventNameFor("connect",void 0===e),a=e?zi.ERROR:zi.INFO,o=this.getPropertiesWithError(Ct(Rt({},t),{[this.KEY_REQUESTED_AT]:null==i?void 0:i.getTime(),[this.KEY_RESPONDED_AT]:null==r?void 0:r.getTime(),endpoint:n}),e);return new Yi({name:s,level:a,properties:o})}static disconnect(e,t){let i=e?zi.ERROR:zi.INFO,r=this.getPropertiesWithError(t,e);return new Yi({name:"disconnected",level:i,properties:r})}static preview(e){var t=e,{error:i}=t,r=Pt(t,["error"]);let n=this.eventNameFor("preview",void 0===i),s=i?zi.ERROR:zi.INFO,a=this.getPropertiesWithError(r,i);return new Yi({name:n,level:s,properties:a})}static join(e){var t=e,{error:i}=t,r=Pt(t,["error"]);let n=this.eventNameFor("join",void 0===i),s=i?zi.ERROR:zi.INFO,a=this.getPropertiesWithError(Ct(Rt({},r),{is_preview_called:!!r.is_preview_called}),i);return new Yi({name:n,level:s,properties:a})}static publish({devices:e,settings:t,error:i}){let r=this.eventNameFor("publish",void 0===i),n=i?zi.ERROR:zi.INFO,s=this.getPropertiesWithError({devices:e,audio:null==t?void 0:t.audio,video:null==t?void 0:t.video},i);return new Yi({name:r,level:n,properties:s})}static subscribeFail(e){let t=this.eventNameFor("subscribe",!1),i=zi.ERROR,r=this.getErrorProperties(e);return new Yi({name:t,level:i,properties:r})}static leave(){return new Yi({name:"leave",level:zi.INFO})}static autoplayError(){return new Yi({name:"autoplayError",level:zi.ERROR})}static deviceChange({selection:e,type:t,devices:i,error:r}){let n=this.eventNameFor(r?"publish":`device.${t}`,void 0===r),s=r?zi.ERROR:zi.INFO,a=this.getPropertiesWithError({selection:e,devices:i},r);return new Yi({name:n,level:s,properties:a})}static performance(e){let t=zi.INFO,i=e.toAnalyticsProperties();return new Yi({name:"perf.stats",level:t,properties:i})}static rtcStats(e){let t=zi.INFO,i=e.toAnalyticsProperties();return new Yi({name:"rtc.stats",level:t,properties:i})}static degradationStats(e,t){let i=zi.INFO,r={degradedAt:e.degradedAt,trackId:e.trackId};if(!t&&e.degradedAt instanceof Date){let t=new Date,i=t.valueOf()-e.degradedAt.valueOf();r=Ct(Rt({},r),{duration:i,restoredAt:t})}return new Yi({name:"video.degradation.stats",level:i,properties:r})}static audioDetectionFail(e,t){let i=this.getPropertiesWithError({device:t},e),r=zi.ERROR;return new Yi({name:"audiopresence.failed",level:r,properties:i})}static previewNetworkQuality(e){return new Yi({name:"perf.networkquality.preview",level:e.error?zi.ERROR:zi.INFO,properties:e})}static eventNameFor(e,t){return`${e}.${t?"success":"failed"}`}static getPropertiesWithError(e,t){let i=this.getErrorProperties(t);return Rt(Rt({},i),e)}static getErrorProperties(e){return e?e instanceof $t?e.toAnalyticsProperties():{error_name:e.name,error_message:e.message}:{}}};pr.KEY_REQUESTED_AT="requested_at",pr.KEY_RESPONDED_AT="responded_at";var vr,mr={audioContext:null,getAudioContext(){return this.audioContext||(this.audioContext=new AudioContext),this.audioContext},resumeContext(){this.getAudioContext().resume().catch((e=>{Lt.e("AudioContext",e)}))}};!function(e){e.INIT="init_response_time",e.WEBSOCKET_CONNECT="ws_connect_time",e.ON_POLICY_CHANGE="on_policy_change_time",e.LOCAL_TRACKS="local_tracks_time",e.JOIN="join_time",e.PREVIEW="preview_time"}(vr||(vr={}));var gr,fr=class{constructor(e,t,i,r,n){this.store=e,this.observer=t,this.deviceManager=i,this.eventBus=r,this.analyticsTimer=n,this.TAG="[LocalTrackManager]"}getTracksToPublish(e){return _t(this,null,(function*(){let t=this.getTrackSettings(e);if(!t)return[];let i=!!t.audio,r=!!t.video,n=[],{videoTrack:s,audioTrack:a}=yield this.updateCurrentLocalTrackSettings(t),o=(null==s?void 0:s.stream)||(null==a?void 0:a.stream),l=Boolean(s&&this.store.getTrackById(s.trackId)),c=Boolean(a&&this.store.getTrackById(a.trackId));if(l&&c)return[];let d={audio:i&&!a&&(!e.isAudioMuted||"empty"),video:r&&!s&&(!e.isVideoMuted||"empty")};this.analyticsTimer.start(vr.LOCAL_TRACKS);try{Lt.d(this.TAG,"Init Local Tracks",{fetchTrackOptions:d}),n=yield this.getLocalTracks(d,t,o)}catch(e){n=yield this.retryGetLocalTracks(e,t,d,o)}return this.analyticsTimer.end(vr.LOCAL_TRACKS),s&&r&&!l&&n.push(s),a&&i&&!c&&n.push(a),n}))}getLocalTracks(){return _t(this,arguments,(function*(e={audio:!0,video:!0},t,i){try{let r=yield this.getNativeLocalTracks(e,t);return this.createHMSLocalTracks(r,t,i)}catch(e){throw e instanceof $t&&this.eventBus.analytics.publish(pr.publish({devices:this.deviceManager.getDevices(),error:e,settings:t})),e}}))}getNativeLocalTracks(){return _t(this,arguments,(function*(e={audio:!1,video:!1},t){let i=new Li(!0===e.video?t.video:null,!0===e.audio?t.audio:null,t.simulcast),r=[];return(i.audio||i.video)&&r.push(...yield this.getAVTracks(i)),r.push(...this.getEmptyTracks(e)),r}))}getLocalScreen(e,t){return _t(this,null,(function*(){let i,r={video:e.toConstraints()};if(t){let e=t.toConstraints();delete e.advanced,r.audio=Ct(Rt({},e),{autoGainControl:!1,noiseSuppression:!1,googAutoGainControl:!1,echoCancellation:!1})}try{i=yield navigator.mediaDevices.getDisplayMedia(r)}catch(e){throw Wi(e,Gi.SCREEN)}let n=[],s=new hr(i),a=i.getVideoTracks()[0],o=new Er(s,a,"screen",this.eventBus,e);n.push(o);let l=i.getAudioTracks()[0];if(l){let e=new sr(s,l,"screen",this.eventBus,t);n.push(e)}return Lt.v(this.TAG,"getLocalScreen",n),n}))}requestPermissions(){return _t(this,null,(function*(){try{(yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})).getTracks().forEach((e=>e.stop()))}catch(e){Lt.e(this.TAG,e)}}))}static getEmptyVideoTrack(e){var t,i,r;let n=(null==(t=null==e?void 0:e.getSettings())?void 0:t.width)||320,s=(null==(i=null==e?void 0:e.getSettings())?void 0:i.height)||240;gr||null==(r=(gr=Object.assign(document.createElement("canvas"),{width:n,height:s})).getContext("2d"))||r.fillRect(0,0,n,s);let a=gr.captureStream(10).getVideoTracks()[0],o=setInterval((()=>{if("ended"===a.readyState)return void clearInterval(o);let e=gr.getContext("2d");if(e){let t=0===e.getImageData(0,0,1,1).data[0]?1:0;e.fillStyle=`rgb(${t}, 0, 0)`,e.fillRect(0,0,1,1)}}),100);return a.onended=()=>{clearInterval(o)},a.enabled=!1,a}static getEmptyAudioTrack(){let e=mr.getAudioContext(),t=e.createOscillator(),i=e.createMediaStreamDestination();t.connect(i),t.start();let r=i.stream.getAudioTracks()[0];return r.enabled=!1,r}getAVTracks(e){return _t(this,null,(function*(){try{let t=yield navigator.mediaDevices.getUserMedia({audio:!!e.audio&&e.audio.toConstraints(),video:!!e.video&&e.video.toConstraints()});return t.getVideoTracks().concat(t.getAudioTracks())}catch(t){yield this.deviceManager.init();let i=!(this.deviceManager.hasWebcamPermission||!e.video),r=!(this.deviceManager.hasMicrophonePermission||!e.audio);throw Wi(t,this.getErrorType(i,r))}}))}getTrackSettings(e){let t=this.getAudioSettings(e),i=this.getVideoSettings(e);if(!t&&!i)return null;let r=this.getScreenSettings();return(new Mi).video(i).audio(t).screen(r).build()}retryGetLocalTracks(e,t,i,r){return _t(this,null,(function*(){if(!(e instanceof $t&&e.action===Vt.TRACK))return Lt.w(this.TAG,"Fetch AV Tracks failed - unknown exception",e),this.observer.onFailure(e),[];{this.observer.onFailure(e);let n=e.code===Kt.TracksErrors.OVER_CONSTRAINED,s=e.message.includes("audio"),a=e.message.includes("video");if(n){let n=(new Mi).video(new Ni).audio(new Di).build();Lt.w(this.TAG,"Fetch AV Tracks failed with overconstrained error",{fetchTrackOptions:i},{error:e});try{return yield this.getLocalTracks(i,n,r)}catch(e){let n=e instanceof $t?e.nativeError:e,s=e;if("OverconstrainedError"===(null==n?void 0:n.name)){let e=Jt.GenericTrack(Vt.TRACK,"Overconstrained error after dropping all constraints");e.addNativeError(n),s=e}return yield this.retryGetLocalTracks(s,t,i,r)}}i.audio=s?"empty":i.audio,i.video=a?"empty":i.video,Lt.w(this.TAG,"Fetch AV Tracks failed",{fetchTrackOptions:i},e);try{return yield this.getLocalTracks(i,t,r)}catch(e){return Lt.w(this.TAG,"Fetch empty tacks failed",e),i.audio=i.audio&&"empty",i.video=i.video&&"empty",this.observer.onFailure(e),yield this.getLocalTracks(i,t,r)}}}))}getErrorType(e,t){return e&&t?Gi.AV:e?Gi.VIDEO:t?Gi.AUDIO:Gi.UNKNOWN}getEmptyTracks(e){let t=[];return"empty"===e.audio&&t.push(fr.getEmptyAudioTrack()),"empty"===e.video&&t.push(fr.getEmptyVideoTrack()),t}updateCurrentLocalTrackSettings(e){return _t(this,null,(function*(){let t=this.store.getLocalPeerTracks(),i=t.find((e=>e.type===ti.VIDEO&&"regular"===e.source)),r=t.find((e=>e.type===ti.AUDIO&&"regular"===e.source)),n=t.find((e=>e.type===ti.VIDEO&&"screen"===e.source));return(null==e?void 0:e.video)&&(yield null==i?void 0:i.setSettings(e.video)),(null==e?void 0:e.audio)&&(yield null==r?void 0:r.setSettings(e.audio)),(null==e?void 0:e.screen)&&(yield null==n?void 0:n.setSettings(e.screen)),{videoTrack:i,audioTrack:r}}))}getAudioSettings(e){var t;let i=this.store.getPublishParams();if(!i||!(null==(t=i.allowed)?void 0:t.includes("audio")))return null;let r=this.store.getLocalPeer(),n=null==r?void 0:r.audioTrack,s=(null==n?void 0:n.settings.deviceId)||e.audioInputDeviceId;return(new Ii).codec(i.audio.codec).maxBitrate(i.audio.bitRate).deviceId(s||"default").build()}getVideoSettings(e){var t;let i=this.store.getPublishParams();if(!i||!(null==(t=i.allowed)?void 0:t.includes("video")))return null;let r=this.store.getLocalPeer(),n=null==r?void 0:r.videoTrack,s=(null==n?void 0:n.settings.deviceId)||e.videoDeviceId,a=i.video,{width:o=a.width,height:l=a.height}=this.store.getSimulcastDimensions("regular")||{};return(new Oi).codec(a.codec).maxBitrate(a.bitRate).maxFramerate(a.frameRate).setWidth(o).setHeight(l).deviceId(s||"default").build()}getScreenSettings(){var e;let t=this.store.getPublishParams();if(!t||!(null==(e=t.allowed)?void 0:e.includes("screen")))return null;let i=t.screen,{width:r=i.width,height:n=i.height}=this.store.getSimulcastDimensions("screen")||{};return(new Oi).maxBitrate(i.bitRate,!1).codec(i.codec).maxFramerate(i.frameRate).setWidth(r).setHeight(n).build()}createHMSLocalTracks(e,t,i){let r=e.find((e=>"video"===e.kind)),n=e.find((e=>"audio"===e.kind));i?e.forEach((e=>null==i?void 0:i.nativeStream.addTrack(e))):i=new hr(new MediaStream(e));let s=[];if(n&&(null==t?void 0:t.audio)){let e=new sr(i,n,"regular",this.eventBus,t.audio);s.push(e)}if(r&&(null==t?void 0:t.video)){let e=new Er(i,r,"regular",this.eventBus,t.video);s.push(e)}return s}};function yr(e,t){return function(i){return i in e&&e[i]!==t[i]}}var Tr,Sr,kr,Er=class extends fi{constructor(e,t,i,r,n=(new Oi).build()){super(e,t,i),this.eventBus=r,this.buildNewSettings=e=>{let{width:t,height:i,codec:r,maxFramerate:n,maxBitrate:s,deviceId:a,advanced:o}=Rt(Rt({},this.settings),e);return new Ni(t,i,r,n,a,o,s)},this.handleSettingsChange=e=>_t(this,null,(function*(){let t=this.stream,i=yr(e,this.settings);i("maxBitrate")&&e.maxBitrate&&(yield t.setMaxBitrate(e.maxBitrate,this)),(i("width")||i("height")||i("advanced"))&&(yield this.nativeTrack.applyConstraints(e.toConstraints()))})),this.handleDeviceChange=(e,t=!1)=>_t(this,null,(function*(){if(yr(e,this.settings)("deviceId")&&"regular"===this.source){if(this.enabled){let t=yield this.replaceTrackWith(e);yield this.replaceSender(t,this.enabled),this.nativeTrack=t}t||tr.updateSelection("videoInput",{deviceId:e.deviceId,groupId:this.nativeTrack.getSettings().groupId})}})),e.tracks.push(this),this.settings=n,"default"===n.deviceId&&t.enabled&&(this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId})),this.pluginsManager=new class{constructor(e,t){this.pluginsLoopRunning=!1,this.pluginsLoopState="paused",this.pluginAddInProgress=!1,this.hmsTrack=e,this.pluginsMap=new Map,this.pluginNumFramesToSkip={},this.pluginNumFramesSkipped={},this.analytics=new class{constructor(e){this.eventBus=e,this.initTime={},this.preProcessingAvgs=new ar,this.addedTimestamps={},this.processingAvgs={},this.pluginAdded={},this.pluginInputFrameRate={},this.pluginFrameRate={}}added(e,t,i){this.pluginAdded[e]=!0,this.addedTimestamps[e]=Date.now(),this.initTime[e]=0,this.processingAvgs[e]=new ar,this.pluginInputFrameRate[e]=t,this.pluginFrameRate[e]=i||t}removed(e){var t;if(this.pluginAdded[e]){let i={pluginName:e,duration:Math.floor((Date.now()-this.addedTimestamps[e])/1e3),loadTime:this.initTime[e],avgPreProcessingTime:this.preProcessingAvgs.getAvg(),avgProcessingTime:null==(t=this.processingAvgs[e])?void 0:t.getAvg(),inputFrameRate:this.pluginInputFrameRate[e],pluginFrameRate:this.pluginFrameRate[e]};this.eventBus.analytics.publish(Zi.stats(i)),this.clean(e)}}failure(e,t){this.pluginAdded[e]&&(this.eventBus.analytics.publish(Zi.failure(e,t)),this.clean(e))}initWithTime(e,t){return _t(this,null,(function*(){if(this.initTime[e])return void Lt.i(or,`Plugin Already loaded ${e}, time it took: ${this.initTime[e]}`);let i;try{i=yield this.timeInMs(t),Lt.i(or,`Time taken for Plugin ${e} initialization : ${i}`)}catch(t){let i=Yt.InitFailed(Vt.VIDEO_PLUGINS,`failed during initialization of plugin${t.message||t}`);throw Lt.e(or,i),this.failure(e,i),i}i&&(this.initTime[e]=i)}))}preProcessWithTime(e){return _t(this,null,(function*(){let t=yield this.timeInMs(e);this.preProcessingAvgs.add(t)}))}processWithTime(e,t){return _t(this,null,(function*(){var i;let r;try{r=yield this.timeInMs(t)}catch(t){let i=Yt.ProcessingFailed(Vt.VIDEO_PLUGINS,`Failed during processing of plugin${t.message||t}`);throw Lt.e(or,i),this.failure(e,i),i}r&&(null==(i=this.processingAvgs[e])||i.add(r))}))}timeInMs(e){return _t(this,null,(function*(){let t=Date.now();return yield e(),Math.floor(Date.now()-t)}))}clean(e){delete this.addedTimestamps[e],delete this.initTime[e],delete this.processingAvgs[e],delete this.pluginAdded[e],delete this.pluginInputFrameRate[e],delete this.pluginFrameRate[e]}}(t),this.canvases=new Array}getPlugins(){return Array.from(this.pluginsMap.keys())}addPlugin(e,t){return _t(this,null,(function*(){var i;if(this.pluginAddInProgress){let t=null==(i=e.getName)?void 0:i.call(e);if(!t||""===t)return void Lt.w("no name provided by the plugin");let r=Yt.AddAlreadyInProgress(Vt.VIDEO_PLUGINS,"Add Plugin is already in Progress");throw this.analytics.failure(t,r),Lt.w("can't add another plugin when previous add is in progress"),r}this.pluginAddInProgress=!0;try{yield this.addPluginInternal(e,t)}finally{this.pluginAddInProgress=!1}}))}addPluginInternal(e,t){return _t(this,null,(function*(){var i,r;let n=null==(i=e.getName)?void 0:i.call(e);if(!n||""===n)return void Lt.w("no name provided by the plugin");if(this.pluginsMap.has(n))return void Lt.w(dr,`plugin - ${e.getName()} already added.`);let s=this.hmsTrack.getMediaTrackSettings().frameRate||24,a=0;t&&t>0?(Lt.i(dr,`adding plugin ${e.getName()} with framerate ${t}`),t<s&&(a=Math.ceil(s/t)-1),this.analytics.added(n,s,t)):(Lt.i(dr,`adding plugin ${e.getName()}`),this.analytics.added(n,s)),Lt.i(dr,"numFrames to skip processing",a),this.pluginNumFramesToSkip[n]=a,this.pluginNumFramesSkipped[n]=a,this.validateAndThrow(n,e);try{if(yield this.analytics.initWithTime(n,(()=>_t(this,null,(function*(){return yield e.init()})))),this.pluginsMap.set(n,e),this.pluginsMap.size+1>this.canvases.length)for(let e=this.canvases.length;e<=this.pluginsMap.size;e++)this.canvases[e]=document.createElement("canvas");yield this.startPluginsLoop(null==(r=e.getContextType)?void 0:r.call(e))}catch(t){throw Lt.e(dr,"failed to add plugin",t),yield this.removePlugin(e),t}}))}validatePlugin(e){return e.checkSupport()}validateAndThrow(e,t){let i=this.validatePlugin(t);if(i.isSupported)Lt.i(dr,`plugin is supported,- ${t.getName()}`);else{let t;switch(i.errType){case Vi.PLATFORM_NOT_SUPPORTED:throw t=Yt.PlatformNotSupported(Vt.VIDEO_PLUGINS,"platform not supported, see docs"),this.analytics.failure(e,t),t;case Vi.DEVICE_NOT_SUPPORTED:throw t=Yt.DeviceNotSupported(Vt.VIDEO_PLUGINS,"video device not supported, see docs"),this.analytics.failure(e,t),t}}}removePlugin(e){return _t(this,null,(function*(){let t=e.getName();this.pluginsMap.get(t)?(Lt.i(dr,`removing plugin ${t}`),this.removePluginEntry(t),0===this.pluginsMap.size&&(Lt.i(dr,"No plugins left, stopping plugins loop"),yield this.stopPluginsLoop()),e.stop(),this.analytics.removed(t)):Lt.w(dr,`plugin - ${t} not found to remove.`)}))}removePluginEntry(e){this.pluginsMap.delete(e),this.pluginNumFramesToSkip[e]&&delete this.pluginNumFramesToSkip[e],this.pluginNumFramesSkipped[e]&&delete this.pluginNumFramesSkipped[e]}waitForRestart(){return _t(this,null,(function*(){if(this.pluginsLoopRunning&&"running"!==this.pluginsLoopState)for(;"paused"===this.pluginsLoopState;)yield Ai(100)}))}cleanup(){return _t(this,null,(function*(){var e;for(let e of this.pluginsMap.values())yield this.removePlugin(e);null==(e=this.outputTrack)||e.stop()}))}initElementsAndStream(e){this.inputCanvas||(this.inputCanvas=document.createElement("canvas")),this.outputCanvas=document.createElement("canvas"),this.inputVideo||(this.inputVideo=document.createElement("video")),this.inputCanvas.getContext("2d"),this.outputCanvas.getContext(e||nr["2D"]);let t=this.outputCanvas.captureStream();this.outputTrack=t.getVideoTracks()[0]}startPluginsLoop(e){return _t(this,null,(function*(){if(!this.pluginsLoopRunning){this.initElementsAndStream(e),this.pluginsLoopRunning=!0;try{yield this.hmsTrack.setProcessedTrack(this.outputTrack)}catch(e){throw this.pluginsLoopRunning=!1,Lt.e(dr,"error in setting processed track",e),e}this.pluginsLoop().then((()=>{Lt.d(dr,"processLoop stopped")}))}}))}stopPluginsLoop(){return _t(this,null,(function*(){var e;this.pluginsLoopRunning=!1,yield this.hmsTrack.setProcessedTrack(void 0),this.resetCanvases(),null==(e=this.outputTrack)||e.stop(),this.inputVideo&&(this.inputVideo.srcObject=null,this.inputVideo=void 0)}))}pluginsLoop(){return _t(this,null,(function*(){for(;this.pluginsLoopRunning;){let e=this.hmsTrack.getMediaTrackSettings().frameRate||24,t=Math.floor(1e3/e);if(!this.hmsTrack.enabled||"ended"===this.hmsTrack.nativeTrack.readyState){"running"===this.pluginsLoopState&&this.resetCanvases(),this.pluginsLoopState="paused",yield Ai(t);continue}let i=0;try{yield this.analytics.preProcessWithTime((()=>_t(this,null,(function*(){return yield this.doPreProcessing()}))));let e=Date.now();yield this.processFramesThroughPlugins(),i=Math.floor(Date.now()-e),i>t&&(i=t)}catch(e){Lt.e(dr,"error in plugins loop",e)}this.pluginsLoopState="running",yield Ai(t-i)}}))}doPreProcessing(){return _t(this,null,(function*(){yield this.addTrackToVideo(),yield this.updateInputCanvas()}))}processFramesThroughPlugins(){return _t(this,null,(function*(){this.canvases[0]=this.inputCanvas;let e=0;for(let t of this.pluginsMap.values()){let i=t.getName();if(t){try{let r=this.checkIfSkipRequired(i);if(t.getPluginType()===rr.TRANSFORM){let n=(e,n)=>_t(this,null,(function*(){try{yield t.processVideoFrame(e,n,r)}catch(e){Lt.e(dr,`error in processing plugin ${i}`,e)}}));if(r)e===this.pluginsMap.size-1?yield n(this.canvases[e],this.outputCanvas):yield n(this.canvases[e],this.canvases[e+1]);else{let t=this.canvases[e],r=this.canvases[e+1];e===this.pluginsMap.size-1?yield this.analytics.processWithTime(i,(()=>_t(this,null,(function*(){return n(t,this.outputCanvas)})))):yield this.analytics.processWithTime(i,(()=>_t(this,null,(function*(){return n(t,r)}))))}}else t.getPluginType()===rr.ANALYZE&&!r&&(yield this.analytics.processWithTime(i,(()=>_t(this,null,(function*(){return yield t.processVideoFrame(this.inputCanvas)})))))}catch(e){Lt.e(dr,`error in processing plugin ${i}`,e),yield this.removePlugin(t)}e++}}}))}addTrackToVideo(){return _t(this,null,(function*(){var e;if(!this.inputVideo)return;let t=this.inputVideo.srcObject;null!==t&&t instanceof MediaStream&&(null==(e=t.getVideoTracks()[0])?void 0:e.id)===this.hmsTrack.nativeTrack.id||(this.inputVideo.pause(),this.inputVideo.srcObject=new MediaStream([this.hmsTrack.nativeTrack]),this.inputVideo.muted=!0,this.inputVideo.playsInline=!0,this.inputVideo&&(this.inputVideo.oncanplaythrough=()=>{var e;null==(e=this.inputVideo)||e.play()}))}))}updateInputCanvas(){return _t(this,null,(function*(){if(!this.inputCanvas||!this.inputVideo)return;let{width:e=lr,height:t=cr}=this.hmsTrack.getMediaTrackSettings();this.inputCanvas.height!==t&&(this.inputCanvas.height=t),this.inputCanvas.width!==e&&(this.inputCanvas.width=e),this.inputCanvas.getContext("2d").drawImage(this.inputVideo,0,0,e,t)}))}resetCanvases(){if(!this.outputCanvas||!this.inputCanvas)return;let e=this.inputCanvas.getContext("2d");e&&(e.fillStyle="rgb(0, 0, 0)",e.fillRect(0,0,this.outputCanvas.width,this.outputCanvas.height)),this.canvases=[]}checkIfSkipRequired(e){let t=!1;return this.pluginNumFramesSkipped[e]<this.pluginNumFramesToSkip[e]?(this.pluginNumFramesSkipped[e]++,t=!0):(t=!1,this.pluginNumFramesSkipped[e]=0),t}}(this,r),this.setFirstTrackId(this.trackId)}setEnabled(e){var t=e=>super[e];return _t(this,null,(function*(){if(e!==this.enabled){if("regular"===this.source){let t;t=e?yield this.replaceTrackWith(this.settings):yield this.replaceTrackWithBlank(),yield this.replaceSender(t,e),this.nativeTrack=t,e&&(yield this.pluginsManager.waitForRestart(),this.settings=this.buildNewSettings({deviceId:t.getSettings().deviceId}))}yield t("setEnabled").call(this,e),this.eventBus.localVideoEnabled.publish({enabled:e,track:this}),this.stream.trackUpdate(this)}}))}isPublishedTrackId(e){return this.publishedTrackId===e}addSink(e){this.addSinkInternal(e,this.processedTrack||this.nativeTrack)}setSettings(e,t=!1){return _t(this,null,(function*(){let i=this.buildNewSettings(e);yield this.handleDeviceChange(i,t),this.enabled?(yield this.handleSettingsChange(i),this.settings=i):this.settings=i}))}getPlugins(){return this.pluginsManager.getPlugins()}addPlugin(e,t){return _t(this,null,(function*(){return this.pluginsManager.addPlugin(e,t)}))}removePlugin(e){return _t(this,null,(function*(){return this.pluginsManager.removePlugin(e)}))}validatePlugin(e){return this.pluginsManager.validatePlugin(e)}cleanup(){var e=e=>super[e];return _t(this,null,(function*(){var t;e("cleanup").call(this),yield this.pluginsManager.cleanup(),null==(t=this.processedTrack)||t.stop()}))}setProcessedTrack(e){return _t(this,null,(function*(){if(this.nativeTrack.enabled)return e?void(e!==this.processedTrack&&(this.processedTrack?yield this.stream.replaceSenderTrack(this.processedTrack,e):yield this.stream.replaceSenderTrack(this.nativeTrack,e),this.processedTrack=e)):(this.processedTrack&&(yield this.stream.replaceSenderTrack(this.processedTrack,this.nativeTrack)),void(this.processedTrack=void 0));this.processedTrack=e}))}getTrackIDBeingSent(){return this.getTrackBeingSent().id}getTrackBeingSent(){return this.enabled&&this.processedTrack||this.nativeTrack}replaceTrackWith(e){return _t(this,null,(function*(){let t=this.nativeTrack;null==t||t.stop();let i=yield function(e){return _t(this,null,(function*(){try{return(yield navigator.mediaDevices.getUserMedia({video:!!e&&e.toConstraints()})).getVideoTracks()[0]}catch(e){throw Wi(e,Gi.VIDEO)}}))}(e);return"default"===this.settings.deviceId&&(this.settings=this.buildNewSettings({deviceId:this.nativeTrack.getSettings().deviceId})),i}))}replaceTrackWithBlank(){return _t(this,null,(function*(){let e=this.nativeTrack;return null==e||e.stop(),fr.getEmptyVideoTrack(e)}))}replaceSender(e,t){return _t(this,null,(function*(){let i=this.stream;t?yield i.replaceSenderTrack(this.nativeTrack,this.processedTrack||e):yield i.replaceSenderTrack(this.processedTrack||this.nativeTrack,e),yield i.replaceStreamTrack(this.nativeTrack,e)}))}},br=class{constructor(e){this.type=e.type,this.source=e.source||"regular",this.description="",e instanceof hi?(this.mute=!e.enabled,this.track_id=e.publishedTrackId,this.stream_id=e.stream.id):(this.mute=e.mute,this.track_id=e.track_id,this.stream_id=e.stream_id)}};!function(e){e.Disconnected="Disconnected",e.Connecting="Connecting",e.Joined="Joined",e.Preview="Preview",e.Failed="Failed",e.Reconnecting="Reconnecting",e.Leaving="Leaving"}(Tr||(Tr={})),function(e){e.FLAG_SERVER_SUB_DEGRADATION="subscribeDegradation",e.FLAG_SERVER_SIMULCAST="simulcast",e.FLAG_NON_WEBRTC_DISABLE_OFFER="nonWebRTCDisableOffer"}(Sr||(Sr={})),function(e){e[e.ConnectFailed=0]="ConnectFailed",e[e.SignalDisconnect=1]="SignalDisconnect",e[e.PublishNegotiationFailed=2]="PublishNegotiationFailed",e[e.PublishIceConnectionFailed=3]="PublishIceConnectionFailed",e[e.SubscribeIceConnectionFailed=4]="SubscribeIceConnectionFailed"}(kr||(kr={}));var Rr,Cr={0:[],1:[],2:[1],3:[1],4:[1]},Pr="[RetryScheduler]";!function(e){e.PROD="prod",e.QA="qa",e.DEV="dev"}(Rr||(Rr={}));var _r=new class{constructor(){this.TAG="[HTTPAnalyticsTransport]",this.failedEvents=new ki("client-events"),this.isConnected=!0,this.env=null}setEnv(e){this.env=e,this.flushFailedEvents()}sendEvent(e){if(!this.env)return void this.addEventToStorage(e);let t={event:e.name,payload:e.properties,event_id:String(e.timestamp),peer:e.metadata.peer,timestamp:e.timestamp,agent:Ci,device_id:e.device_id},i=this.env===Rr.PROD?"https://event.100ms.live/v2/client/report":"https://event-nonprod.100ms.live/v2/client/report";fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e.metadata.token}`},body:JSON.stringify(t)}).then((t=>{if(401!==t.status){if(200!==t.status)throw Error(t.statusText);this.removeFromStorage(e)}else this.removeFromStorage(e)})).catch((t=>{Lt.v(this.TAG,"Failed to send event",t,e),this.addEventToStorage(e)}))}flushFailedEvents(){let e=this.failedEvents.get();null==e||e.forEach((e=>this.sendEvent(e)))}addEventToStorage(e){let t=this.failedEvents.get()||[];t.find((t=>t.timestamp===e.timestamp))||(100===t.length&&t.shift(),t.push(e),this.failedEvents.set(t))}removeFromStorage(e){let t=this.failedEvents.get()||[],i=t.findIndex((t=>t.timestamp===e.timestamp));i>-1&&(t.splice(i,1),this.failedEvents.set(t))}},Ar=class extends _i{constructor(){super(100),this.localStorage=new ki("hms-analytics"),this.localStorage.clear(),this.initLocalStorageQueue()}enqueue(e){super.enqueue(e),this.localStorage.set(this.storage)}dequeue(){let e=super.dequeue();return this.localStorage.set(this.storage),e}initLocalStorageQueue(){var e;null==(e=this.localStorage.get())||e.forEach((e=>{let t=new Yi(e);super.enqueue(t)}))}},wr=(e,t,i,r)=>_t(void 0,null,(function*(){var n;let s,{peerConnectionType:a,nativeTrack:o}=(e=>{let t=e.stream instanceof hr;return{peerConnectionType:t?"publish":"subscribe",nativeTrack:t?e.getTrackBeingSent():e.nativeTrack}})(t);try{s=yield null==(n=e[a])?void 0:n.call(e,o)}catch(e){Lt.w("[HMSWebrtcStats]","Error in getting track stats",t,o,e)}let l=Ir(s),c=Nr("publish"===a?"bytesSent":"bytesReceived",l,r),d=Mr("packetsLost",l,r);return(null==l?void 0:l.remote)&&Object.assign(l.remote,{packetsLostRate:Mr("packetsLost",l.remote,null==r?void 0:r.remote)}),l&&Object.assign(l,{bitrate:c,packetsLostRate:d,peerId:t.peerId,peerName:i,codec:l.codec})})),Ir=e=>{let t,i,r={};null==e||e.forEach((e=>{switch(e.type){case"inbound-rtp":case"outbound-rtp":t=e;break;case"remote-inbound-rtp":i=e;break;case"codec":r[e.id]=e.mimeType}}));let n,s=(null==t?void 0:t.codecId)?r[t.codecId]:void 0;return s&&(n=s.substring(s.indexOf("/")+1)),t&&Object.assign(t,{remote:i,codec:n})},Dr=(e,t,i)=>{let r=Or(t),n=Nr("publish"===e?"bytesSent":"bytesReceived",r,i&&i[e]);return r&&Object.assign(r,{bitrate:n})},Or=e=>{let t;return e.forEach((i=>{"transport"===i.type&&(t=e.get(i.selectedCandidatePairId))})),t||e.forEach((e=>{"candidate-pair"===e.type&&e.selected&&(t=e)})),t},Nr=(e,t,i)=>8*Mr(e,t,i),Mr=(e,t,i)=>{let r=t&&t[e],n=i?i[e]:null;return[t,i,ei(r),ei(n)].every((e=>!!e))?1e3*Lr(r,n,null==t?void 0:t.timestamp,null==i?void 0:i.timestamp):0},Lr=(e,t,i,r)=>ei(e)&&ei(t)&&i&&r?(e-t)/(i-r):0,xr="[HMSTransport]:";function Ur(e){if(0===e.length)throw Wt.InvalidTokenFormat(Vt.INIT,"Token cannot be an empty string");let t=e.split(".");if(3!==t.length)throw Wt.InvalidTokenFormat(Vt.INIT,"Expected 3 '.' separate fields - header, payload and signature respectively");let i=atob(t[1]);try{let e=JSON.parse(i);return{roomId:e.room_id,userId:e.user_id,role:e.role}}catch(e){throw Wt.InvalidTokenFormat(Vt.INIT,`couldn't parse to json - ${e.message}`)}}var Fr={autoplayFailed:void 0,initialized:!1,autoplayCheckPromise:void 0},Gr="AnalyticsEventsService",Br=class extends gt.EventEmitter2{on(e,t){return super.on(e,t)}off(e,t){return super.off(e,t)}emit(e,t){return super.emit(e,t)}listeners(e){return super.listeners(e)}},Vr=class{constructor(e){this.audioContext=new AudioContext,this.source=this.audioContext.createMediaElementSource(e),this.source.connect(this.audioContext.destination)}resumeContext(){"suspended"===this.audioContext.state&&(Lt.d(this.TAG,"AudioContext is resumed"),this.audioContext.resume())}getAudioTrack(){return this.destinationNode&&this.source.disconnect(this.destinationNode),this.destinationNode=this.audioContext.createMediaStreamDestination(),this.source.connect(this.destinationNode),this.destinationNode.stream.getAudioTracks()[0]}cleanup(){"closed"!==this.audioContext.state&&this.audioContext.close()}get TAG(){return"AudioContextManager"}},jr=class extends Br{constructor(){super(...arguments),this.audioElement=null,this.seeked=!1}play(e){return _t(this,null,(function*(){return this.audioElement=this.getAudioElement(),new Promise(((t,i)=>{this.audioElement=this.getAudioElement(),this.audioElement.src=e,this.seeked=!1,this.audioElement.onerror=()=>{let t=`Error loading ${e}`;Lt.e(this.TAG,t),this.stop(),i(t)},this.audioElement.oncanplaythrough=()=>_t(this,null,(function*(){try{if(!this.audioElement)return;if(this.audioContextManager.resumeContext(),this.track)this.seeked?this.seeked=!1:(yield this.audioElement.play(),t([this.track]));else{yield this.audioElement.play();let e=this.audioContextManager.getAudioTrack();this.track=e,t([e])}}catch(t){Lt.e(this.TAG,"Error playing audio",e,t.message),i(t)}})),this.audioElement.onseeked=()=>{this.seeked=!0}}))}))}getTracks(){return this.track?[this.track.id]:[]}getElement(){return this.audioElement}stop(){var e,t,i;null==(e=this.audioElement)||e.pause(),null==(t=this.audioElement)||t.removeAttribute("src"),this.audioElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.track=void 0}getAudioElement(){if(this.audioElement)return this.audioElement;let e=document.createElement("audio");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(e=>this.emit("progress",e))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Vr(e),e}get TAG(){return"PlaylistAudioManager"}},Kr=class extends Br{constructor(){super(...arguments),this.videoElement=null,this.canvasContext=null,this.tracks=[],this.DEFAUL_FPS=24,this.seeked=!1,this.drawImage=()=>{var e,t,i;this.videoElement&&!this.videoElement.paused&&!this.videoElement.ended&&(null==(i=this.canvasContext)||i.drawImage(this.videoElement,0,0,null==(e=this.canvas)?void 0:e.width,null==(t=this.canvas)?void 0:t.height),this.timer=setTimeout((()=>{this.drawImage()}),1e3/this.DEFAUL_FPS))}}play(e){return this.videoElement=this.getVideoElement(),this.createCanvas(),new Promise(((t,i)=>{this.videoElement=this.getVideoElement(),this.videoElement.src=e,this.seeked=!1,this.videoElement.onerror=()=>{let t=`Error loading ${e}`;Lt.e(this.TAG,t),this.stop(),i(t)},this.videoElement.oncanplaythrough=()=>_t(this,null,(function*(){var r,n,s;try{if(!this.videoElement)return;if(this.canvas.width=this.videoElement.videoWidth,this.canvas.height=this.videoElement.videoHeight,0===this.tracks.length){this.clearCanvasAndTracks();let e=this.canvas.captureStream();if(!e)return void Lt.e(this.TAG,"Browser does not support captureStream");this.videoElement.onplay=this.drawImage,this.audioContextManager.resumeContext(),yield this.videoElement.play();let i=this.audioContextManager.getAudioTrack();e.addTrack(i),e.getTracks().forEach((e=>{this.tracks.push(e)})),t(this.tracks)}else this.seeked?(this.seeked=!1,null==(s=this.canvasContext)||s.drawImage(this.videoElement,0,0,null==(r=this.canvas)?void 0:r.width,null==(n=this.canvas)?void 0:n.height)):(yield this.videoElement.play(),t(this.tracks))}catch(t){Lt.e(this.TAG,"Error playing video",e,t.message),i(t)}})),this.videoElement.onseeked=()=>{this.seeked=!0}}))}getTracks(){return this.tracks.map((e=>e.id))}getElement(){return this.videoElement}stop(){var e,t,i;null==(e=this.videoElement)||e.pause(),null==(t=this.videoElement)||t.removeAttribute("src"),this.videoElement=null,null==(i=this.audioContextManager)||i.cleanup(),this.clearCanvasAndTracks()}clearCanvasAndTracks(){var e;this.tracks=[],null==(e=this.canvasContext)||e.clearRect(0,0,this.canvas.width,this.canvas.height),clearTimeout(this.timer)}getVideoElement(){if(this.videoElement)return this.videoElement;let e=document.createElement("video");return e.crossOrigin="anonymous",e.addEventListener("timeupdate",(e=>this.emit("progress",e))),e.addEventListener("ended",(()=>{this.emit("ended",null)})),this.audioContextManager=new Vr(e),e}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvasContext=this.canvas.getContext("2d"))}get TAG(){return"PlaylistVideoManager"}},$r={list:[],currentIndex:-1,isAutoplayOn:!0},Hr={list:[],currentIndex:-1,isAutoplayOn:!0},Wr=class extends Br{constructor(e,t){super(),this.sdk=e,this.eventBus=t,this.state={audio:Rt({},$r),video:Rt({},Hr)},this.handlePausePlaylist=e=>_t(this,[e],(function*({enabled:e,track:t}){var i;if(e)return;let r;"audioplaylist"===t.source&&(r=Ft.audio),"videoplaylist"===t.source&&(r=Ft.video),r&&(null==(i=this.getElement(r))||i.pause())})),this.addTrack=(e,t)=>_t(this,null,(function*(){yield this.sdk.addTrack(e,t),Lt.d(this.TAG,"Playlist track added",e)})),this.removeTrack=e=>_t(this,null,(function*(){yield this.sdk.removeTrack(e),Lt.d(this.TAG,"Playlist track removed",e)})),this.audioManager=new jr,this.videoManager=new Kr,this.addListeners()}getList(e=Ft.audio){return this.state[e].list}setList(e){e&&0!==e.length?e.forEach((e=>{this.state[e.type].list.includes(e)||this.state[e.type].list.push(e)})):Lt.w(this.TAG,"Please pass in a list of HMSPlaylistItem's")}clearList(e){return _t(this,null,(function*(){this.isPlaying(e)&&(yield this.stop(e)),this.state[e].list=[]}))}removeItem(e,t){return _t(this,null,(function*(){let{list:i,currentIndex:r}=this.state[t],n=i.findIndex((t=>e===t.id));return n>-1&&(r===n&&this.isPlaying(t)&&(yield this.stop(t)),i.splice(n,1),!0)}))}seek(e,t=Ft.audio){let{currentIndex:i}=this.state[t];if(-1===i)throw Zt.NoEntryToPlay(Vt.PLAYLIST,"No item is currently playing");let r=this.getElement(t);if(r){let t=Math.max(r.currentTime+e,0);r.currentTime=Math.min(t,r.duration)}}seekTo(e,t=Ft.audio){let{currentIndex:i}=this.state[t];if(-1===i)throw Zt.NoEntryToPlay(Vt.PLAYLIST,"No item is currently playing");if(e<0)throw Error("value cannot be negative");let r=this.getElement(t);r&&(r.currentTime=Math.min(e,r.duration))}setVolume(e,t=Ft.audio){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");let i=this.getElement(t);i&&(i.volume=.01*e)}getVolume(e=Ft.audio){let t=this.getElement(e);return t?100*t.volume:0}getCurrentTime(e=Ft.audio){let t=this.getElement(e);return(null==t?void 0:t.currentTime)||0}getCurrentIndex(e=Ft.audio){return this.state[e].currentIndex}getCurrentProgress(e=Ft.audio){var t;let{list:i,currentIndex:r}=this.state[e],n=null==(t=i[r])?void 0:t.url,s=this.getElement(e);return n&&s?Math.floor(s.currentTime/s.duration*100):0}getCurrentSelection(e=Ft.audio){let{list:t,currentIndex:i}=this.state[e];if(-1!==i)return t[i]}isPlaying(e=Ft.audio){let t=this.getElement(e);return!!t&&!t.paused}setIsAutoplayOn(e=Ft.audio,t){this.state[e].isAutoplayOn=t}getPlaybackRate(e=Ft.audio){let t=this.getElement(e);return t?t.playbackRate:1}setPlaybackRate(e=Ft.audio,t){if(t<.25||t>2)throw Error("Please pass a value between 0.25 and 2.0");let i=this.getElement(e);i&&(i.playbackRate=t)}setEnabled(e,t){return _t(this,arguments,(function*(e,{id:t,type:i=Ft.audio}){let r=this.state[i].list.findIndex((e=>e.id===t));if(!t||-1===r)return void Lt.w(this.TAG,"Pass a valid id");let n=this.state[i].list[r].url;e?yield this.play(n,i):yield this.pause(n,i),this.state[i].currentIndex=r,this.setDuration(i)}))}playNext(){return _t(this,arguments,(function*(e=Ft.audio){let{list:t,currentIndex:i}=this.state[e];if(i>=t.length-1)throw Zt.NoEntryToPlay(Vt.PLAYLIST,"Reached end of playlist");yield this.play(t[i+1].url,e),this.state[e].currentIndex=i+1,this.setDuration(e)}))}playPrevious(){return _t(this,arguments,(function*(e=Ft.audio){let{list:t,currentIndex:i}=this.state[e];if(i<=0)throw Zt.NoEntryToPlay(Vt.PLAYLIST,"Reached start of playlist");yield this.play(t[i-1].url,e),this.state[e].currentIndex=i-1,this.setDuration(e)}))}stop(){return _t(this,arguments,(function*(e=Ft.audio){var t;let i=e===Ft.audio?this.audioManager:this.videoManager;null==(t=i.getElement())||t.pause(),yield this.removeTracks(e),i.stop(),this.state[e].currentIndex=-1}))}cleanup(){this.state={audio:Rt({},$r),video:Rt({},Hr)},this.eventBus.localAudioEnabled.unsubscribe(this.handlePausePlaylist),this.eventBus.localVideoEnabled.unsubscribe(this.handlePausePlaylist),this.audioManager.stop(),this.videoManager.stop()}onProgress(e){this.videoManager.on("progress",(()=>{try{e({type:Ft.video,progress:this.getCurrentProgress(Ft.video)})}catch(e){Lt.e(this.TAG,"Error in onProgress callback")}})),this.audioManager.on("progress",(()=>{try{e({type:Ft.audio,progress:this.getCurrentProgress(Ft.audio)})}catch(e){Lt.e(this.TAG,"Error in onProgress callback")}}))}onNewTrackStart(e){this.on("newTrackStart",e)}onPlaylistEnded(e){this.on("playlistEnded",e)}onCurrentTrackEnded(e){this.on("currentTrackEnded",e)}getElement(e=Ft.audio){return e===Ft.audio?this.audioManager.getElement():this.videoManager.getElement()}removeTracks(){return _t(this,arguments,(function*(e=Ft.audio){let t=(e===Ft.audio?this.audioManager:this.videoManager).getTracks();for(let e of t)yield this.removeTrack(e)}))}play(e){return _t(this,arguments,(function*(e,t=Ft.audio){let i=t===Ft.audio?this.audioManager:this.videoManager,r=i.getElement();if(this.isItemCurrentlyPlaying(e,t))Lt.w(this.TAG,`The ${t} is currently playing`);else if(null==r?void 0:r.src.includes(e))yield r.play();else{null==r||r.pause();let n=yield i.play(e);for(let e of n)yield this.addTrack(e,t===Ft.audio?"audioplaylist":"videoplaylist")}}))}isItemCurrentlyPlaying(e,t){let i=this.getElement(t);return!(!i||i.paused||!i.src.includes(e))}setDuration(e=Ft.audio){let t=this.getElement(e),{list:i,currentIndex:r}=this.state[e];i[r]&&(i[r].duration=(null==t?void 0:t.duration)||0),this.emit("newTrackStart",i[r])}pause(e){return _t(this,arguments,(function*(e,t=Ft.audio){let i=this.getElement(t);i&&!i.paused&&i.src.includes(e)?(i.pause(),Lt.d(this.TAG,"paused url",e)):Lt.w(this.TAG,"The passed in url is not currently playing")}))}addListeners(){this.audioManager.on("ended",(()=>this.handleEnded(Ft.audio))),this.videoManager.on("ended",(()=>this.handleEnded(Ft.video))),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist),this.eventBus.localAudioEnabled.subscribe(this.handlePausePlaylist)}handleEnded(){return _t(this,arguments,(function*(e=Ft.audio){let{list:t,currentIndex:i,isAutoplayOn:r}=this.state[e];i===t.length-1?(yield this.stop(e),this.emit("playlistEnded",e)):r?this.playNext(e):yield this.pause(t[i].url,e),this.emit("currentTrackEnded",t[i])}))}get TAG(){return"PlaylistManager"}},Jr=class{constructor(e,t){this.eventName=e,this.eventEmitter=t,this.publish=e=>{this.eventEmitter.emit(this.eventName,e)},this.subscribe=e=>{this.eventEmitter.on(this.eventName,e)},this.subscribeOnce=e=>{this.eventEmitter.once(this.eventName,e)},this.unsubscribe=e=>{this.eventEmitter.off(this.eventName,e)},this.waitFor=e=>this.eventEmitter.waitFor(this.eventName,{filter:e}),this.removeAllListeners=()=>{this.eventEmitter.removeAllListeners(this.eventName)}}},qr={isAudioMuted:!1,isVideoMuted:!1,audioInputDeviceId:"default",audioOutputDeviceId:"default",videoDeviceId:"default"},zr={published:!1,isInitialised:!1,isReconnecting:!1,isPreviewInProgress:!1,deviceManagersInitialised:!1};function Qr(e,t){return e===t}function Yr(e,t,i){if(null===t||null===i||t.length!==i.length)return!1;for(var r=t.length,n=0;n<r;n++)if(!e(t[n],i[n]))return!1;return!0}function Zr(e){var t=Array.isArray(e[0])?e[0]:e;if(!t.every((function(e){return"function"==typeof e}))){var i=t.map((function(e){return typeof e})).join(", ");throw new Error("Selector creators expect all input-selectors to be functions, instead received the following types: ["+i+"]")}return t}Lt.i("adapter",`${nt.browserDetails.browser} v${nt.browserDetails.version}`);var Xr,en=function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];var s=0,a=r.pop(),o=Zr(r),l=e.apply(void 0,[function(){return s++,a.apply(null,arguments)}].concat(i)),c=e((function(){for(var e=[],t=o.length,i=0;i<t;i++)e.push(o[i].apply(null,arguments));return l.apply(null,e)}));return c.resultFunc=a,c.dependencies=o,c.recomputations=function(){return s},c.resetRecomputations=function(){return s=0},c}}((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Qr,i=null,r=null;return function(){return Yr(t,i,arguments)||(r=e.apply(null,arguments)),i=arguments,r}})),tn=Object.defineProperty,rn=Object.defineProperties,nn=Object.getOwnPropertyDescriptors,sn=Object.getOwnPropertySymbols,an=Object.prototype.hasOwnProperty,on=Object.prototype.propertyIsEnumerable,ln=(e,t,i)=>t in e?tn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,cn=(e,t)=>{for(var i in t||(t={}))an.call(t,i)&&ln(e,i,t[i]);if(sn)for(var i of sn(t))on.call(t,i)&&ln(e,i,t[i]);return e},dn=(e,t)=>rn(e,nn(t)),un=(e,t,i)=>new Promise(((r,n)=>{var s=e=>{try{o(i.next(e))}catch(e){n(e)}},a=e=>{try{o(i.throw(e))}catch(e){n(e)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(s,a);o((i=i.apply(e,t)).next())}));!function(e){e.Disconnected="Disconnected",e.Preview="Preview",e.Connecting="Connecting",e.Connected="Connected",e.Reconnecting="Reconnecting",e.Disconnecting="Disconnecting",e.Failed="Failed"}(Xr||(Xr={}));var hn,pn,vn,mn,gn=()=>({room:{id:"",isConnected:!1,name:"",peers:[],shareableLink:"",localPeer:"",hasWaitingRoom:!1,roomState:Xr.Disconnected,recording:{browser:{running:!1},server:{running:!1},hls:{running:!1}},rtmp:{running:!1},hls:{running:!1,variants:[]},sessionId:""},peers:{},tracks:{},playlist:{audio:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1},video:{list:{},selection:{id:"",hasPrevious:!1,hasNext:!1},progress:0,volume:0,currentTime:0,playbackRate:1}},messages:{byID:{},allIDs:[]},speakers:{},connectionQualities:{},settings:{audioInputDeviceId:"",audioOutputDeviceId:"",videoInputDeviceId:""},devices:{audioInput:[],audioOutput:[],videoInput:[]},roles:{},roleChangeRequests:[],errors:[]}),fn=()=>({peerStats:{},trackStats:{},localPeer:{id:""}});!function(e){e.CHAT="chat"}(hn||(hn={})),function(e){e.INFO="info",e.ERROR="error",e.CRITICAL="critical"}(pn||(pn={})),function(e){e.PEER_JOINED="PEER_JOINED",e.PEER_LEFT="PEER_LEFT",e.PEER_LIST="PEER_LIST",e.NEW_MESSAGE="NEW_MESSAGE",e.ERROR="ERROR",e.RECONNECTING="RECONNECTING",e.RECONNECTED="RECONNECTED",e.TRACK_ADDED="TRACK_ADDED",e.TRACK_REMOVED="TRACK_REMOVED",e.TRACK_MUTED="TRACK_MUTED",e.TRACK_UNMUTED="TRACK_UNMUTED",e.TRACK_DEGRADED="TRACK_DEGRADED",e.TRACK_RESTORED="TRACK_RESTORED",e.ROLE_CHANGE_REQUEST="ROLE_CHANGE_REQUEST",e.ROLE_UPDATED="ROLE_UPDATED",e.CHANGE_TRACK_STATE_REQUEST="CHANGE_TRACK_STATE_REQUEST",e.CHANGE_MULTI_TRACK_STATE_REQUEST="CHANGE_MULTI_TRACK_STATE_REQUEST",e.ROOM_ENDED="ROOM_ENDED",e.REMOVED_FROM_ROOM="REMOVED_FROM_ROOM",e.DEVICE_CHANGE_UPDATE="DEVICE_CHANGE_UPDATE",e.PLAYLIST_TRACK_ENDED="PLAYLIST_TRACK_ENDED",e.NAME_UPDATED="NAME_UPDATED",e.METADATA_UPDATED="METADATA_UPDATED"}(vn||(vn={})),function(e){e.audio="audio",e.video="video"}(mn||(mn={}));var yn=(e,t)=>{let i=Rn(Object.keys(e),Object.keys(t));for(let r of i){let i=e[r],n=t[r];Sn(i,n)?Object.assign(i,n):kn(i,n)?delete e[r]:En(i,n)&&(e[r]=n)}},Tn=(e,t)=>{e.plugins&&bn(e.plugins,t.plugins)&&(t.plugins=e.plugins),e.layerDefinitions&&bn(e.layerDefinitions,t.layerDefinitions)&&(t.layerDefinitions=e.layerDefinitions)},Sn=(e,t)=>e&&t,kn=(e,t)=>e&&!t,En=(e,t)=>!e&&t,bn=(e,t)=>{if(e===t||0===e.length&&0===(null==t?void 0:t.length))return!0;if(!e||!t||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==t[i])return!1;return!0},Rn=(e,t)=>{let i=new Set;for(let t of e)i.add(t);for(let e of t)i.add(e);return Array.from(i)},Cn=class{static convertPeer(e){var t,i,r;return{id:e.peerId,name:e.name,roleName:null==(t=e.role)?void 0:t.name,isLocal:e.isLocal,videoTrack:null==(i=e.videoTrack)?void 0:i.trackId,audioTrack:null==(r=e.audioTrack)?void 0:r.trackId,auxiliaryTracks:e.auxiliaryTracks.map((e=>e.trackId)),customerUserId:e.customerUserId,customerDescription:e.metadata,metadata:e.metadata,joinedAt:e.joinedAt}}static convertTrack(e,t){let i={id:e.trackId,source:e.source,type:e.type,enabled:e.enabled,displayEnabled:e.enabled,peerId:e.peerId||t};return this.enrichTrack(i,e),i}static enrichTrack(e,t){let i=t.getMediaTrackSettings();"screen"===e.source&&"video"===e.type&&(e.displaySurface=i.displaySurface),e.height=i.height,e.width=i.width,t instanceof gi&&(e.volume=t.getVolume()||0),Cn.updateDeviceID(e,t),Cn.enrichVideoTrack(e,t),Cn.enrichPluginsDetails(e,t)}static updateDeviceID(e,t){var i;e.deviceID=t instanceof Er||t instanceof sr?t.settings.deviceId:null==(i=t.getMediaTrackSettings())?void 0:i.deviceId}static enrichVideoTrack(e,t){t instanceof yi&&(e.layer=t.getSimulcastLayer(),e.degraded=t.degraded,bn(t.getSimulcastDefinitions(),e.layerDefinitions)||(e.layerDefinitions=t.getSimulcastDefinitions()))}static enrichPluginsDetails(e,t){(t instanceof Er||t instanceof sr)&&(bn(t.getPlugins(),e.plugins)||(e.plugins=t.getPlugins()))}static convertRoom(e){var t,i;let{recording:r,rtmp:n,hls:s}=Cn.convertRecordingStreamingState(null==e?void 0:e.recording,null==e?void 0:e.rtmp,null==e?void 0:e.hls);return{id:e.id,name:e.name,localPeer:null!=(i=null==(t=e.localPeer)?void 0:t.peerId)?i:"",hasWaitingRoom:e.hasWaitingRoom,shareableLink:e.shareableLink,recording:r,rtmp:n,hls:s,sessionId:e.sessionId,startedAt:e.startedAt,joinedAt:e.joinedAt,peerCount:e.peerCount}}static convertMessage(e){var t,i,r,n,s,a,o;return{sender:null==(t=e.sender)?void 0:t.peerId,senderName:null==(i=e.sender)?void 0:i.name,senderRole:null==(n=null==(r=e.sender)?void 0:r.role)?void 0:n.name,senderUserId:null==(s=e.sender)?void 0:s.customerUserId,recipientPeer:null==(a=e.recipientPeer)?void 0:a.peerId,recipientRoles:null==(o=e.recipientRoles)?void 0:o.map((e=>e.name)),time:e.time,type:e.type,message:e.message}}static convertRoles(e){let t={};return e&&e.forEach((e=>{t[e.name]=e})),t}static convertRoleChangeRequest(e){var t;return{requestedBy:null==(t=e.requestedBy)?void 0:t.peerId,roleName:e.role.name,token:e.token}}static convertException(e){return{code:e.code,action:e.action,name:e.name,message:e.message,description:e.description,isTerminal:e.isTerminal,nativeError:e.nativeError,timestamp:new Date}}static convertDeviceChangeUpdate(e){let t={devices:e.devices,selection:e.selection,type:e.type};return e.error&&(t.error=this.convertException(e.error)),t}static convertPlaylist(e){return{audio:this.getConvertedPlaylistType(e,mn.audio),video:this.getConvertedPlaylistType(e,mn.video)}}static convertPlaylistItem(e,t){let i=t.type,r=e.getCurrentSelection(i),n=e.isPlaying(i),s=t.url===(null==r?void 0:r.url);return dn(cn({},t),{type:t.type,selected:s,playing:s&&n})}static getConvertedPlaylistType(e,t){let i={},r=e.getCurrentSelection(t),n=e.getCurrentProgress(t),s=e.getVolume(t),a=e.getList(t),o=e.getCurrentIndex(t);return e.getList(t).forEach((t=>{i[t.id]=Cn.convertPlaylistItem(e,t)})),{list:i,selection:{id:null==r?void 0:r.id,hasPrevious:o>0,hasNext:o<a.length-1},progress:n,volume:s,currentTime:e.getCurrentTime(t),playbackRate:e.getPlaybackRate(t)}}static convertRecordingStreamingState(e,t,i){var r;return{recording:{browser:cn({running:!1},null==e?void 0:e.browser),server:cn({running:!1},null==e?void 0:e.server),hls:cn({running:!1},null==e?void 0:e.hls)},rtmp:cn({running:!1},t),hls:{variants:(null==(r=null==i?void 0:i.variants)?void 0:r.map((e=>e)))||[],running:!!(null==i?void 0:i.running),error:null==i?void 0:i.error}}}};function Pn(e,t,i=wn){let r,n;if(t)for(let s of t.auxiliaryTracks){let t=e[s];i(t)&&(n=_n(t)?t:n,r=An(t)?t:r)}return{video:r,audio:n}}function _n(e){return e&&"audio"===e.type}function An(e){return e&&"video"===e.type}function wn(e){return e&&"screen"===e.source}function In(e){return e&&"audioplaylist"===e.source}function Dn(e){return e&&"videoplaylist"===e.source}function On(e){return Boolean(null==e?void 0:e.degraded)}function Nn(e,t){return!(!t||!e.tracks[t])&&e.tracks[t].enabled}var Mn=e=>e.room,Ln=(en(Mn,(e=>e.id)),e=>e.peers),xn=e=>e.messages.byID,Un=e=>e.messages.allIDs,Fn=e=>e.tracks,Gn=e=>e.settings,Bn=e=>e.devices,Vn=en([Mn],(e=>e&&e.isConnected)),jn=(en([Vn,Mn],((e,t)=>e?void 0!==t.peerCount?t.peerCount||1:t.peers.length:Math.max(void 0!==t.peerCount?t.peerCount:t.peers.length-1,0))),en([Mn,Ln],((e,t)=>e.peers.map((e=>t[e]))))),Kn=en(Fn,(e=>Object.values(e))),$n=en(Mn,Ln,((e,t)=>t[e.localPeer])),Hn=en(Mn,(e=>e.localPeer)),Wn=(en($n,(e=>null==e?void 0:e.name)),en($n,(e=>null==e?void 0:e.roleName)),en($n,(e=>null==e?void 0:e.audioTrack))),Jn=en($n,(e=>null==e?void 0:e.videoTrack)),qn=en($n,(e=>null==e?void 0:e.auxiliaryTracks)),zn=en([Wn,Jn,qn],((e,t,i)=>{let r=[...i];return e&&r.unshift(e),t&&r.unshift(t),r})),Qn=(en(jn,(e=>e.filter((e=>!e.isLocal)))),en(Ln,(e=>e.speakers),((e,t)=>{let i=Object.entries(t).sort(((e,t)=>{var i,r;let n=(null==(i=e[1])?void 0:i.audioLevel)||0;return((null==(r=t[1])?void 0:r.audioLevel)||0)>n?1:-1}));if(i.length>0&&i[0][1].audioLevel&&i[0][1].audioLevel>0){let t=i[0][1].peerID;if(t in e)return e[t]}return null})),e=>{let t=$n(e);return Nn(e,null==t?void 0:t.audioTrack)}),Yn=e=>{let t=$n(e);return Nn(e,null==t?void 0:t.videoTrack)},Zn=e=>{let t=$n(e);return function(e,t){return!(!t||!e.tracks[t])&&e.tracks[t].displayEnabled}(e,null==t?void 0:t.videoTrack)},Xn=en($n,Fn,((e,t)=>{let{video:i,audio:r}=Pn(t,e);return!(!i&&!r)})),es=en(Ln,Fn,((e,t)=>{let i;for(let r in e){let n=e[r],{video:s,audio:a}=Pn(t,n);if(s)return n;a&&!i&&(i=n)}return i})),ts=(en(es,(e=>!!e)),en(Ln,Fn,((e,t)=>{for(let i in e){let r=e[i],{audio:n,video:s}=Pn(t,r);if(!s&&n)return r}})),en(Ln,Fn,((e,t)=>{let i=[],r=[];for(let n in e){let s=e[n],{video:a,audio:o}=Pn(t,s);a?i.push(s):o&&r.push(s)}return i.concat(r)})),en(Ln,Fn,((e,t)=>{for(let i in t){let r=t[i];if(Dn(r)&&An(r)&&r.peerId)return e[r.peerId]}})),en(Ln,Fn,((e,t)=>{for(let i in t){let r=t[i];if(In(r)&&r.peerId)return e[r.peerId]}})),en(Kn,(e=>e.filter(On))),en(Un,(e=>e.length))),is=(en(xn,(e=>Object.values(e).filter((e=>!e.read)).length)),en(Un,xn,((e,t)=>{let i=[];return e.forEach((e=>{i.push(t[e])})),i}))),rs=en([Mn],(e=>e&&e.roomState)),ns=(en(rs,(e=>e===Xr.Preview)),en(Mn,(e=>e.roomState!==Xr.Disconnected))),ss=e=>e.roles,as=(en([ss],(e=>Object.keys(e))),en([$n,ss],((e,t)=>(null==e?void 0:e.roleName)?t[e.roleName]:null))),os=(en([as],(e=>{var t;return!!(null==(t=null==e?void 0:e.subscribeParams)?void 0:t.subscribeToRoles)&&e.subscribeParams.subscribeToRoles.length>0})),en(as,(e=>null==e?void 0:e.permissions))),ls=(en(Mn,(e=>e.recording)),en(Mn,(e=>e.rtmp)),en(Mn,(e=>e.hls)),en(Mn,(e=>e.sessionId)),en(Mn,(e=>e.startedAt)),(e=mn.audio)=>t=>t.playlist[e].list),cs=(e=mn.audio)=>t=>t.playlist[e].selection,ds=(e=mn.audio)=>t=>t.playlist[e].progress,us=(e=mn.audio)=>t=>t.playlist[e].currentTime,hs=(e=mn.audio)=>t=>t.playlist[e].playbackRate,ps=(e=mn.audio)=>t=>t.playlist[e].volume,vs=(e=mn.audio)=>en(ls(e),(e=>Object.values(e))),ms=(e=mn.audio)=>en(ls(e),cs(e),((e,t)=>{if(t.id)return e[t.id]})),gs={selection:cs(mn.audio),progress:ds(mn.audio),currentTime:us(mn.audio),playbackRate:hs(mn.audio),volume:ps(mn.audio),list:vs(mn.audio),selectedItem:ms(mn.audio)},fs={selection:cs(mn.video),progress:ds(mn.video),currentTime:us(mn.video),playbackRate:hs(mn.video),volume:ps(mn.video),list:vs(mn.video),selectedItem:ms(mn.video)};function ys(e){return t=>i=>e(i,t)}var Ts="HMS-Store:",Ss=class{static v(e,...t){this.log(mt.VERBOSE,e,...t)}static d(...e){this.log(mt.DEBUG,...e)}static i(...e){this.log(mt.INFO,...e)}static w(...e){this.log(mt.WARN,...e)}static e(...e){this.log(mt.ERROR,...e)}static time(e){this.log(mt.TIME,"[HMSPerformanceTiming]",e)}static timeEnd(e){this.log(mt.TIMEEND,"[HMSPerformanceTiming]",e,e)}static cleanUp(){performance.clearMarks(),performance.clearMeasures()}static log(e,...t){if(!(this.level.valueOf()>e.valueOf()))switch(e){case mt.VERBOSE:console.log(Ts,...t);break;case mt.DEBUG:console.debug(Ts,...t);break;case mt.INFO:console.info(Ts,...t);break;case mt.WARN:console.warn(Ts,...t);break;case mt.ERROR:console.error(Ts,...t);break;case mt.TIME:performance.mark(t[1]);break;case mt.TIMEEND:{let e=t[0],i=t[1];try{let t=performance.measure(i,i);this.log(mt.DEBUG,e,i,null==t?void 0:t.duration),performance.clearMarks(i),performance.clearMeasures(i)}catch(t){this.log(mt.DEBUG,e,i,t)}break}}}};Ss.level=mt.VERBOSE;var ks=(e,t)=>t,Es=(e,t)=>t,bs=en([Ln,ks],((e,t)=>t?e[t]:null)),Rs=en([Fn,(e,t)=>t],((e,t)=>t?e[t]:null)),Cs=ys(bs),Ps=(ys(en([e=>e.appData,(e,t)=>t],((e,t)=>e?t?e[t]:e:{}))),ys(en(bs,(e=>null==e?void 0:e.name))),ys(Rs)),_s=(ys(((e,t)=>{let i=bs(e,t);if(i&&i.videoTrack&&""!==i.videoTrack)return e.tracks[i.videoTrack]})),ys(((e,t)=>{let i=bs(e,t);if(i&&i.audioTrack&&""!==i.audioTrack)return e.tracks[i.audioTrack]}))),As=(ys(((e,t)=>{let i=bs(e,t);return(null==i?void 0:i.auxiliaryTracks.map((t=>e.tracks[t])))||[]})),(e,t)=>t?e.speakers[t]:null),ws=(ys(en(As,(e=>(null==e?void 0:e.audioLevel)||0))),ys(en(((e,t)=>{let i=_s(t)(e);return As(e,null==i?void 0:i.id)}),(e=>(null==e?void 0:e.audioLevel)||0))),ys(((e,t)=>{if(t)return e.connectionQualities[t]})),ys(((e,t)=>{let i=bs(e,t);if(i){let t=null==i?void 0:i.auxiliaryTracks.find((t=>_n(e.tracks[t])));return t?e.tracks[t]:void 0}})),ys(en(Fn,bs,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return Dn(i)&&An(i)}));return i?e[i]:void 0}))),ys(en(Fn,bs,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return Dn(i)&&_n(i)}));return i?e[i]:void 0}))),ys(en(Fn,bs,((e,t)=>{let i=null==t?void 0:t.auxiliaryTracks.find((t=>{let i=e[t];return In(i)&&_n(i)}));return i?e[i]:void 0}))),ys(en(Fn,bs,((e,t)=>Pn(e,t))))),Is=e=>en(ws(e),(e=>e.audio)),Ds=ys(((e,t)=>{let i=bs(e,t);return Nn(e,null==i?void 0:i.audioTrack)})),Os=ys(((e,t)=>{let i=bs(e,t);return Nn(e,null==i?void 0:i.videoTrack)})),Ns=ys(((e,t)=>{if(t&&e.tracks[t])return 0===e.tracks[t].volume})),Ms=(ys(((e,t)=>{let i=bs(e,t);return Ns(null==i?void 0:i.audioTrack)(e)})),ys(((e,t)=>{let i=Is(t)(e);return Ns(null==i?void 0:i.id)(e)})),ys(((e,t)=>{let i=Rs(e,t);if(i)return"audio"!==i.type?void Ss.w("Please pass audio track here"):i.volume}))),Ls=(ys(((e,t)=>{let i=bs(e,t);return Ms(null==i?void 0:i.audioTrack)(e)})),ys(((e,t)=>{let i=Is(t)(e);return Ms(null==i?void 0:i.id)(e)})),ys(((e,t)=>{let i=Rs(e,t);if(i)return"video"!==i.type?void Ss.w("Please pass video track here"):i.layer})),en([is,Hn,ks],((e,t,i)=>{if(i)return e.filter((e=>{var r;return!(!e.recipientPeer&&!(null==(r=e.recipientRoles)?void 0:r.length)||e.sender&&![t,i].includes(e.sender))&&[t,i].includes(e.recipientPeer)}))}))),xs=en([is,Es],((e,t)=>{if(t)return e.filter((e=>{var i,r;return!!(null==(i=e.recipientRoles)?void 0:i.length)&&(null==(r=e.recipientRoles)?void 0:r.includes(t))}))})),Us=en(is,(e=>e.filter((e=>{var t;return!e.recipientPeer&&!(null==(t=e.recipientRoles)?void 0:t.length)})))),Fs=en([xs,Es],(e=>e?e.filter((e=>!e.read)).length:0)),Gs=en([Ls,ks],(e=>e?e.filter((e=>!e.read)).length:0)),Bs=(en(Us,(e=>e.filter((e=>!e.read)).length)),ys(Ls),ys(xs),ys(Fs),ys(Gs),en([Ln,Fn],((e,t)=>Object.values(e).map((e=>{var i;return{peer:e,isAudioEnabled:!!e.audioTrack&&(null==(i=t[e.audioTrack])?void 0:i.enabled)}})))),en([e=>e.roleChangeRequests[0]||null,Ln,ss],((e,t,i)=>e?{requestedBy:e.requestedBy?t[e.requestedBy]:void 0,role:i[e.roleName],token:e.token}:null)));en([as],(e=>{var t;let i=!1,r=!1,n=!1;return(null==(t=null==e?void 0:e.publishParams)?void 0:t.allowed)&&(i=e.publishParams.allowed.includes("video"),r=e.publishParams.allowed.includes("audio"),n=e.publishParams.allowed.includes("screen")),{video:i,audio:r,screen:n}})),en([Jn,Fn],((e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]})),en([Wn,Fn],((e,t)=>{let i=null;return e&&(i=t[e]),(null==i?void 0:i.plugins)||[]}));var Vs=class{constructor(e,t,i,r){this.playlistManager=e,this.syncPlaylistState=i,this.store=r,this.type=t}play(e){return un(this,null,(function*(){e?yield this.playlistManager.setEnabled(!0,{id:e,type:this.type}):Ss.w("Please pass id to play")}))}pause(){return un(this,null,(function*(){let e=this.type===mn.audio?gs:fs,t=this.store.getState(e.selection);t.id?yield this.playlistManager.setEnabled(!1,{id:t.id,type:this.type}):Ss.w("No item is currently playing to pause")}))}playNext(){return un(this,null,(function*(){yield this.playlistManager.playNext(this.type)}))}playPrevious(){return un(this,null,(function*(){yield this.playlistManager.playPrevious(this.type)}))}seek(e){this.playlistManager.seek(e,this.type),this.syncPlaylistState(`seekOn${this.type}Playlist`)}seekTo(e){this.playlistManager.seekTo(e,this.type),this.syncPlaylistState(`seekToOn${this.type}Playlist`)}setVolume(e){this.playlistManager.setVolume(e,this.type),this.syncPlaylistState(`setVolumeOn${this.type}Playlist`)}setList(e){this.playlistManager.setList(e),this.syncPlaylistState(`setListOn${this.type}Playlist`)}stop(){return un(this,null,(function*(){yield this.playlistManager.stop(this.type),this.syncPlaylistState(`stop${this.type}Playlist`)}))}setIsAutoplayOn(e){this.playlistManager.setIsAutoplayOn(this.type,e)}setPlaybackRate(e){this.playlistManager.setPlaybackRate(this.type,e),this.syncPlaylistState(`set${this.type}PlaybackRate`)}removeItem(e){return un(this,null,(function*(){let t=yield this.playlistManager.removeItem(e,this.type);return t&&this.syncPlaylistState(`remove${this.type}PlaylistItem`),t}))}clearList(){return un(this,null,(function*(){yield this.playlistManager.clearList(this.type),this.syncPlaylistState(`clear${this.type}Playlist`)}))}},js={[wt.PEER_JOINED]:vn.PEER_JOINED,[wt.PEER_LEFT]:vn.PEER_LEFT,[wt.ROLE_UPDATED]:vn.ROLE_UPDATED,[wt.AUDIO_TOGGLED]:"PEER_AUDIO_UPDATED",[wt.VIDEO_TOGGLED]:"PEER_VIDEO_UPDATED",[wt.NAME_UPDATED]:vn.NAME_UPDATED,[wt.METADATA_UPDATED]:vn.METADATA_UPDATED},Ks={[It.TRACK_ADDED]:vn.TRACK_ADDED,[It.TRACK_REMOVED]:vn.TRACK_REMOVED,[It.TRACK_MUTED]:vn.TRACK_MUTED,[It.TRACK_UNMUTED]:vn.TRACK_UNMUTED,[It.TRACK_DEGRADED]:vn.TRACK_DEGRADED,[It.TRACK_RESTORED]:vn.TRACK_RESTORED},$s={[wt.PEER_JOINED]:"peerJoined",[wt.PEER_LEFT]:"peerLeft",[wt.NAME_UPDATED]:"peerNameUpdated",[wt.ROLE_UPDATED]:"peerRoleUpdated",[wt.METADATA_UPDATED]:"peerMetadataUpdated"},Hs="hmsNotification",Ws=e=>Ri?`${e} ${document.title}`:e,Js=(e,t,i)=>{var r,n;let s=qs(i,t);null==(r=e.getWebrtcInternals())||r.start();let a=null==(n=e.getWebrtcInternals())?void 0:n.onStatsChange((e=>zs(t,e,i)));return()=>{s(),a&&a()}},qs=(e,t)=>{let i,r,n;return e.getState(Hn)?t.namedSetState((t=>{t.localPeer.id=e.getState(Hn)}),"localpeer-id"):i=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.id=e}),"localpeer-id")}),Hn),e.getState(Jn)?t.namedSetState((t=>{t.localPeer.videoTrack=e.getState(Jn)}),"localpeer-videotrack-id"):r=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.videoTrack=e}),"localpeer-videotrack-id")}),Jn),e.getState(Wn)?t.namedSetState((t=>{t.localPeer.videoTrack=e.getState(Wn)}),"localpeer-audiotrack-id"):n=e.subscribe((e=>{e&&t.namedSetState((t=>{t.localPeer.videoTrack=e}),"localpeer-audiotrack-id")}),Wn),()=>{null==i||i(),null==r||r(),null==n||n()}},zs=(e,t,i)=>{let r=i.getState(Fn);e.namedSetState((e=>{let n={},s=Object.keys(r);for(let e of s){let i=t.getTrackStats(e);i&&(n[e]=i)}yn(e.trackStats,n);let a={[i.getState(Hn)]:t.getLocalPeerStats()};yn(e.peerStats,a)}),"webrtc-stats")},Qs=e=>e.trackStats,Ys=e=>e.peerStats,Zs=en([Ys,e=>e.localPeer.id],((e,t)=>e[t])),Xs=(en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.packetsLost})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.jitter})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bitrate})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bitrate})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.availableOutgoingBitrate})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.availableIncomingBitrate})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.publish)?void 0:t.bytesSent})),en(Zs,(e=>{var t;return null==(t=null==e?void 0:e.subscribe)?void 0:t.bytesReceived})),en([Ys,(e,t)=>t],((e,t)=>t?e[t]:void 0))),ea=en([Qs,(e,t)=>t],((e,t)=>t?e[t]:void 0)),ta=(ys(Xs),ys(ea),ys(en(ea,(e=>null==e?void 0:e.bitrate))),ys(en(ea,(e=>null==e?void 0:e.bytesReceived))),ys(en(ea,(e=>null==e?void 0:e.framesPerSecond))),ys(en(ea,(e=>null==e?void 0:e.jitter))),ys(en(ea,(e=>null==e?void 0:e.packetsLost))),en([Qs,e=>e.localPeer.audioTrack],((e,t)=>t?e[t]:void 0))),ia=en([Qs,e=>e.localPeer.videoTrack],((e,t)=>t?e[t]:void 0)),ra=(en(ta,(e=>null==e?void 0:e.bitrate)),en(ia,(e=>null==e?void 0:e.bitrate)),en(ta,(e=>null==e?void 0:e.bytesSent)),en(ia,(e=>null==e?void 0:e.bytesSent)),en(ia,(e=>null==e?void 0:e.framesPerSecond)),en(ia,(e=>null==e?void 0:e.qualityLimitationReason)),class{constructor(e,t,i){this.getStats=()=>(this.stats||(this.stats=new class{constructor(e,t){this.hmsStore=e,this.sdk=t,this.store=ra.createNewHMSStore(Ws("HMSStatsStore"),fn),this.getState=this.store.getState,this.subscribe=this.store.subscribe,this.getPublishPeerConnection=()=>new Promise((e=>{var t,i;"Connected"===this.hmsStore.getState(rs)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getPublishPeerConnection()):this.hmsStore.subscribe((t=>{var i,r;"Connected"===t&&e(null==(r=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:r.getPublishPeerConnection())}),rs)})),this.getSubscribePeerConnection=()=>new Promise((e=>{var t,i;"Connected"===this.hmsStore.getState(rs)?e(null==(i=null==(t=this.sdk)?void 0:t.getWebrtcInternals())?void 0:i.getSubscribePeerConnection()):this.hmsStore.subscribe((t=>{var i,r;"Connected"===t&&e(null==(r=null==(i=this.sdk)?void 0:i.getWebrtcInternals())?void 0:r.getSubscribePeerConnection())}),rs)})),this.sdk&&((e,t,i)=>{let r;i.getState(rs)===Xr.Connected&&(r=Js(e,t,i)),i.subscribe((n=>{[Xr.Connected,Xr.Reconnecting].includes(n)?r||(r=Js(e,t,i)):r&&(((e,t="resetState")=>{e.namedSetState((e=>{Object.assign(e,{peerStats:{},trackStats:{},localPeer:{id:""}})}),t)})(t),r())}),rs)})(this.sdk,this.store,this.hmsStore)}}(this.store,this.sdk)),this.stats),this.store=e||ra.createNewHMSStore(Ws("HMSStore"),gn),this.notifications=i||new class{constructor(e){this.id=0,this.onNotification=(e,t)=>{let i=i=>{if(t){let e;if(e=Array.isArray(t)?t.includes(i.type):t===i.type,!e)return}e(i)};return this.eventEmitter.addListener(Hs,i),()=>{this.eventEmitter.removeListener(Hs,i)}},this.store=e,this.eventEmitter=new gt.EventEmitter2}sendPlaylistTrackEnded(e){let t=this.createNotification(vn.PLAYLIST_TRACK_ENDED,e,pn.INFO);this.emitEvent(t)}sendDeviceChange(e){var t;let i=this.createNotification(vn.DEVICE_CHANGE_UPDATE,e,e.error?pn.ERROR:pn.INFO,`Selected ${e.type} device - ${null==(t=e.selection)?void 0:t.label}`);this.emitEvent(i)}sendLeaveRoom(e){var t;let i=null==(t=e.requestedBy)?void 0:t.name,r=this.createNotification(e.roomEnded||!i?vn.ROOM_ENDED:vn.REMOVED_FROM_ROOM,e,pn.INFO,`${e.roomEnded?"Room ended":"Removed from room"} ${i?`by ${i}`:""}`);this.emitEvent(r)}sendPeerList(e){let t=this.createNotification(vn.PEER_LIST,e,pn.INFO);this.emitEvent(t)}sendPeerUpdate(e,t){let i=this.store.getState(Cs(null==t?void 0:t.id))||t,r=js[e];if(r){let e=this.createNotification(r,i,pn.INFO);this.emitEvent(e)}}sendTrackUpdate(e,t){let i=this.store.getState(Ps(t)),r=Ks[e];if(r){let e=this.createNotification(r,i,pn.INFO);this.emitEvent(e)}}sendMessageReceived(e){let t=this.createNotification(vn.NEW_MESSAGE,e,pn.INFO);this.emitEvent(t)}sendError(e){let t=this.createNotification(vn.ERROR,e,pn.ERROR);this.emitEvent(t)}sendReconnecting(e){let t=this.createNotification(vn.RECONNECTING,e,pn.ERROR);this.emitEvent(t)}sendReconnected(){let e=this.createNotification(vn.RECONNECTED,null,pn.INFO);this.emitEvent(e)}sendChangeTrackStateRequest(e){let t=this.createNotification(vn.CHANGE_TRACK_STATE_REQUEST,e,pn.INFO);this.emitEvent(t)}sendChangeMultiTrackStateRequest(e){let t=this.createNotification(vn.CHANGE_MULTI_TRACK_STATE_REQUEST,e,pn.INFO);this.emitEvent(t)}emitEvent(e){this.eventEmitter.emit(Hs,e)}createNotification(e,t,i,r=""){return this.id++,{id:this.id,type:e,message:r,data:t,severity:i}}}(this.store),t?this.actions=t:(this.sdk=new class{constructor(){this.TAG="[HMSSdk]:",this.transportState=Tr.Disconnected,this.analyticsTimer=new class{constructor(){this.eventPerformanceMeasures={}}start(e){performance.mark(e)}end(e){var t;try{this.eventPerformanceMeasures[e]=performance.measure(e,e),Lt.d("[HMSPerformanceTiming]",e,null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration)}catch(t){Lt.w("[AnalyticsTimer]",`Error in measuring performance for event ${e}`,{error:t})}}getTimeTaken(e){var t;return null==(t=this.eventPerformanceMeasures[e])?void 0:t.duration}getTimes(...e){return e.reduce(((e,t)=>Ct(Rt({},e),{[t]:this.getTimeTaken(t)})),{})}cleanUp(){this.eventPerformanceMeasures={}}},this.sdkState=Rt({},zr),this.handleAutoplayError=e=>{var t,i;null==(i=null==(t=this.errorListener)?void 0:t.onError)||i.call(t,e)},this.observer={onNotification:e=>{e.method!==wi.PEER_LEAVE_REQUEST?(e.method===wi.POLICY_CHANGE&&this.analyticsTimer.end(vr.ON_POLICY_CHANGE),this.notificationManager.handleNotification(e,this.sdkState.isReconnecting)):this.handlePeerLeaveRequest(e.params)},onTrackAdd:e=>{this.notificationManager.handleTrackAdd(e)},onTrackRemove:e=>{this.notificationManager.handleTrackRemove(e)},onTrackDegrade:e=>{var t,i;Lt.d(this.TAG,"Sending Track Update Track Degraded",e),null==(i=this.listener)||i.onTrackUpdate(It.TRACK_DEGRADED,e,null==(t=this.store)?void 0:t.getPeerByTrackId(e.trackId))},onTrackRestore:e=>{var t,i;Lt.d(this.TAG,"Sending Track Update Track Restored",e),null==(i=this.listener)||i.onTrackUpdate(It.TRACK_RESTORED,e,null==(t=this.store)?void 0:t.getPeerByTrackId(e.trackId))},onFailure:e=>{var t;null==(t=this.errorListener)||t.onError(e)},onStateChange:(e,t)=>_t(this,null,(function*(){var i,r,n,s;switch(e){case Tr.Preview:case Tr.Joined:this.transportState===Tr.Reconnecting&&(null==(i=this.listener)||i.onReconnected());break;case Tr.Failed:yield this.leave(),null==(n=null==(r=this.errorListener)?void 0:r.onError)||n.call(r,t),this.sdkState.isReconnecting=!1;break;case Tr.Reconnecting:this.sdkState.isReconnecting=!0,null==(s=this.listener)||s.onReconnecting(t)}this.transportState=e,Lt.d(this.TAG,"Transport State Change",this.transportState)}))},this.handlePeerLeaveRequest=e=>{var t;let i=e.requested_by?this.store.getPeerById(e.requested_by):void 0,r={roomEnded:e.room_end,reason:e.reason,requestedBy:i};null==(t=this.listener)||t.onRemovedFromRoom(r),this.leave()},this.handleDeviceChange=e=>{var t,i,r,n,s,a;if(Lt.d(this.TAG,"Device Change event",e),null==(i=null==(t=this.deviceChangeListener)?void 0:t.onDeviceChange)||i.call(t,e),e.error&&e.type){let t=e.type.includes("audio")?null==(r=this.localPeer)?void 0:r.audioTrack:null==(n=this.localPeer)?void 0:n.videoTrack;null==(s=this.errorListener)||s.onError(e.error),[Kt.TracksErrors.CANT_ACCESS_CAPTURE_DEVICE,Kt.TracksErrors.DEVICE_IN_USE,Kt.TracksErrors.DEVICE_NOT_AVAILABLE].includes(e.error.code)&&t&&(t.setEnabled(!1),null==(a=this.listener)||a.onTrackUpdate(It.TRACK_MUTED,t,this.localPeer))}},this.handleAudioPluginError=e=>{var t;Lt.e(this.TAG,"Audio Plugin Error event",e),null==(t=this.errorListener)||t.onError(e)},this.handleLocalRoleUpdate=e=>_t(this,[e],(function*({oldRole:e,newRole:t}){var i;yield this.transport.handleLocalRoleUpdate({oldRole:e,newRole:t}),yield null==(i=this.roleChangeManager)?void 0:i.handleLocalPeerRoleUpdate({oldRole:e,newRole:t})})),this.getScreenshareSettings=e=>{let{screen:t}=this.store.getPublishParams(),i=this.store.getSimulcastDimensions("screen");return{video:(new Oi).maxBitrate(t.bitRate,!1).codec(t.codec).maxFramerate(t.frameRate).setWidth((null==i?void 0:i.width)||t.width).setHeight((null==i?void 0:i.height)||t.height).build(),audio:e?void 0:(new Ii).build()}},this.sendAudioPresenceFailed=()=>{let e=Jt.NoAudioDetected(Vt.PREVIEW);this.sendAnalyticsEvent(pr.audioDetectionFail(e,this.deviceManager.getCurrentSelection().audioInput))},this.sendJoinAnalyticsEvent=(e=!1,t)=>{this.eventBus.analytics.publish(pr.join(Ct(Rt({error:t},this.analyticsTimer.getTimes(vr.INIT,vr.WEBSOCKET_CONNECT,vr.ON_POLICY_CHANGE,vr.LOCAL_TRACKS)),{time:this.analyticsTimer.getTimeTaken(vr.JOIN),is_preview_called:e})))},this.sendPreviewAnalyticsEvent=e=>{this.eventBus.analytics.publish(pr.preview(Ct(Rt({error:e},this.analyticsTimer.getTimes(vr.INIT,vr.WEBSOCKET_CONNECT,vr.ON_POLICY_CHANGE,vr.LOCAL_TRACKS)),{time:this.analyticsTimer.getTimeTaken(vr.PREVIEW)})))},this.sendAnalyticsEvent=e=>{this.analyticsEventsService.queue(e).flush()}}initStoreAndManagers(){if(this.sdkState.isInitialised)return this.notificationManager.setListener(this.listener),void this.audioSinkManager.setListener(this.listener);this.sdkState.isInitialised=!0,this.store=new class{constructor(){this.comparator=new class{constructor(e){this.store=e,this.primitiveComparator=(e,t)=>e===t?0:Number(e)-Number(t),this.stringComparator=(e,t)=>e===t?0:e<t?-1:1}getPeerComparators(){return{videoEnabled:(e,t)=>{var i,r;return this.primitiveComparator(Boolean(null==(i=e.videoTrack)?void 0:i.enabled),Boolean(null==(r=t.videoTrack)?void 0:r.enabled))},audioEnabled:(e,t)=>{var i,r;return this.primitiveComparator(Boolean(null==(i=e.audioTrack)?void 0:i.enabled),Boolean(null==(r=t.audioTrack)?void 0:r.enabled))},screenShare:(e,t)=>this.primitiveComparator(e.auxiliaryTracks.some((e=>"screen"===e.source)),t.auxiliaryTracks.some((e=>"screen"===e.source))),audioLevel:(e,t)=>{var i,r;return this.primitiveComparator((null==(i=this.store.getSpeakers().find((t=>t.peer&&t.peer.peerId===(null==e?void 0:e.peerId))))?void 0:i.audioLevel)||-1,(null==(r=this.store.getSpeakers().find((e=>e.peer&&e.peer.peerId===(null==t?void 0:t.peerId))))?void 0:r.audioLevel)||-1)},rolePriority:(e,t)=>{var i,r;return this.primitiveComparator((null==(i=e.role)?void 0:i.priority)||0,(null==(r=t.role)?void 0:r.priority)||0)}}}getTrackComparators(){return{video:(e,t)=>this.primitiveComparator(e.type===ti.VIDEO,t.type===ti.VIDEO),audio:(e,t)=>this.primitiveComparator(e.type===ti.AUDIO,t.type===ti.AUDIO),enabled:(e,t)=>this.primitiveComparator(Boolean(e.enabled),Boolean(t.enabled)),peerAudioLevel:(e,t)=>{let i=this.store.getPeerByTrackId(e.trackId),r=this.store.getPeerByTrackId(t.trackId);return this.getPeerComparators().audioLevel(i,r)},audioLevel:(e,t)=>{var i,r;return this.primitiveComparator((null==(i=this.store.getSpeakers().find((t=>t.track.trackId===e.trackId)))?void 0:i.audioLevel)||0,(null==(r=this.store.getSpeakers().find((e=>e.track.trackId===t.trackId)))?void 0:r.audioLevel)||0)},screenShare:(e,t)=>this.primitiveComparator("screen"===e.source,"screen"===t.source),rolePriority:(e,t)=>{var i,r,n,s;return this.primitiveComparator((null==(r=null==(i=this.store.getPeerByTrackId(e.trackId))?void 0:i.role)?void 0:r.priority)||0,(null==(s=null==(n=this.store.getPeerByTrackId(t.trackId))?void 0:n.role)?void 0:s.priority)||0)}}}}(this),this.knownRoles={},this.peers={},this.tracks={},this.peerTrackStates={},this.speakers=[],this.videoLayers=null,this.screenshareLayers=null,this.roleDetailsArrived=!1,this.env=Rr.PROD}getConfig(){return this.config}getEnv(){return this.env}getPublishParams(){return this.publishParams}getComparator(){return this.comparator}getRoom(){return this.room}getPolicyForRole(e){return this.knownRoles[e]}getKnownRoles(){return this.knownRoles}getLocalPeer(){if(this.localPeerId&&this.peers[this.localPeerId])return this.peers[this.localPeerId]}getRemotePeers(){return Object.values(this.peers).filter((e=>!e.isLocal))}getPeers(){return Object.values(this.peers)}getPeerById(e){if(this.peers[e])return this.peers[e]}getTracksMap(){return this.tracks}getTracks(){return Object.values(this.tracks)}getVideoTracks(){return this.getTracks().filter((e=>e.type===ti.VIDEO))}getRemoteVideoTracks(){return this.getTracks().filter((e=>e instanceof yi))}getAudioTracks(){return this.getTracks().filter((e=>e.type===ti.AUDIO))}getPeerTracks(e){let t=e?this.peers[e]:void 0,i=[];return(null==t?void 0:t.videoTrack)&&i.push(t.videoTrack),(null==t?void 0:t.audioTrack)&&i.push(t.audioTrack),i.concat((null==t?void 0:t.auxiliaryTracks)||[])}getLocalPeerTracks(){return this.getPeerTracks(this.localPeerId)}getTrackById(e){var t,i;let r=this.tracks[e];if(r)return r;let n=this.getLocalPeer();if(n){if(null==(t=n.audioTrack)?void 0:t.isPublishedTrackId(e))return n.audioTrack;if(null==(i=n.videoTrack)?void 0:i.isPublishedTrackId(e))return n.videoTrack}}getPeerByTrackId(e){let t=this.tracks[e];return t.peerId?this.peers[t.peerId]:void 0}getSpeakers(){return this.speakers}getSpeakerPeers(){return this.speakers.map((e=>e.peer))}setRoom(e){this.room=e}setKnownRoles(e){this.knownRoles=e,this.roleDetailsArrived=!0,this.updatePeersPolicy()}hasRoleDetailsArrived(){return this.roleDetailsArrived}setConfig(e){var t,i,r;if(tr.rememberDevices(Boolean(e.rememberDeviceSelection)),e.rememberDeviceSelection){let n=tr.getSelection();n&&(e.settings||(e.settings={}),(null==(t=n.audioInput)?void 0:t.deviceId)&&(e.settings.audioInputDeviceId=e.settings.audioInputDeviceId||n.audioInput.deviceId),(null==(i=n.audioOutput)?void 0:i.deviceId)&&(e.settings.audioOutputDeviceId=e.settings.audioOutputDeviceId||n.audioOutput.deviceId),(null==(r=n.videoInput)?void 0:r.deviceId)&&(e.settings.videoDeviceId=e.settings.videoDeviceId||n.videoInput.deviceId))}this.config=e,this.setEnv()}setPublishParams(e){this.publishParams=e}addPeer(e){this.peers[e.peerId]=e,e.isLocal&&(this.localPeerId=e.peerId)}addTrack(e){this.tracks[e.trackId]=e}getTrackState(e){return this.peerTrackStates[e]}setTrackState(e){this.peerTrackStates[e.trackInfo.track_id]=e}removePeer(e){this.localPeerId===e&&(this.localPeerId=void 0),delete this.peers[e]}removeTrack(e){delete this.tracks[e]}updateSpeakers(e){this.speakers=e}updateAudioOutputVolume(e){this.getAudioTracks().forEach((t=>t.setVolume(e)))}updateAudioOutputDevice(e){this.getAudioTracks().forEach((t=>{t.setOutputDevice(e)}))}getSubscribeDegradationParams(){var e,t;let i=null==(t=null==(e=this.getLocalPeer())?void 0:e.role)?void 0:t.subscribeParams.subscribeDegradation;if(i&&Object.keys(i).length>0)return i}getSimulcastLayers(e){var t,i;return"screen"===e?(null==(t=this.screenshareLayers)?void 0:t.layers)||[]:(null==(i=this.videoLayers)?void 0:i.layers)||[]}getSimulcastDimensions(e){let t="screen"===e?this.screenshareLayers:this.videoLayers;return{width:null==t?void 0:t.width,height:null==t?void 0:t.height}}convertSimulcastLayers(e){return Ct(Rt({},e),{layers:(e.layers||[]).map((e=>Ct(Rt({},e),{maxBitrate:1e3*e.maxBitrate})))})}setVideoSimulcastLayers(e){this.videoLayers=this.convertSimulcastLayers(e)}setScreenshareSimulcastLayers(e){this.screenshareLayers=this.convertSimulcastLayers(e)}getSimulcastDefinitionsForPeer(e,t){var i;if(!e.role)return[];let r,n=this.getPolicyForRole(e.role.name).publishParams;"regular"===t?r=n.videoSimulcastLayers:"screen"===t&&(r=n.screenSimulcastLayers);let s=null==r?void 0:r.width,a=null==r?void 0:r.height;return(null==(i=null==r?void 0:r.layers)?void 0:i.map((e=>({layer:Bt[e.rid],resolution:{width:s&&e.scaleResolutionDownBy?s/e.scaleResolutionDownBy:void 0,height:a&&e.scaleResolutionDownBy?a/e.scaleResolutionDownBy:void 0}}))))||[]}cleanUp(){let e=this.getTracks();for(let t of e)t.cleanup();this.room=void 0,this.config=void 0,this.localPeerId=void 0,this.roleDetailsArrived=!1}setErrorListener(e){this.errorListener=e}updatePeersPolicy(){this.getPeers().forEach((e=>{var t;e.role?e.role=this.getPolicyForRole(e.role.name):null==(t=this.errorListener)||t.onError(Qt.InvalidRole(Vt.VALIDATION,""))}))}setEnv(){var e;let t=(null==(e=this.config)?void 0:e.initEndpoint).split("https://")[1],i=Rr.PROD;t.startsWith(Rr.PROD)?i=Rr.PROD:t.startsWith(Rr.QA)?i=Rr.QA:t.startsWith(Rr.DEV)&&(i=Rr.DEV),this.env=i,_r.setEnv(i)}},this.eventBus=new class{constructor(){this.eventEmitter=new gt.EventEmitter2,this.deviceChange=new Jr("device-change",this.eventEmitter),this.localAudioEnabled=new Jr("local-audio-enabled",this.eventEmitter),this.localVideoEnabled=new Jr("local-video-enabled",this.eventEmitter),this.statsUpdate=new Jr("stats-update",this.eventEmitter),this.trackDegraded=new Jr("track-degraded",this.eventEmitter),this.trackRestored=new Jr("track-restored",this.eventEmitter),this.trackAudioLevelUpdate=new Jr("track-audio-level-update",this.eventEmitter),this.audioPluginFailed=new Jr("audio-plugin-failed",this.eventEmitter),this.localAudioSilence=new Jr("local-audio-silence",this.eventEmitter),this.analytics=new Jr("analytics",this.eventEmitter),this.policyChange=new Jr("policy-change",this.eventEmitter),this.localRoleUpdate=new Jr("local-role-update",this.eventEmitter),this.audioTrackUpdate=new Jr("audio-track-update",this.eventEmitter),this.audioTrackAdded=new Jr("audio-track-added",this.eventEmitter),this.audioTrackRemoved=new Jr("audio-track-removed",this.eventEmitter),this.autoplayError=new Jr("autoplay-error",this.eventEmitter)}},this.networkTestManager=new class{constructor(e,t){this.eventBus=e,this.listener=t,this.TAG="NetworkTestManager",this.controller=new AbortController,this.start=e=>_t(this,null,(function*(){var t,i,r;if(!e)return;let{url:n,timeout:s,scoreMap:a}=e,o=this.controller.signal,l=Date.now(),c=0,d=Ai(s).then((()=>{this.controller.abort()}));try{let e=null==(t=(yield fetch(`${n}?${Date.now()}`,{signal:o})).body)?void 0:t.getReader();if(!e)throw Error("unable to process request");let i=()=>_t(this,null,(function*(){if(e)try{let t=!1;for(;!t;){let{value:i,done:r}=yield e.read();t=r,i&&(c+=i.byteLength,this.sendScore({scoreMap:a,downloadedSize:c,startTime:l}))}}catch(e){Lt.e(this.TAG,e)}}));return Promise.race([i(),d]).then((()=>{this.sendScore({scoreMap:a,downloadedSize:c,startTime:l,finished:!0})})).catch((e=>{var t,i;Lt.e(this.TAG,e),null==(i=null==(t=this.listener)?void 0:t.onNetworkQuality)||i.call(t,0),this.eventBus.analytics.publish(pr.previewNetworkQuality({error:e.message}))}))}catch(e){Lt.e(this.TAG,e),"AbortError"!==e.name&&(null==(r=null==(i=this.listener)?void 0:i.onNetworkQuality)||r.call(i,0),this.eventBus.analytics.publish(pr.previewNetworkQuality({error:e.message})))}})),this.stop=()=>{this.controller.signal.aborted||this.controller.abort()},this.sendScore=({scoreMap:e,downloadedSize:t,startTime:i,finished:r=!1})=>{var n,s;let a=t/1024/((Date.now()-i)/1e3)*8,o=-1;for(let t in e){let i=e[t];a>=i.low&&(!i.high||a<=i.high)&&(o=Number(t))}null==(s=null==(n=this.listener)?void 0:n.onNetworkQuality)||s.call(n,o),r&&this.eventBus.analytics.publish(pr.previewNetworkQuality({score:o,downLink:a.toFixed(2)}))}}}(this.eventBus,this.listener),this.playlistManager=new Wr(this,this.eventBus),this.notificationManager=new class{constructor(e,t,i,r,n){this.store=e,this.listener=i,this.audioListener=r,this.connectionQualityListener=n,this.TAG="[HMSNotificationManager]",this.hasConsistentRoomStateArrived=!1,this.ignoreNotification=e=>{if(e===wi.PEER_LIST)this.hasConsistentRoomStateArrived=!0;else if(e===wi.ROOM_STATE)return this.hasConsistentRoomStateArrived;return!1},this.handleTrackAdd=e=>{this.trackManager.handleTrackAdd(e)},this.handleTrackRemove=e=>{this.trackManager.handleTrackRemove(e)},this.updateLocalPeer=({name:e,metadata:t})=>{let i=this.store.getLocalPeer();this.peerManager.handlePeerInfoUpdate({peer:i,name:e,data:t})},this.trackManager=new class{constructor(e,t,i){this.store=e,this.eventBus=t,this.listener=i,this.tracksToProcess=new Map,this.handleTrackAdd=e=>{Lt.d(this.TAG,"ONTRACKADD",e,e.nativeTrack),this.store.addTrack(e),this.tracksToProcess.set(e.trackId,e),this.processPendingTracks()},this.handleTrackRemove=e=>{var t;Lt.d(this.TAG,"ONTRACKREMOVE",e,e.nativeTrack);let i=this.store.getTrackState(e.trackId);if(!i)return;e.type===ti.AUDIO&&this.eventBus.audioTrackRemoved.publish(e);let r=this.store.getPeerById(i.peerId);!r||(this.removePeerTracks(r,e),this.store.removeTrack(e.trackId),null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,e,r))},this.handleTrackLayerUpdate=e=>{var t,i;for(let r in e.tracks){let n=e.tracks[r],s=this.store.getTrackById(r);if(!s)continue;let a=this.store.getPeerByTrackId(r);if(a&&s instanceof yi){let e=this.isTrackDegraded(n.expected_layer,n.current_layer);s.setLayerFromServer(n.current_layer,e),e?null==(t=this.listener)||t.onTrackUpdate(It.TRACK_DEGRADED,s,a):null==(i=this.listener)||i.onTrackUpdate(It.TRACK_RESTORED,s,a)}}},this.handleTrackUpdate=e=>{var t,i;let r=this.store.getPeerById(e.peer.peer_id);if(r)for(let n in e.tracks){let s=Object.assign({},null==(t=this.store.getTrackState(n))?void 0:t.trackInfo),a=e.tracks[n],o=this.store.getTrackById(n);if(this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:Rt(Rt({},s),a)}),!o||this.tracksToProcess.has(n))this.processPendingTracks();else{o.setEnabled(!a.mute);let e=this.processTrackUpdate(o,s,a);e&&(null==(i=this.listener)||i.onTrackUpdate(e,o,r))}}}}get TAG(){return`[${this.constructor.name}]`}isTrackDegraded(e,t){let i=e=>{switch(e){case Ot.HIGH:return 3;case Ot.MEDIUM:return 2;case Ot.LOW:return 1;case Ot.NONE:return 0}};return i(t)<i(e)}handleTrackMetadataAdd(e){Lt.d(this.TAG,"TRACK_METADATA_ADD",e);for(let t in e.tracks)this.store.setTrackState({peerId:e.peer.peer_id,trackInfo:e.tracks[t]});this.processPendingTracks()}processPendingTracks(){new Map(this.tracksToProcess).forEach((e=>{var t;let i=this.store.getTrackState(e.trackId);if(!i)return;let r=this.store.getPeerById(i.peerId);!r||(e.source=i.trackInfo.source,e.peerId=r.peerId,e.logIdentifier=r.name,e.setEnabled(!i.trackInfo.mute),this.addAudioTrack(r,e),this.addVideoTrack(r,e),e.type===ti.AUDIO?this.eventBus.audioTrackAdded.publish({track:e,peer:r}):null==(t=this.listener)||t.onTrackUpdate(It.TRACK_ADDED,e,r),this.tracksToProcess.delete(e.trackId))}))}removePeerTracks(e,t){var i,r;let n=e.auxiliaryTracks.indexOf(t);n>-1?e.auxiliaryTracks.splice(n,1):t.type===ti.AUDIO&&(null==(i=e.audioTrack)?void 0:i.trackId)===t.trackId?e.audioTrack=void 0:t.type===ti.VIDEO&&(null==(r=e.videoTrack)?void 0:r.trackId)===t.trackId&&(e.videoTrack=void 0)}addAudioTrack(e,t){t.type===ti.AUDIO&&(e.audioTrack||"regular"!==t.source?e.auxiliaryTracks.push(t):e.audioTrack=t)}addVideoTrack(e,t){if(t.type!==ti.VIDEO)return;let i=t,r=this.store.getSimulcastDefinitionsForPeer(e,i.source);i.setSimulcastDefinitons(r),e.videoTrack||"regular"!==t.source?e.auxiliaryTracks.push(i):e.videoTrack=i}processTrackUpdate(e,t,i){let r;return e.setEnabled(!i.mute),t.mute!==i.mute?(r=i.mute?It.TRACK_MUTED:It.TRACK_UNMUTED,e.type===ti.AUDIO&&this.eventBus.audioTrackUpdate.publish({track:e,enabled:!i.mute})):t.description!==i.description&&(r=It.TRACK_DESCRIPTION_CHANGED),r}}(this.store,t,this.listener),this.peerManager=new class{constructor(e,t,i){this.store=e,this.trackManager=t,this.listener=i,this.handlePeerList=e=>{var t;if(0===e.length)return;let i=[],r=new Set(e.map((e=>e.peer_id)));this.store.getRemotePeers().forEach((({peerId:e,fromRoomState:t})=>{!r.has(e)&&t&&this.store.removePeer(e)}));for(let t of e)i.push(this.makePeer(t));null==(t=this.listener)||t.onPeerUpdate(wt.PEER_LIST,i),this.trackManager.processPendingTracks()},this.handlePeerJoin=e=>{var t;let i=this.makePeer(e);null==(t=this.listener)||t.onPeerUpdate(wt.PEER_JOINED,i),this.trackManager.processPendingTracks()},this.handlePeerLeave=e=>{var t,i,r,n;let s=this.store.getPeerById(e.peer_id);this.store.removePeer(e.peer_id),Lt.d(this.TAG,"PEER_LEAVE event",e,this.store.getPeers()),s&&(s.audioTrack&&(null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,s.audioTrack,s)),s.videoTrack&&(null==(i=this.listener)||i.onTrackUpdate(It.TRACK_REMOVED,s.videoTrack,s)),null==(r=s.auxiliaryTracks)||r.forEach((e=>{var t;null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,e,s)})),null==(n=this.listener)||n.onPeerUpdate(wt.PEER_LEFT,s))}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){switch(e){case wi.PEER_JOIN:{let e=t;this.handlePeerJoin(e);break}case wi.PEER_LEAVE:{let e=t;this.handlePeerLeave(e);break}case wi.PEER_UPDATE:this.handlePeerUpdate(t)}}handlePeerUpdate(e){var t;let i=this.store.getPeerById(e.peer_id);if(i){if(i.role&&i.role.name!==e.role){let r=this.store.getPolicyForRole(e.role);i.updateRole(r),null==(t=this.listener)||t.onPeerUpdate(wt.ROLE_UPDATED,i)}this.handlePeerInfoUpdate(Rt({peer:i},e.info))}}handlePeerInfoUpdate({peer:e,name:t,data:i}){var r,n;!e||(t&&e.name!==t&&(e.updateName(t),null==(r=this.listener)||r.onPeerUpdate(wt.NAME_UPDATED,e)),i&&e.metadata!==i&&(e.updateMetadata(i),null==(n=this.listener)||n.onPeerUpdate(wt.METADATA_UPDATED,e)))}makePeer(e){let t=new $i({peerId:e.peer_id,name:e.info.name,customerUserId:e.info.user_id,metadata:e.info.data,role:this.store.getPolicyForRole(e.role),joinedAt:Hi(e.joined_at),fromRoomState:!!e.is_from_room_state});this.store.addPeer(t),Lt.d(this.TAG,"adding to the peerList",t);for(let t in e.tracks)this.store.setTrackState({peerId:e.peer_id,trackInfo:e.tracks[t]});return t}}(this.store,this.trackManager,this.listener),this.peerListManager=new class{constructor(e,t,i,r){this.store=e,this.peerManager=t,this.trackManager=i,this.listener=r,this.handleInitialPeerList=e=>{let t=Object.values(e.peers);this.peerManager.handlePeerList(t)},this.handleReconnectPeerList=e=>{this.handleRepeatedPeerList(e.peers)},this.handlePreviewRoomState=e=>{if(!this.store.hasRoleDetailsArrived())return;let t=e.peers;null!=t?(Object.keys(t).forEach((e=>{t[e].tracks={},t[e].is_from_room_state=!0})),this.handleRepeatedPeerList(t)):0===e.peer_count&&this.handleRepeatedPeerList({})},this.handleRepeatedPeerList=e=>{let t=this.store.getRemotePeers(),i=Object.values(e),r=t.filter((t=>!e[t.peerId]));Lt.d(this.TAG,{peersToRemove:r}),r.forEach((e=>{var t;let i={peer_id:e.peerId,role:(null==(t=e.role)?void 0:t.name)||"",info:{name:e.name,data:e.metadata||"",user_id:e.customerUserId||""},tracks:{}};this.peerManager.handlePeerLeave(i)})),i.forEach((e=>{let t=this.store.getPeerById(e.peer_id),i=Object.values(e.tracks);t?(this.store.getPeerTracks(t.peerId).forEach((i=>{var r;e.tracks[i.trackId]||(this.removePeerTrack(t,i.trackId),null==(r=this.listener)||r.onTrackUpdate(It.TRACK_REMOVED,i,t))})),i.forEach((e=>{this.store.getTrackById(e.track_id)||this.store.setTrackState({peerId:t.peerId,trackInfo:e})})),this.trackManager.handleTrackUpdate({peer:{info:e.info,peer_id:e.peer_id},tracks:e.tracks}),this.peerManager.handlePeerUpdate(e)):this.peerManager.handlePeerJoin(e)}))}}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t,i){if(e===wi.PEER_LIST){let e=t;i?(Lt.d(this.TAG,"RECONNECT_PEER_LIST event",e),this.handleReconnectPeerList(e)):(Lt.d(this.TAG,"PEER_LIST event",e),this.handleInitialPeerList(e))}else if(e===wi.ROOM_STATE){let e=t;this.handlePreviewRoomState(e)}}removePeerTrack(e,t){var i,r;if((null==(i=e.audioTrack)?void 0:i.trackId)===t)e.audioTrack=void 0;else if((null==(r=e.videoTrack)?void 0:r.trackId)===t)e.videoTrack=void 0;else{let i=e.auxiliaryTracks.findIndex((e=>e.trackId===t));i>=0&&e.auxiliaryTracks.splice(i,1)}}}(this.store,this.peerManager,this.trackManager,this.listener),this.broadcastManager=new class{constructor(e,t){this.store=e,this.listener=t}get TAG(){return`[${this.constructor.name}]`}handleNotification(e,t){e===wi.BROADCAST&&this.handleBroadcast(t)}handleBroadcast(e){var t;let i=e.peer,r=e.info,n=e.roles,s=this.getSender(i),a=e.private?this.store.getLocalPeer():void 0,o=[];if(null==n?void 0:n.length){let e=this.store.getKnownRoles();for(let t of n)e[t]&&o.push(e[t])}let l=new xi(Ct(Rt({},r),{sender:s,recipientRoles:o,recipientPeer:a,time:new Date(e.timestamp)}));Lt.d(this.TAG,`Received Message from sender=${null==i?void 0:i.peer_id}: `,l),null==(t=this.listener)||t.onMessageReceived(l)}getSender(e){let t=e?this.store.getPeerById(e.peer_id):void 0;return!t&&e&&(t=new Ui({peerId:e.peer_id,name:e.info.name,isLocal:!1,customerUserId:e.info.user_id,metadata:e.info.data})),t}}(this.store,this.listener),this.policyChangeManager=new class{constructor(e,t){this.store=e,this.eventBus=t}handlePolicyChange(e){var t,i;let r=this.store.getLocalPeer();if(r&&!r.role){let t=e.known_roles[e.name];r.updateRole(t)}this.store.setKnownRoles(e.known_roles),this.store.getRoom().templateId=e.template_id;let n=null==(t=e.known_roles[e.name])?void 0:t.publishParams;if(this.store.setPublishParams(n),this.setSimulcastLayers(n),this.handleStreamingRecordingPermissions(null==(i=e.known_roles[e.name])?void 0:i.permissions),(null==r?void 0:r.role)&&r.role.name!==e.name){let t=this.store.getPolicyForRole(e.name),i=r.role;r.updateRole(t),this.eventBus.localRoleUpdate.publish({oldRole:i,newRole:t})}this.eventBus.policyChange.publish(e)}setSimulcastLayers(e){if(e&&Object.keys(e).length>0){let{videoSimulcastLayers:t,screenSimulcastLayers:i}=e;this.store.setVideoSimulcastLayers(t),this.store.setScreenshareSimulcastLayers(i)}}handleStreamingRecordingPermissions(e){e&&(void 0===e.recording&&(e.recording=!0),void 0===e.streaming&&(e.streaming=!0))}}(this.store,t),this.requestManager=new class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case wi.ROLE_CHANGE_REQUEST:this.handleRoleChangeRequest(t);break;case wi.TRACK_UPDATE_REQUEST:this.handleTrackUpdateRequest(t);break;case wi.CHANGE_TRACK_MUTE_STATE_UPDATE:this.handleChangeTrackStateRequest(t);break;default:return}}handleRoleChangeRequest(e){var t;let i={requestedBy:e.requested_by?this.store.getPeerById(e.requested_by):void 0,role:this.store.getPolicyForRole(e.role),token:e.token};null==(t=this.listener)||t.onRoleChangeRequest(i)}handleTrackUpdateRequest(e){let{requested_by:t,track_id:i,mute:r}=e,n=t?this.store.getPeerById(t):void 0,s=this.store.getLocalPeerTracks().find((e=>e.publishedTrackId===i));if(!s)return;let a=()=>{var e;null==(e=this.listener)||e.onChangeTrackStateRequest({requestedBy:n,track:s,enabled:!r})};if(r){if(s.enabled===!r)return;s.setEnabled(!r).then(a)}else a()}handleChangeTrackStateRequest(e){var t;let{type:i,source:r,value:n,requested_by:s}=e,a=s?this.store.getPeerById(s):void 0,o=!n,l=this.getTracksToBeUpdated({type:i,source:r,enabled:o});if(0!==l.length)if(o)null==(t=this.listener)||t.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,type:i,source:r,enabled:!0});else{let e=[];for(let t of l)e.push(t.setEnabled(!1));Promise.all(e).then((()=>{var e;null==(e=this.listener)||e.onChangeMultiTrackStateRequest({requestedBy:a,tracks:l,enabled:!1})}))}}getTracksToBeUpdated({type:e,source:t,enabled:i}){let r=this.store.getLocalPeerTracks();return e&&(r=r.filter((t=>t.type===e))),t&&(r=r.filter((e=>e.source===t))),r.filter((e=>e.enabled!==i))}}(this.store,this.listener),this.activeSpeakerManager=new class{constructor(e,t,i){this.store=e,this.listener=t,this.audioListener=i}handleActiveSpeakers(e){var t,i,r;let n=e["speaker-list"],s=n.map((e=>({audioLevel:e.level,peer:this.store.getPeerById(e.peer_id),track:this.store.getTrackById(e.track_id)})));null==(t=this.audioListener)||t.onAudioLevelUpdate(s),this.store.updateSpeakers(s);let a=n[0];if(a){let e=this.store.getPeerById(a.peer_id);null==(i=this.listener)||i.onPeerUpdate(wt.BECAME_DOMINANT_SPEAKER,e)}else null==(r=this.listener)||r.onPeerUpdate(wt.RESIGNED_DOMINANT_SPEAKER,null)}}(this.store,this.listener,this.audioListener),this.connectionQualityManager=new class{constructor(e){this.listener=e}handleQualityUpdate(e){var t;let i=e.peers.map((e=>({peerID:e.peer_id,downlinkQuality:e.downlink_score})));null==(t=this.listener)||t.onConnectionQualityUpdate(i)}}(this.connectionQualityListener),this.roomUpdateManager=new class{constructor(e,t){this.store=e,this.listener=t}handleNotification(e,t){switch(e){case wi.PEER_LIST:this.onRoomState(t.room);break;case wi.RTMP_START:this.onRTMPStart(t);break;case wi.RTMP_STOP:this.onRTMPStop(t);break;case wi.RECORDING_START:this.onRecordingStart(t);break;case wi.RECORDING_STOP:this.onRecordingStop(t);break;case wi.ROOM_STATE:this.handlePreviewRoomState(t);break;default:this.onHLS(e,t)}}handlePreviewRoomState(e){let{room:t}=e;this.onRoomState(t,e.peer_count)}onRoomState(e,t){var i,r,n;let{recording:s,streaming:a,session_id:o,started_at:l,name:c}=e,d=this.store.getRoom();d.peerCount=t,d.name=c,d.recording.server.running=!!(null==s?void 0:s.sfu.enabled),d.recording.browser.running=!!(null==s?void 0:s.browser.enabled),d.rtmp.running=!!(null==(i=null==a?void 0:a.rtmp)?void 0:i.enabled),d.rtmp.startedAt=Hi(null==(r=null==a?void 0:a.rtmp)?void 0:r.started_at),d.recording.server.startedAt=Hi(null==s?void 0:s.sfu.started_at),d.recording.browser.startedAt=Hi(null==s?void 0:s.browser.started_at),d.recording.hls=this.getPeerListHLSRecording(s),d.hls=this.convertHls(null==a?void 0:a.hls),d.sessionId=o,d.startedAt=Hi(l),null==(n=this.listener)||n.onRoomUpdate(At.RECORDING_STATE_UPDATED,d)}onRTMPStart(e){var t;this.setRTMPStatus(!(null==(t=e.error)?void 0:t.code),e)}onRTMPStop(e){this.setRTMPStatus(!1,e)}onRecordingStart(e){var t;this.setRecordingStatus(!(null==(t=e.error)?void 0:t.code),e)}onRecordingStop(e){this.setRecordingStatus(!1,e)}onHLS(e,t){var i,r;if(![wi.HLS_START,wi.HLS_STOP].includes(e))return;let n=this.store.getRoom();t.enabled=e===wi.HLS_START&&!(null==(i=t.error)?void 0:i.code),n.hls=this.convertHls(t),n.recording.hls=this.getHLSRecording(t),null==(r=this.listener)||r.onRoomUpdate(At.HLS_STREAMING_STATE_UPDATED,n)}convertHls(e){var t,i;let r={running:!!(null==e?void 0:e.enabled),variants:[],error:(null==(t=null==e?void 0:e.error)?void 0:t.code)?e.error:void 0};return null==(i=null==e?void 0:e.variants)||i.forEach((e=>{r.variants.push({meetingURL:e.meeting_url,url:e.url,metadata:e.metadata,startedAt:Hi(e.started_at)})})),r}getHLSRecording(e){var t,i,r,n;let s={running:!1};return(null==e?void 0:e.hls_recording)&&(s={running:!!(null==e?void 0:e.enabled),singleFilePerLayer:!!(null==(t=e.hls_recording)?void 0:t.single_file_per_layer),hlsVod:!!(null==(i=e.hls_recording)?void 0:i.hls_vod),startedAt:Hi(null==(r=null==e?void 0:e.variants)?void 0:r[0].started_at),error:(null==(n=null==e?void 0:e.error)?void 0:n.code)?e.error:void 0}),s}getPeerListHLSRecording(e){var t,i;let r=null==e?void 0:e.hls;return{running:!!(null==r?void 0:r.enabled),startedAt:Hi(null==r?void 0:r.started_at),singleFilePerLayer:!!(null==(t=null==r?void 0:r.config)?void 0:t.single_file_per_layer),hlsVod:!!(null==(i=null==r?void 0:r.config)?void 0:i.hls_vod)}}setRecordingStatus(e,t){var i,r,n;let s,a=this.store.getRoom();"sfu"===t.type?(a.recording.server={running:e,startedAt:e?Hi(t.started_at):void 0,error:(null==(i=t.error)?void 0:i.code)?t.error:void 0},s=At.SERVER_RECORDING_STATE_UPDATED):(a.recording.browser={running:e,startedAt:e?Hi(t.started_at):void 0,error:(null==(r=t.error)?void 0:r.code)?t.error:void 0},s=At.BROWSER_RECORDING_STATE_UPDATED),null==(n=this.listener)||n.onRoomUpdate(s,a)}setRTMPStatus(e,t){var i,r;let n=this.store.getRoom();n.rtmp={running:e,startedAt:e?Hi(t.started_at):void 0,error:(null==(i=t.error)?void 0:i.code)?t.error:void 0},null==(r=this.listener)||r.onRoomUpdate(At.RTMP_STREAMING_STATE_UPDATED,n)}}(this.store,this.listener)}setListener(e){this.listener=e,this.trackManager.listener=e,this.peerManager.listener=e,this.peerListManager.listener=e,this.broadcastManager.listener=e,this.requestManager.listener=e,this.activeSpeakerManager.listener=e,this.roomUpdateManager.listener=e}setAudioListener(e){this.audioListener=e,this.activeSpeakerManager.audioListener=e}setConnectionQualityListener(e){this.connectionQualityListener=e,this.connectionQualityManager.listener=e}handleNotification(e,t=!1){var i,r;let n=e.method,s=e.params;[wi.ACTIVE_SPEAKERS,wi.SFU_STATS,wi.CONNECTION_QUALITY].includes(n)||Lt.d(this.TAG,`Received notification - ${n}`,{notification:s}),n===wi.SFU_STATS&&(null==(i=window.HMS)?void 0:i.ON_SFU_STATS)&&"function"==typeof(null==(r=window.HMS)?void 0:r.ON_SFU_STATS)&&window.HMS.ON_SFU_STATS(e.params),!this.ignoreNotification(n)&&(this.roomUpdateManager.handleNotification(n,s),this.peerManager.handleNotification(n,s),this.requestManager.handleNotification(n,s),this.peerListManager.handleNotification(n,s,t),this.broadcastManager.handleNotification(n,s),this.handleIsolatedMethods(n,s))}handleIsolatedMethods(e,t){switch(e){case wi.TRACK_METADATA_ADD:this.trackManager.handleTrackMetadataAdd(t);break;case wi.TRACK_UPDATE:this.trackManager.handleTrackUpdate(t);break;case wi.ON_SFU_TRACK_LAYER_UPDATE:this.trackManager.handleTrackLayerUpdate(t);break;case wi.ACTIVE_SPEAKERS:this.activeSpeakerManager.handleActiveSpeakers(t);break;case wi.CONNECTION_QUALITY:this.connectionQualityManager.handleQualityUpdate(t);break;case wi.POLICY_CHANGE:this.policyChangeManager.handlePolicyChange(t)}}}(this.store,this.eventBus,this.listener,this.audioListener),this.deviceManager=new class{constructor(e,t){this.store=e,this.eventBus=t,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.hasWebcamPermission=!1,this.hasMicrophonePermission=!1,this.TAG="[Device Manager]:",this.initialized=!1,this.videoInputChanged=!1,this.audioInputChanged=!1,this.updateOutputDevice=e=>{let t=this.audioOutput.find((t=>t.deviceId===e));return t&&(this.outputDevice=t,this.store.updateAudioOutputDevice(t),tr.updateSelection("audioOutput",{deviceId:t.deviceId,groupId:t.groupId})),t},this.getCurrentSelection=()=>{var e,t;let i=this.store.getLocalPeer(),r=this.createIdentifier(null==(e=null==i?void 0:i.audioTrack)?void 0:e.getMediaTrackSettings()),n=this.createIdentifier(null==(t=null==i?void 0:i.videoTrack)?void 0:t.getMediaTrackSettings()),s=this.audioInput.find((e=>this.createIdentifier(e)===r)),a=this.videoInput.find((e=>this.createIdentifier(e)===n));return{audioInput:s,videoInput:a,audioOutput:this.outputDevice}},this.computeChange=(e,t)=>e.length!==t.length||t.some((t=>!e.includes(this.createIdentifier(t)))),this.enumerateDevices=()=>_t(this,null,(function*(){try{let e=yield navigator.mediaDevices.enumerateDevices(),t=this.videoInput.map(this.createIdentifier),i=this.audioInput.map(this.createIdentifier);this.audioInput=[],this.audioOutput=[],this.videoInput=[],e.forEach((e=>{"audioinput"===e.kind&&e.label?(this.hasMicrophonePermission=!0,this.audioInput.push(e)):"audiooutput"===e.kind?this.audioOutput.push(e):"videoinput"===e.kind&&e.label&&(this.hasWebcamPermission=!0,this.videoInput.push(e))})),this.videoInputChanged=this.computeChange(t,this.videoInput),this.audioInputChanged=this.computeChange(i,this.audioInput),tr.setDevices({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput]}),this.logDevices("Enumerate Devices")}catch(e){Lt.e(this.TAG,"Failed enumerating devices",e)}})),this.handleDeviceChange=()=>_t(this,null,(function*(){yield this.enumerateDevices(),this.eventBus.analytics.publish(pr.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})),this.logDevices("After Device Change");let e=this.store.getLocalPeer();this.setOutputDevice(!0),yield this.handleAudioInputDeviceChange(null==e?void 0:e.audioTrack),yield this.handleVideoInputDeviceChange(null==e?void 0:e.videoTrack)})),this.handleAudioInputDeviceChange=e=>_t(this,null,(function*(){if(!e)return void Lt.d(this.TAG,"No Audio track on local peer");if(!this.audioInputChanged)return void Lt.d(this.TAG,"No Change in AudioInput Device");let t=this.getNewAudioInputDevice();if(!t||!t.deviceId)return void Lt.w(this.TAG,"Audio device not found");let{settings:i}=e,r=(new Ii).codec(i.codec).maxBitrate(i.maxBitrate).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"audioInput"}),this.logDevices("Audio Device Change Success")}catch(e){Lt.e(this.TAG,"[Audio Device Change]",e),this.eventBus.analytics.publish(pr.deviceChange({selection:{audioInput:t},devices:this.getDevices(),error:e})),this.eventBus.deviceChange.publish({error:e,selection:t,type:"audioInput",devices:this.getDevices()})}})),this.handleVideoInputDeviceChange=e=>_t(this,null,(function*(){if(!e)return void Lt.d(this.TAG,"No video track on local peer");if(!this.videoInputChanged)return void Lt.d(this.TAG,"No Change in VideoInput Device");let t=this.videoInput[0];if(!t||!t.deviceId)return void Lt.w(this.TAG,"Video device not found");let{settings:i}=e,r=(new Oi).codec(i.codec).maxBitrate(i.maxBitrate).maxFramerate(i.maxFramerate).setWidth(i.width).setHeight(i.height).deviceId(t.deviceId).build();try{yield e.setSettings(r,!0),this.eventBus.deviceChange.publish({devices:this.getDevices(),selection:t,type:"video"}),this.logDevices("Video Device Change Success")}catch(e){Lt.e(this.TAG,"[Video Device Change]",e),this.eventBus.analytics.publish(pr.deviceChange({selection:{videoInput:t},devices:this.getDevices(),error:e})),this.eventBus.deviceChange.publish({error:e,type:"video",selection:t,devices:this.getDevices()})}}));let i=({enabled:e,track:t})=>e&&"regular"===t.source;this.eventBus.localVideoEnabled.waitFor(i).then((()=>_t(this,null,(function*(){yield this.enumerateDevices(),this.videoInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})})))),this.eventBus.localAudioEnabled.waitFor(i).then((()=>_t(this,null,(function*(){yield this.enumerateDevices(),this.audioInputChanged&&this.eventBus.deviceChange.publish({devices:this.getDevices()})}))))}init(e=!1){return _t(this,null,(function*(){this.initialized&&!e||(!this.initialized&&navigator.mediaDevices.addEventListener("devicechange",this.handleDeviceChange),this.initialized=!0,yield this.enumerateDevices(),this.logDevices("Init"),this.setOutputDevice(),this.eventBus.deviceChange.publish({devices:this.getDevices()}),this.eventBus.analytics.publish(pr.deviceChange({selection:this.getCurrentSelection(),type:"list",devices:this.getDevices()})))}))}getDevices(){return{audioInput:this.audioInput,audioOutput:this.audioOutput,videoInput:this.videoInput}}cleanUp(){this.initialized=!1,this.audioInput=[],this.audioOutput=[],this.videoInput=[],this.outputDevice=void 0,navigator.mediaDevices.removeEventListener("devicechange",this.handleDeviceChange)}createIdentifier(e){return e?`${e.deviceId}${e.groupId}`:""}getNewAudioInputDevice(){let e=this.audioInput.find((e=>"default"===e.deviceId));return e?this.audioInput.find((t=>t.label!==e.label&&e.label.includes(t.label))):this.audioInput[0]}setOutputDevice(e=!1){let t=this.getNewAudioInputDevice(),i=this.createIdentifier(this.outputDevice);this.outputDevice=void 0,(null==t?void 0:t.groupId)&&(this.outputDevice=this.audioOutput.find((e=>"default"!==t.deviceId&&e.label===t.label))),this.outputDevice||(this.outputDevice=this.audioOutput.find((e=>"default"===e.deviceId))||this.audioOutput[0]),this.store.updateAudioOutputDevice(this.outputDevice),e&&i!==this.createIdentifier(this.outputDevice)&&this.eventBus.deviceChange.publish({selection:this.outputDevice,type:"audioOutput",devices:this.getDevices()})}logDevices(e=""){Lt.d(this.TAG,e,JSON.stringify({videoInput:[...this.videoInput],audioInput:[...this.audioInput],audioOutput:[...this.audioOutput],selected:this.getCurrentSelection()},null,4))}}(this.store,this.eventBus),this.audioSinkManager=new class{constructor(e,t,i){this.store=e,this.deviceManager=t,this.eventBus=i,this.autoPausedTracks=new Set,this.TAG="[AudioSinkManager]:",this.volume=100,this.state=Rt({},Fr),this.handleAudioPaused=e=>{var t;let i=null==(t=e.target.srcObject)?void 0:t.getAudioTracks()[0];if(!(null==i?void 0:i.enabled))return;Lt.d(this.TAG,"Audio Paused",e.target.id);let r=this.store.getTrackById(e.target.id);r&&("mobile"===Ei.getDevice().type?setTimeout((()=>_t(this,null,(function*(){r&&(yield this.playAudioFor(r))}))),500):this.autoPausedTracks.add(r))},this.handleTrackUpdate=({track:e,enabled:t})=>{var i;(null==(i=window.HMS)?void 0:i.AUDIO_SINK)&&(t?(e.addSink(),this.playAudioFor(e)):e.removeSink())},this.handleTrackAdd=e=>_t(this,[e],(function*({track:e,peer:t}){var i,r,n;let s=document.createElement("audio");s.style.display="none",s.id=e.trackId,s.addEventListener("pause",this.handleAudioPaused),e.setAudioElement(s),e.setVolume(this.volume),Lt.d(this.TAG,"Audio track added",e.trackId),null==(i=this.audioSink)||i.append(s),this.outputDevice&&(yield e.setOutputDevice(this.outputDevice)),(null==(r=window.HMS)?void 0:r.AUDIO_SINK)?e.enabled?e.addSink():e.removeSink():s.srcObject=new MediaStream([e.nativeTrack]),null==(n=this.listener)||n.onTrackUpdate(It.TRACK_ADDED,e,t),yield this.handleAutoplayError(e)})),this.handleAutoplayError=e=>_t(this,null,(function*(){void 0===this.state.autoplayFailed&&(this.state.autoplayCheckPromise||(this.state.autoplayCheckPromise=new Promise((t=>{this.playAudioFor(e).then(t)}))),yield this.state.autoplayCheckPromise),this.state.autoplayFailed?this.autoPausedTracks.add(e):yield this.playAudioFor(e)})),this.handleAudioDeviceChange=e=>{e.error||!e.selection||"video"===e.type||this.unpauseAudioTracks()},this.handleTrackRemove=e=>{this.autoPausedTracks.delete(e);let t=document.getElementById(e.trackId);t&&(t.removeEventListener("pause",this.handleAudioPaused),t.srcObject=null,t.remove(),e.setAudioElement(null)),this.audioSink&&0===this.audioSink.childElementCount&&(this.state.autoplayCheckPromise=void 0,this.state.autoplayFailed=void 0),Lt.d(this.TAG,"Audio track removed",e.trackId)},this.unpauseAudioTracks=()=>_t(this,null,(function*(){let e=[];this.autoPausedTracks.forEach((t=>{e.push(this.playAudioFor(t))})),yield Promise.all(e)})),this.eventBus.audioTrackAdded.subscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.subscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.subscribe(this.handleTrackUpdate),this.eventBus.deviceChange.subscribe(this.handleAudioDeviceChange)}setListener(e){this.listener=e}get outputDevice(){return this.deviceManager.outputDevice}getVolume(){return this.volume}setVolume(e){this.store.updateAudioOutputVolume(e),this.volume=e}unblockAutoplay(){return _t(this,null,(function*(){this.autoPausedTracks.size>0&&this.unpauseAudioTracks()}))}init(e){if(this.state.initialized)return;this.state.initialized=!0;let t=document.createElement("div");t.id=`HMS-SDK-audio-sink-${vt()}`,(e&&document.getElementById(e)||document.body).append(t),this.audioSink=t}cleanUp(){var e;null==(e=this.audioSink)||e.remove(),this.audioSink=void 0,this.eventBus.audioTrackAdded.unsubscribe(this.handleTrackAdd),this.eventBus.audioTrackRemoved.unsubscribe(this.handleTrackRemove),this.eventBus.audioTrackUpdate.unsubscribe(this.handleTrackUpdate),this.eventBus.deviceChange.unsubscribe(this.handleAudioDeviceChange),this.autoPausedTracks=new Set,this.state=Rt({},Fr)}playAudioFor(e){return _t(this,null,(function*(){let t=e.getAudioElement();if(t)try{yield t.play(),this.state.autoplayFailed=!1,this.autoPausedTracks.delete(e),Lt.d(this.TAG,"Played track",e.trackId)}catch(t){this.autoPausedTracks.add(e),Lt.e(this.TAG,"Failed to play track",e.trackId,t);let i=t;if(!this.state.autoplayFailed&&"NotAllowedError"===i.name){this.state.autoplayFailed=!0;let e=Jt.AutoplayBlocked(Vt.AUTOPLAY,"");e.addNativeError(i),this.eventBus.analytics.publish(pr.autoplayError()),this.eventBus.autoplayError.publish(e)}}else Lt.w(this.TAG,"No audio element found on track",e.trackId)}))}}(this.store,this.deviceManager,this.eventBus),this.audioOutput=new class{constructor(e,t){this.deviceManager=e,this.audioSinkManager=t}getVolume(){return this.audioSinkManager.getVolume()}setVolume(e){if(e<0||e>100)throw Error("Please pass a valid number between 0-100");this.audioSinkManager.setVolume(e)}getDevice(){return this.deviceManager.outputDevice}setDevice(e){return this.deviceManager.updateOutputDevice(e)}unblockAutoplay(){return _t(this,null,(function*(){yield this.audioSinkManager.unblockAutoplay()}))}}(this.deviceManager,this.audioSinkManager),this.audioSinkManager.setListener(this.listener),this.eventBus.autoplayError.subscribe(this.handleAutoplayError),this.localTrackManager=new fr(this.store,this.observer,this.deviceManager,this.eventBus,this.analyticsTimer),this.analyticsEventsService=new class{constructor(e){this.store=e,this.bufferSize=100,this.transport=null,this.pendingEvents=[],this.level=qi.INFO}setTransport(e){this.transport=e}reset(){this.transport=null,this.pendingEvents=[]}queue(e){if(e.level>=this.level&&(this.pendingEvents.push(e),this.pendingEvents.length>this.bufferSize)){let e=this.pendingEvents.shift();Lt.d(Gr,"Max buffer size reached","Removed event to accommodate new events",e)}return this}flushFailedClientEvents(){_r.flushFailedEvents()}flush(){var e;try{for(;this.pendingEvents.length>0;){let t=this.pendingEvents.shift();t&&(t.metadata.peer.peer_id=null==(e=this.store.getLocalPeer())?void 0:e.peerId,this.transport&&this.transport.transportProvider.isConnected?this.transport.sendEvent(t):this.sendClientEventOnHTTP(t))}}catch(e){Lt.w(Gr,"Flush Failed",e)}}sendClientEventOnHTTP(e){var t,i,r,n;let s=this.store.getRoom(),a=this.store.getLocalPeer();e.metadata.token=null==(t=this.store.getConfig())?void 0:t.authToken,e.metadata.peer={session_id:s.sessionId,room_id:s.id,room_name:s.name,template_id:s.templateId,joined_at:null==(i=s.joinedAt)?void 0:i.getTime(),session_started_at:null==(r=s.startedAt)?void 0:r.getTime(),role:null==(n=null==a?void 0:a.role)?void 0:n.name,user_name:null==a?void 0:a.name,user_data:null==a?void 0:a.metadata},_r.sendEvent(e)}}(this.store),this.transport=new class{constructor(e,t,i,r,n,s,a){var o,l;this.observer=e,this.deviceManager=t,this.store=i,this.localTrackManager=r,this.eventBus=n,this.analyticsEventsService=s,this.analyticsTimer=a,this.state=Tr.Disconnected,this.trackStates=new Map,this.publishConnection=null,this.subscribeConnection=null,this.maxSubscribeBitrate=0,this.callbacks=new Map,this.signalObserver={onOffer:e=>_t(this,null,(function*(){try{if(!this.subscribeConnection)return;yield this.subscribeConnection.setRemoteDescription(e),Lt.d(xr,`[SUBSCRIBE] Adding ${this.subscribeConnection.candidates.length} ice-candidates`,this.subscribeConnection.candidates);for(let e of this.subscribeConnection.candidates)yield this.subscribeConnection.addIceCandidate(e);this.subscribeConnection.candidates.length=0;let t=yield this.subscribeConnection.createAnswer();yield this.subscribeConnection.setLocalDescription(t),this.signal.answer(t),Lt.d(xr,"[role=SUBSCRIBE] onOffer renegotiation DONE ")}catch(e){let t;throw Lt.d(xr,"[role=SUBSCRIBE] onOffer renegotiation FAILED "),this.state=Tr.Failed,t=e instanceof $t?e:Qt.Unknown(Vt.PUBLISH,e.message),this.eventBus.analytics.publish(pr.subscribeFail(t)),t}})),onTrickle:e=>_t(this,null,(function*(){let t=e.target===Gt.Publish?this.publishConnection:this.subscribeConnection;(null==t?void 0:t.remoteDescription)?yield t.addIceCandidate(e.candidate):null==t||t.candidates.push(e.candidate)})),onNotification:e=>this.observer.onNotification(e),onServerError:e=>_t(this,null,(function*(){yield this.observer.onStateChange(Tr.Failed,e)})),onFailure:e=>{this.joinParameters&&this.retryScheduler.schedule({category:kr.SignalDisconnect,error:e,task:this.retrySignalDisconnectTask,originalState:this.state})},onOffline:e=>_t(this,null,(function*(){Lt.d(xr,"socket offline",Tr[this.state]);try{this.state!==Tr.Leaving&&this.joinParameters&&this.retryScheduler.schedule({category:kr.SignalDisconnect,error:Ht.WebSocketConnectionLost(Vt.RECONNECT_SIGNAL,e),task:this.retrySignalDisconnectTask,originalState:this.state})}catch(e){console.error(e)}})),onOnline:()=>{var e;Lt.d(xr,"socket online",Tr[this.state]),this.analyticsSignalTransport.flushFailedEvents(null==(e=this.store.getLocalPeer())?void 0:e.peerId)},onNetworkOnline:()=>{this.analyticsEventsService.flushFailedClientEvents()}},this.signal=new class{constructor(e){this.TAG="[ SIGNAL ]: ",this.pongResponseTimes=new _i(5),this.isJoinCompleted=!1,this.pendingTrickle=[],this.socket=null,this.callbacks=new Map,this._isConnected=!1,this.id=0,this.observer=e,window.addEventListener("offline",(()=>{Lt.d(this.TAG,"Window network offline"),this.setIsConnected(!1,"Window network offline")})),window.addEventListener("online",(()=>{Lt.d(this.TAG,"Window network online"),this.observer.onNetworkOnline()})),this.onCloseHandler=this.onCloseHandler.bind(this),this.onMessageHandler=this.onMessageHandler.bind(this)}get isConnected(){return this._isConnected}setIsConnected(e,t=""){Lt.d(this.TAG,`isConnected set id: ${this.id}, oldValue: ${this._isConnected}, newValue: ${e} }`),this._isConnected!==e&&(this._isConnected&&!e?(this._isConnected=e,this.observer.onOffline(t)):!this._isConnected&&e&&(this._isConnected=e,this.observer.onOnline()))}getPongResponseTimes(){return this.pongResponseTimes.toList()}call(e,t){return _t(this,null,(function*(){var i;let r=vt(),n={method:e,params:t,id:r,jsonrpc:"2.0"};null==(i=this.socket)||i.send(JSON.stringify(n));try{return yield new Promise(((e,t)=>{this.callbacks.set(r,{resolve:e,reject:t})}))}catch(t){let i=t;throw zt.ServerErrors(Number(i.code),function(e){switch(e){case vi.JOIN:return Vt.JOIN;case vi.OFFER:return Vt.PUBLISH;case vi.ANSWER:return Vt.SUBSCRIBE;case vi.TRACK_UPDATE:return Vt.TRACK;default:return Vt.NONE}}(e),i.message)}}))}notify(e,t){var i;let r={method:e,params:t};null==(i=this.socket)||i.send(JSON.stringify(r))}open(e){return new Promise(((t,i)=>{this.socket&&(this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)),this.socket=new WebSocket(e);let r=e=>{Lt.e(this.TAG,"Error from websocket",e),i(Ht.FailedToConnect(Vt.JOIN,`Error opening websocket connection - ${e}`))};this.socket.addEventListener("error",r);let n=()=>{var e,i;t(),this.setIsConnected(!0),this.id++,null==(e=this.socket)||e.removeEventListener("open",n),null==(i=this.socket)||i.removeEventListener("error",r),this.pingPongLoop(this.id)};this.socket.addEventListener("open",n),this.socket.addEventListener("close",this.onCloseHandler),this.socket.addEventListener("message",this.onMessageHandler)}))}close(){return _t(this,null,(function*(){this.socket?(this.socket.close(1e3,"Normal Close"),this.setIsConnected(!1,"code: 1000, normal websocket close"),this.socket.removeEventListener("close",this.onCloseHandler),this.socket.removeEventListener("message",this.onMessageHandler)):this.setIsConnected(!1,"websocket not connected yet")}))}join(e,t,i,r,n){return _t(this,null,(function*(){if(!this.isConnected)throw Ht.WebSocketConnectionLost(Vt.JOIN,"Failed to send join over WS connection");let s={name:e,disableVidAutoSub:i,data:t,offer:n,server_sub_degrade:r},a=yield this.callWithRetry(vi.JOIN,s);return this.isJoinCompleted=!0,this.pendingTrickle.forEach((({target:e,candidate:t})=>this.trickle(e,t))),this.pendingTrickle.length=0,Lt.d(this.TAG,`join: response=${JSON.stringify(a,null,1)}`),a}))}trickle(e,t){this.isJoinCompleted?this.notify(vi.TRICKLE,{target:e,candidate:t}):this.pendingTrickle.push({target:e,candidate:t})}offer(e,t){return _t(this,null,(function*(){return yield this.callWithRetry(vi.OFFER,{desc:e,tracks:Object.fromEntries(t)})}))}answer(e){this.notify(vi.ANSWER,{desc:e})}trackUpdate(e){this.notify(vi.TRACK_UPDATE,{version:"1.0",tracks:Object.fromEntries(e)})}broadcast(e){return _t(this,null,(function*(){return yield this.call(vi.BROADCAST,Rt({version:"1.0"},e.toSignalParams()))}))}leave(){this.notify(vi.LEAVE,{version:"1.0"})}endRoom(e,t){return _t(this,null,(function*(){yield this.call(vi.END_ROOM,{lock:e,reason:t})}))}sendEvent(e){if(!this.isConnected)throw Error(`${this.TAG} not connected. Could not send event ${e}`);this.notify(vi.ANALYTICS,e.toSignalParams())}ping(e){let t=Date.now(),i=new Promise((i=>{setTimeout((()=>{i(Date.now()-t)}),e+1)})),r=this.call(vi.PING,{timestamp:t}).then((()=>Date.now()-t)).catch((()=>Date.now()-t));return Promise.race([i,r])}requestRoleChange(e){return _t(this,null,(function*(){yield this.call(vi.ROLE_CHANGE_REQUEST,e)}))}acceptRoleChangeRequest(e){return _t(this,null,(function*(){yield this.call(vi.ROLE_CHANGE,e)}))}requestTrackStateChange(e){return _t(this,null,(function*(){yield this.call(vi.TRACK_UPDATE_REQUEST,e)}))}requestMultiTrackStateChange(e){return _t(this,null,(function*(){yield this.call(vi.CHANGE_TRACK_MUTE_STATE_REQUEST,e)}))}removePeer(e){return _t(this,null,(function*(){yield this.call(vi.PEER_LEAVE_REQUEST,e)}))}startRTMPOrRecording(e){return _t(this,null,(function*(){yield this.call(vi.START_RTMP_OR_RECORDING_REQUEST,Rt({version:"1.0"},e))}))}stopRTMPAndRecording(){return _t(this,null,(function*(){yield this.call(vi.STOP_RTMP_AND_RECORDING_REQUEST,{version:"1.0"})}))}startHLSStreaming(e){return _t(this,null,(function*(){yield this.call(vi.START_HLS_STREAMING,Rt({version:"1.0"},e))}))}stopHLSStreaming(e){return _t(this,null,(function*(){yield this.call(vi.STOP_HLS_STREAMING,Rt({version:"1.0"},e))}))}updatePeer(e){return _t(this,null,(function*(){yield this.call(vi.UPDATE_PEER_METADATA,Rt({version:"1.0"},e))}))}onCloseHandler(e){Lt.d(`Websocket closed code=${e.code}`),this.setIsConnected(!1,`code: ${e.code}${1e3!==e.code?", unexpected websocket close":""}`)}onMessageHandler(e){let t=e.data,i=JSON.parse(t);if(i.id)this.handleResponseWithId(i);else{if(!i.method)throw Error(`WebSocket message has no 'method' or 'id' field, message=${i}`);this.handleResponseWithMethod(i)}}handleResponseWithId(e){let t=e,i=t.id;if(this.callbacks.has(i)){let e=this.callbacks.get(i);this.callbacks.delete(i),t.result?e.resolve(t.result):e.reject(t.error)}else this.observer.onNotification(t)}handleResponseWithMethod(e){switch(e.method){case vi.OFFER:this.observer.onOffer(e.params);break;case vi.TRICKLE:this.observer.onTrickle(e.params);break;case vi.SERVER_ERROR:this.observer.onServerError(zt.ServerErrors(Number(e.params.code),Vt.NONE,e.params.message));break;case vi.SERVER_WARNING:Lt.w(this.TAG,e.params);break;default:this.observer.onNotification(e)}}pingPongLoop(e){return _t(this,null,(function*(){var t,i;let r=(null==(t=window.HMS)?void 0:t.PING_TIMEOUT)||12e3;if(this.isConnected){let t=yield this.ping(r);this.pongResponseTimes.enqueue(t),t>r?(Lt.d(this.TAG,`Pong timeout ${e}, pageHidden=${"undefined"!=typeof document&&document.hidden}`),this.id===e&&this.setIsConnected(!1,"ping pong failure")):setTimeout((()=>this.pingPongLoop(e)),(null==(i=window.HMS)?void 0:i.PING_INTERVAL)||1e3)}}))}callWithRetry(e,t){return _t(this,null,(function*(){let i=zt.ServerErrors(500,e,`Default ${e} error`);for(let r=0;r<3;r++)try{return Lt.d(this.TAG,`Try number ${r+1} sending ${e}`,t),yield this.call(e,t)}catch(n){if(i=n,Lt.e(this.TAG,`Failed sending ${e}`,{method:e,try:r+1,params:t,error:i}),5!==parseInt(""+i.code/100)&&429!==i.code)break;let s=1e3*(2+2*Math.random());yield Ai(s)}throw Lt.e(`Sending ${e} over WS failed after 3 retries`,{method:e,params:t,error:i}),i}))}}(this.signalObserver),this.analyticsSignalTransport=new class extends class{constructor(){this.TAG="AnalyticsTransport"}sendEvent(e){try{this.sendSingleEvent(e),this.flushFailedEvents()}catch(e){Lt.w(this.TAG,"sendEvent failed",e)}}flushFailedEvents(e){var t;try{for(Lt.d(this.TAG,"Flushing failed events",this.failedEvents);this.failedEvents.size()>0;){let i=this.failedEvents.dequeue();i&&((null==(t=i.metadata)?void 0:t.peer.peer_id)!==e&&i.metadata.peer.peer_id?_r.sendEvent(i):this.sendSingleEvent(i))}}catch(e){Lt.w(this.TAG,"flushFailedEvents failed",e)}}sendSingleEvent(e){try{this.transportProvider.sendEvent(e),Lt.d(this.TAG,"Sent event",e.name,e)}catch(t){throw Lt.w(this.TAG,`${this.transportProvider.TAG}.sendEvent failed, adding to local storage events`,{event:e,error:t}),this.failedEvents.enqueue(e),t}}}{constructor(e){super(),this.transportProvider=e,this.failedEvents=new Ar}}(this.signal),this.publishConnectionObserver={onRenegotiationNeeded:()=>_t(this,null,(function*(){yield this.performPublishRenegotiation()})),onIceConnectionChange:e=>_t(this,null,(function*(){Lt.d("publisher ice connection state change, ",e)})),onConnectionStateChange:e=>_t(this,null,(function*(){Lt.d("publisher connection state change, ",e),"failed"===e&&(yield this.handleIceConnectionFailure(Gt.Publish))}))},this.subscribeConnectionObserver={onApiChannelMessage:e=>{this.observer.onNotification(JSON.parse(e))},onTrackAdd:e=>{Lt.d(xr,"[Subscribe] onTrackAdd",e),this.observer.onTrackAdd(e)},onTrackRemove:e=>{Lt.d(xr,"[Subscribe] onTrackRemove",e),this.observer.onTrackRemove(e)},onIceConnectionChange:e=>_t(this,null,(function*(){if(Lt.d("subscriber ice connection state change, ",e),"connected"===e){let e=this.callbacks.get(li);this.callbacks.delete(li),e&&e.promise.resolve(!0)}})),onConnectionStateChange:e=>_t(this,null,(function*(){if(Lt.d("subscriber connection state change, ",e),"failed"===e&&(yield this.handleIceConnectionFailure(Gt.Subscribe)),"connected"===e){let e=this.callbacks.get(li);this.callbacks.delete(li),e&&e.promise.resolve(!0)}}))},this.handleLocalRoleUpdate=e=>_t(this,[e],(function*({oldRole:e,newRole:t}){this.doesRoleNeedWebRTC(e)||!this.doesRoleNeedWebRTC(t)||(Lt.i(xr,"Local peer role updated to webrtc role, creating PeerConnections and performing inital publish negotiation "),this.createPeerConnections(),yield this.negotiateOnFirstPublish())})),this.retryPublishIceFailedTask=()=>_t(this,null,(function*(){if(this.publishConnection&&("connected"!==this.publishConnection.iceConnectionState||"connected"!==this.publishConnection.connectionState)){let e=new Promise(((e,t)=>{this.callbacks.set(ai,{promise:{resolve:e,reject:t},action:Vt.RESTART_ICE,extra:{}})}));yield this.performPublishRenegotiation({iceRestart:!0}),yield e}return!0})),this.retrySubscribeIceFailedTask=()=>_t(this,null,(function*(){if(this.subscribeConnection&&("connected"!==this.subscribeConnection.iceConnectionState||"connected"!==this.subscribeConnection.connectionState)){let e=new Promise(((e,t)=>{this.callbacks.set(li,{promise:{resolve:e,reject:t},action:Vt.RESTART_ICE,extra:{}})})),t=new Promise((e=>{setTimeout(e,6e4,!1)}));return Promise.race([e,t])}return!0})),this.retrySignalDisconnectTask=()=>_t(this,null,(function*(){if(Lt.d(xr,"retrySignalDisconnectTask",{signalConnected:this.signal.isConnected}),!this.signal.isConnected)try{yield this.internalConnect(this.joinParameters.authToken,this.joinParameters.endpoint,this.joinParameters.peerId)}catch(e){}let e=this.store.getRoom().joinedAt?this.signal.isConnected&&(yield this.retryPublishIceFailedTask()):this.signal.isConnected;return this.signal.trackUpdate(this.trackStates),e})),this.webrtcInternals=new class{constructor(e,t,i,r){this.store=e,this.eventBus=t,this.publishConnection=i,this.subscribeConnection=r,this.TAG="[HMSWebrtcInternals]",this.interval=1e3,this.isMonitored=!1,this.handleStatsUpdate=()=>_t(this,null,(function*(){var e;yield null==(e=this.hmsStats)?void 0:e.updateStats(),this.eventBus.statsUpdate.publish(this.hmsStats)}))}getPublishPeerConnection(){return this.publishConnection}getSubscribePeerConnection(){return this.subscribeConnection}getCurrentStats(){return this.hmsStats}onStatsChange(e){return this.eventBus.statsUpdate.subscribe(e),()=>{this.eventBus.statsUpdate.unsubscribe(e)}}setPeerConnections({publish:e,subscribe:t}){var i,r;this.publishConnection=e,this.subscribeConnection=t,this.hmsStats=new class{constructor(e,t){var i;this.getStats=e,this.store=t,this.TAG="[HMSWebrtcStats]",this.peerStats={},this.trackStats={},this.localPeerID=null==(i=this.store.getLocalPeer())?void 0:i.peerId}getLocalPeerStats(){return this.peerStats[this.localPeerID]}getTrackStats(e){return this.trackStats[e]}updateStats(){return _t(this,null,(function*(){yield this.updateLocalPeerStats(),yield this.updateTrackStats()}))}updateLocalPeerStats(){return _t(this,null,(function*(){var e,t,i,r,n,s;let a,o=this.getLocalPeerStats();try{a=yield null==(t=(e=this.getStats).publish)?void 0:t.call(e)}catch(e){Lt.w(this.TAG,"Error in getting publish stats",e)}let l,c=a&&Dr("publish",a,o);try{l=yield null==(r=(i=this.getStats).subscribe)?void 0:r.call(i)}catch(e){Lt.w(this.TAG,"Error in getting subscribe stats",e)}let d=l&&Dr("subscribe",l,o),{packetsLost:u,jitter:h}=(e=>{let t={packetsLost:0,jitter:0};return null==e||e.forEach((e=>{e.packetsLost&&(t.packetsLost+=e.packetsLost),e.jitter>t.jitter&&(t.jitter=e.jitter)})),t})(l),p=Lr(u,null==(n=null==o?void 0:o.subscribe)?void 0:n.packetsLost,null==d?void 0:d.timestamp,null==(s=null==o?void 0:o.subscribe)?void 0:s.timestamp),v=d&&Object.assign(d,{packetsLostRate:p,jitter:h,packetsLost:u});this.peerStats[this.localPeerID]={publish:c,subscribe:v}}))}updateTrackStats(){return _t(this,null,(function*(){var e;let t=this.store.getTracksMap(),i=((e,t)=>Array.from(new Set(e.concat(t))))(Object.keys(this.trackStats),Object.keys(t));for(let r of i){let i=t[r];if(i){let t=i.peerId&&(null==(e=this.store.getPeerById(i.peerId))?void 0:e.name),n=this.getTrackStats(i.trackId),s=yield wr(this.getStats,i,t,n);s&&(this.trackStats[r]=s)}else delete this.trackStats[r]}}))}}({publish:null==(i=this.publishConnection)?void 0:i.getStats.bind(this.publishConnection),subscribe:null==(r=this.subscribeConnection)?void 0:r.getStats.bind(this.subscribeConnection)},this.store)}start(){return _t(this,null,(function*(){this.isMonitored?Lt.d(this.TAG,"Already started"):(this.stop(),this.isMonitored=!0,Lt.d(this.TAG,"Starting Webrtc Stats Monitor"),this.startLoop().then((()=>Lt.d(this.TAG,"Stopping Webrtc Stats Monitor"))).catch((e=>Lt.e(this.TAG,e.message))))}))}stop(){this.isMonitored=!1}startLoop(){return _t(this,null,(function*(){for(;this.isMonitored;)yield this.handleStatsUpdate(),yield Ai(this.interval)}))}cleanUp(){this.stop(),this.eventBus.statsUpdate.removeAllListeners()}}(this.store,this.eventBus,null==(o=this.publishConnection)?void 0:o.nativeConnection,null==(l=this.subscribeConnection)?void 0:l.nativeConnection),this.retryScheduler=new class{constructor(e,t){this.onStateChange=e,this.sendEvent=t,this.inProgress=new Map,this.retryTaskIds=[]}schedule(e){return _t(this,arguments,(function*({category:e,error:t,task:i,originalState:r,maxFailedRetries:n=5,changeState:s=!0}){yield this.scheduleTask({category:e,error:t,changeState:s,task:i,originalState:r,maxFailedRetries:n})}))}reset(){this.retryTaskIds.forEach((e=>clearTimeout(e))),this.retryTaskIds=[],this.inProgress.clear()}scheduleTask(e){return _t(this,arguments,(function*({category:e,error:t,changeState:i,task:r,originalState:n,maxFailedRetries:s=5,failedRetryCount:a=0}){if(Lt.d(Pr,"schedule: ",{category:kr[e],error:t}),0===a){let i=this.inProgress.get(e);if(i)return Lt.d(Pr,`schedule: Already a task for ${kr[e]} scheduled, waiting for its completion`),void(yield i.promise);let r=new class{constructor(e){this.promise=new Promise(((t,i)=>{this.resolve=t,this.reject=i,e(t,i)}))}}(((e,t)=>{}));this.inProgress.set(e,r),this.sendEvent(t,e)}let o=!1,l=Cr[e];for(let t in l){let i=l[parseInt(t)];try{let t=this.inProgress.get(i);t&&(Lt.d(Pr,`schedule: Suspending retry task of ${kr[e]}, waiting for ${kr[i]} to recover`),yield t.promise,Lt.d(Pr,`schedule: Resuming retry task ${kr[e]} as it's dependency ${kr[i]} is recovered`))}catch(t){Lt.d(Pr,`schedule: Stopping retry task of ${kr[e]} as it's dependency ${kr[i]} failed to recover`),o=!0;break}}if(a>=s||o){if(t.description+=`. [${kr[e]}] Could not recover after ${a} tries`,o&&(t.description+=` Could not recover all of it's required dependencies - [${l.map((e=>kr[e])).toString()}]`),t.isTerminal=!0,this.inProgress.delete(e),this.sendEvent(t,e),this.reset(),!i)throw t;return void this.onStateChange(Tr.Failed,t)}i&&this.onStateChange(Tr.Reconnecting,t);let c,d=this.getDelayForRetryCount(a);Lt.i(Pr,`schedule: [${kr[e]}] [failedRetryCount=${a}] Scheduling retry task in ${d}ms`);try{c=yield this.setTimeoutPromise(r,d)}catch(t){c=!1,Lt.w(Pr,`[${kr[e]}] Un-caught exception ${t.name} in retry-task, initiating retry`,t)}if(c){let t=this.inProgress.get(e);this.inProgress.delete(e),null==t||t.resolve(a),i&&0===this.inProgress.size&&this.onStateChange(n),Lt.i(Pr,`schedule: [${kr[e]}] [failedRetryCount=${a}] Recovered `)}else yield this.scheduleTask({category:e,error:t,changeState:i,task:r,originalState:n,maxFailedRetries:s,failedRetryCount:a+1})}))}getDelayForRetryCount(e){let t=Math.pow(2,e),i=Math.random();return Math.round(1e3*Math.min(t+i,60))}setTimeoutPromise(e,t){return _t(this,null,(function*(){return new Promise(((i,r)=>{let n=window.setTimeout((()=>_t(this,null,(function*(){try{let t=yield e();t&&this.retryTaskIds.splice(this.retryTaskIds.indexOf(n),1),i(t)}catch(e){r(e)}}))),t);this.retryTaskIds.push(n)}))}))}}(((e,t)=>_t(this,null,(function*(){e!==this.state&&(this.state=e,yield this.observer.onStateChange(this.state,t))}))),this.sendErrorAnalyticsEvent.bind(this)),this.eventBus.statsUpdate.subscribe((e=>{var t,i;let r=(null==(i=null==(t=e.getLocalPeerStats())?void 0:t.subscribe)?void 0:i.bitrate)||0;this.maxSubscribeBitrate=Math.max(this.maxSubscribeBitrate,r)}))}getLocalScreen(e,t){return _t(this,null,(function*(){try{return yield this.localTrackManager.getLocalScreen(e,t)}catch(i){throw i instanceof $t&&this.eventBus.analytics.publish(pr.publish({error:i,devices:this.deviceManager.getDevices(),settings:new Li(e,t,!1)})),i}}))}getWebrtcInternals(){return this.webrtcInternals}isFlagEnabled(e){var t;let i=null==(t=this.initConfig)?void 0:t.config;return((null==i?void 0:i.enabledFlags)||[]).includes(e)}preview(e,t,i,r,n=!1){return _t(this,null,(function*(){let s=yield this.connect(e,t,i,r,n);return this.state=Tr.Preview,this.observer.onStateChange(this.state),s}))}join(e,t,i,r,n=!1){return _t(this,null,(function*(){Lt.d(xr,"join: started ");try{(!this.signal.isConnected||!this.initConfig)&&(yield this.connect(e,r,t,i,n)),this.validateNotDisconnected("connect");let s=this.isFlagEnabled(Sr.FLAG_SERVER_SUB_DEGRADATION);this.initConfig&&(yield this.waitForLocalRoleAvailability(),yield this.createConnectionsAndNegotiateJoin(i,n,s),yield this.initRtcStatsMonitor(),Lt.d(xr," join: Negotiated over PUBLISH connection"))}catch(t){Lt.e(xr,`join: failed  [token=${e}]`,t),this.state=Tr.Failed;let i=t;throw i.isTerminal=500===i.code,yield this.observer.onStateChange(this.state,i),i}Lt.i(xr," join: successful"),this.state=Tr.Joined,this.observer.onStateChange(this.state)}))}connect(e,t,i,r,n=!1){return _t(this,null,(function*(){this.setTransportStateForConnect(),this.joinParameters=new class{constructor(e,t,i="",r="",n="https://prod-init.100ms.live/init",s=!1){this.authToken=e,this.peerId=t,this.peerName=i,this.data=r,this.endpoint=n,this.autoSubscribeVideo=s}}(e,i,r.name,r.metaData,t,n);try{return yield this.internalConnect(e,t,i)}catch(r){if(!(r instanceof $t&&([Kt.WebSocketConnectionErrors.WEBSOCKET_CONNECTION_LOST,Kt.WebSocketConnectionErrors.FAILED_TO_CONNECT,Kt.InitAPIErrors.ENDPOINT_UNREACHABLE].includes(r.code)||r.code.toString().startsWith("5")||r.code.toString().startsWith("429"))))throw r;{let n=()=>_t(this,null,(function*(){return yield this.internalConnect(e,t,i),Boolean(this.initConfig&&this.initConfig.endpoint)}));yield this.retryScheduler.schedule({category:kr.ConnectFailed,error:r,task:n,originalState:this.state,maxFailedRetries:5,changeState:!1})}}}))}leave(){return _t(this,null,(function*(){var e,t,i,r;this.retryScheduler.reset(),this.joinParameters=void 0;try{this.state=Tr.Leaving,null==(e=this.webrtcInternals)||e.cleanUp(),null==(t=this.trackDegradationController)||t.cleanUp(),yield null==(i=this.publishConnection)?void 0:i.close(),yield null==(r=this.subscribeConnection)?void 0:r.close();try{this.signal.leave()}catch(e){Lt.w(xr,"failed to send leave on websocket to server",e)}this.analyticsEventsService.flushFailedClientEvents(),this.analyticsEventsService.reset(),yield this.signal.close()}catch(e){e instanceof $t&&this.eventBus.analytics.publish(pr.disconnect(e)),Lt.e(xr,"leave: FAILED ",e)}finally{this.state=Tr.Disconnected,this.observer.onStateChange(this.state)}}))}publish(e){return _t(this,null,(function*(){for(let t of e)try{yield this.publishTrack(t)}catch(e){e instanceof $t&&this.eventBus.analytics.publish(pr.publish({devices:this.deviceManager.getDevices(),error:e}))}}))}unpublish(e){return _t(this,null,(function*(){for(let t of e)yield this.unpublishTrack(t)}))}sendMessage(e){return _t(this,null,(function*(){return yield this.signal.broadcast(e)}))}trackUpdate(e){let t=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));if(t){let i=new br(Ct(Rt({},t),{mute:!e.enabled}));this.trackStates.set(t.track_id,i),Lt.d(xr,"Track Update",this.trackStates,e),this.signal.trackUpdate(new Map([[t.track_id,i]]))}}changeRole(e,t,i=!1){return _t(this,null,(function*(){yield this.signal.requestRoleChange({requested_for:e.peerId,role:t,force:i})}))}acceptRoleChange(e){return _t(this,null,(function*(){yield this.signal.acceptRoleChangeRequest({role:e.role.name,token:e.token})}))}endRoom(e,t){return _t(this,null,(function*(){yield this.signal.endRoom(e,t)}))}removePeer(e,t){return _t(this,null,(function*(){yield this.signal.removePeer({requested_for:e,reason:t})}))}startRTMPOrRecording(e){return _t(this,null,(function*(){var t;let i={meeting_url:e.meetingURL,record:e.record};(null==(t=e.rtmpURLs)?void 0:t.length)&&(i.rtmp_urls=e.rtmpURLs),e.resolution&&(i.resolution=e.resolution),yield this.signal.startRTMPOrRecording(i)}))}stopRTMPOrRecording(){return _t(this,null,(function*(){yield this.signal.stopRTMPAndRecording()}))}startHLSStreaming(e){return _t(this,null,(function*(){let t={variants:e.variants.map((e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t}))};e.recording&&(t.hls_recording={single_file_per_layer:e.recording.singleFilePerLayer,hls_vod:e.recording.hlsVod}),yield this.signal.startHLSStreaming(t)}))}stopHLSStreaming(e){return _t(this,null,(function*(){if(e){let t={variants:null==e?void 0:e.variants.map((e=>{let t={meeting_url:e.meetingURL};return e.metadata&&(t.metadata=e.metadata),t}))};yield this.signal.stopHLSStreaming(t)}yield this.signal.stopHLSStreaming()}))}changeName(e){return _t(this,null,(function*(){yield this.signal.updatePeer({name:e})}))}changeMetadata(e){return _t(this,null,(function*(){yield this.signal.updatePeer({data:e})}))}changeTrackState(e){return _t(this,null,(function*(){yield this.signal.requestTrackStateChange(e)}))}changeMultiTrackState(e){return _t(this,null,(function*(){yield this.signal.requestMultiTrackStateChange(e)}))}publishTrack(e){return _t(this,null,(function*(){e.publishedTrackId=e.nativeTrack.id,Lt.d(xr,` publishTrack: trackId=${e.trackId}, toPublishTrackId=${e.publishedTrackId}`,e),this.trackStates.set(e.publishedTrackId,new br(e));let t=new Promise(((e,t)=>{this.callbacks.set(ai,{promise:{resolve:e,reject:t},action:Vt.PUBLISH,extra:{}})})),i=e.stream;i.setConnection(this.publishConnection);let r=this.store.getSimulcastLayers(e.source);i.addTransceiver(e,r),Lt.time(`publish-${e.trackId}-${e.type}`),yield t,Lt.timeEnd(`publish-${e.trackId}-${e.type}`),this.store.addTrack(e);let n=e.settings.maxBitrate;n&&(yield i.setMaxBitrate(n,e).then((()=>{Lt.d(xr,`Setting maxBitrate for ${e.source} ${e.type} to ${n} kpbs`)})).catch((e=>Lt.e(xr,"Failed setting maxBitrate",e)))),Lt.d(xr,` publishTrack: trackId=${e.trackId}`,e,this.callbacks)}))}unpublishTrack(e){return _t(this,null,(function*(){if(Lt.d(xr,` unpublishTrack: trackId=${e.trackId}`,e),e.publishedTrackId&&this.trackStates.has(e.publishedTrackId))this.trackStates.delete(e.publishedTrackId);else{let t=Array.from(this.trackStates.values()).find((t=>e.type===t.type&&e.source===t.source));t&&this.trackStates.delete(t.track_id)}let t=new Promise(((e,t)=>{this.callbacks.set(ai,{promise:{resolve:e,reject:t},action:Vt.UNPUBLISH,extra:{}})}));e.stream.removeSender(e),yield t,yield e.cleanup(),this.store.removeTrack(e.trackId),Lt.d(xr,` unpublishTrack: trackId=${e.trackId}`,this.callbacks)}))}waitForLocalRoleAvailability(){if(!this.store.hasRoleDetailsArrived())return new Promise((e=>{this.eventBus.policyChange.subscribeOnce((()=>e()))}))}createConnectionsAndNegotiateJoin(e,t=!1,i=!0){return _t(this,null,(function*(){let r=this.doesLocalPeerNeedWebRTC();r&&this.createPeerConnections(),yield this.negotiateJoin(e.name,e.metaData,t,i,r)}))}createPeerConnections(){this.initConfig&&(this.publishConnection||(this.publishConnection=new ci(this.signal,this.initConfig.rtcConfiguration,this.publishConnectionObserver,this)),this.subscribeConnection||(this.subscribeConnection=new Si(this.signal,this.initConfig.rtcConfiguration,this.subscribeConnectionObserver)))}negotiateJoin(e,t,i,r,n=!0){return _t(this,null,(function*(){try{return n?yield this.negotiateJoinWebRTC(e,t,i,r):yield this.negotiateJoinNonWebRTC(e,t,i,r)}catch(s){Lt.e(xr,"Publish negotiation failed ",s);let a=()=>_t(this,null,(function*(){return yield this.negotiateJoin(e,t,i,r,n)}));return yield this.retryScheduler.schedule({category:kr.PublishNegotiationFailed,error:qt.SetRemoteDescriptionFailed(Vt.JOIN,"Failed to send join over WS connection"),task:a,originalState:Tr.Joined}),!1}}))}negotiateJoinWebRTC(e,t,i,r){return _t(this,null,(function*(){if(Lt.d(xr," join: Negotiating over PUBLISH connection"),!this.publishConnection)return Lt.e(xr,"Publish peer connection not found, cannot negotiate"),!1;let n=yield this.publishConnection.createOffer();yield this.publishConnection.setLocalDescription(n);let s=yield this.signal.join(e,t,!i,r,n);yield this.publishConnection.setRemoteDescription(s);for(let e of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(e);return this.publishConnection.initAfterJoin(),!!s}))}negotiateJoinNonWebRTC(e,t,i,r){return _t(this,null,(function*(){return Lt.d(xr," join: Negotiating Non-WebRTC"),!!(yield this.signal.join(e,t,!i,r))}))}negotiateOnFirstPublish(){return _t(this,null,(function*(){if(Lt.d(xr," Negotiating offer over PUBLISH connection"),!this.publishConnection)return Lt.e(xr,"Publish peer connection not found, cannot negotiate"),!1;let e=yield this.publishConnection.createOffer(this.trackStates);yield this.publishConnection.setLocalDescription(e);let t=yield this.signal.offer(e,this.trackStates);yield this.publishConnection.setRemoteDescription(t);for(let e of this.publishConnection.candidates)yield this.publishConnection.addIceCandidate(e);return this.publishConnection.initAfterJoin(),!!t}))}performPublishRenegotiation(e){return _t(this,null,(function*(){Lt.d(xr," [role=PUBLISH] onRenegotiationNeeded START",this.trackStates);let t=this.callbacks.get(ai);if(t){if(!this.publishConnection)return void Lt.e(xr,"Publish peer connection not found, cannot renegotiate");try{let i=yield this.publishConnection.createOffer(this.trackStates,e);yield this.publishConnection.setLocalDescription(i),Lt.time("renegotiation-offer-exchange");let r=yield this.signal.offer(i,this.trackStates);this.callbacks.delete(ai),Lt.timeEnd("renegotiation-offer-exchange"),yield this.publishConnection.setRemoteDescription(r),t.promise.resolve(!0),Lt.d(xr,"[role=PUBLISH] onRenegotiationNeeded DONE ")}catch(e){let i;i=e instanceof $t?e:Qt.Unknown(Vt.PUBLISH,e.message),t.promise.reject(i),Lt.d(xr,"[role=PUBLISH] onRenegotiationNeeded FAILED ")}}}))}handleIceConnectionFailure(e){return _t(this,null,(function*(){e===Gt.Publish?this.retryScheduler.schedule({category:kr.PublishIceConnectionFailed,error:qt.ICEFailure(Vt.PUBLISH),task:this.retryPublishIceFailedTask,originalState:Tr.Joined}):this.retryScheduler.schedule({category:kr.SubscribeIceConnectionFailed,error:qt.ICEFailure(Vt.SUBSCRIBE),task:this.retrySubscribeIceFailedTask,originalState:Tr.Joined,maxFailedRetries:1})}))}internalConnect(e,t,i){return _t(this,null,(function*(){Lt.d(xr,"connect: started ");let r=new Date;try{return this.analyticsTimer.start(vr.INIT),this.initConfig=yield class{static handleError(e,t){switch(e.status){case 404:throw Wt.EndpointUnreachable(Vt.INIT,t.message||e.statusText);case 200:break;default:throw Wt.ServerErrors(t.code||e.status,Vt.INIT,t.message||(null==e?void 0:e.statusText))}}static fetchInitConfig(e,t,i="https://prod-init.100ms.live",r=""){return _t(this,null,(function*(){Lt.d(Pi,`fetchInitConfig: initEndpoint=${i} token=${e} peerId=${t} region=${r} `);let n=function(e,t,i){try{let r=new URL("/init",e);return i&&i.trim().length>0&&r.searchParams.set("region",i.trim()),r.searchParams.set("peer_id",t),r.searchParams.set("user_agent",Ci),r.toString()}catch(e){let t=e;throw Lt.e(Pi,t.name,t.message),t}}(i,t,r);try{let t=yield fetch(n,{headers:{Authorization:`Bearer ${e}`}}),i=yield t.json();return this.handleError(t,i),Lt.d(Pi,`config is ${JSON.stringify(i,null,2)}`),function(e){var t;return Ct(Rt({},e),{rtcConfiguration:Ct(Rt({},e.rtcConfiguration),{iceServers:null==(t=e.rtcConfiguration)?void 0:t.ice_servers})})}(i)}catch(e){let t=e;throw["Failed to fetch","NetworkError"].some((e=>t.message.includes(e)))?Wt.EndpointUnreachable(Vt.INIT,t.message):t}}))}}.fetchInitConfig(e,i,t),this.analyticsTimer.end(vr.INIT),this.validateNotDisconnected("post init"),yield this.openSignal(e,i),Lt.d(xr,"Adding Analytics Transport: JsonRpcSignal"),this.analyticsEventsService.setTransport(this.analyticsSignalTransport),this.analyticsEventsService.flush(),this.initConfig}catch(e){throw e instanceof $t&&this.state!==Tr.Reconnecting&&this.eventBus.analytics.publish(pr.connect(e,this.getAdditionalAnalyticsProperties(),r,new Date,t)),Lt.d(xr," internal connect: failed",e),e}}))}validateNotDisconnected(e){if(this.state===Tr.Disconnected)throw Lt.w(xr,"aborting join as transport state is disconnected"),Qt.ValidationFailed(`leave called before join could complete - stage=${e}`)}openSignal(e,t){return _t(this,null,(function*(){if(!this.initConfig)throw Wt.InitConfigNotAvailable(Vt.INIT,"Init Config not found");Lt.d(xr," internal connect: connecting to ws endpoint",this.initConfig.endpoint);let i=new URL(this.initConfig.endpoint);i.searchParams.set("peer",t),i.searchParams.set("token",e),i.searchParams.set("user_agent",Ci),this.endpoint=i.toString(),this.analyticsTimer.start(vr.WEBSOCKET_CONNECT),yield this.signal.open(this.endpoint),this.analyticsTimer.end(vr.WEBSOCKET_CONNECT),this.analyticsTimer.start(vr.ON_POLICY_CHANGE),Lt.d(xr," internal connect: connected to ws endpoint")}))}initRtcStatsMonitor(){return _t(this,null,(function*(){var e,t,i,r;null==(i=this.webrtcInternals)||i.setPeerConnections({publish:null==(e=this.publishConnection)?void 0:e.nativeConnection,subscribe:null==(t=this.subscribeConnection)?void 0:t.nativeConnection}),this.store.getSubscribeDegradationParams()&&(this.isFlagEnabled(Sr.FLAG_SERVER_SUB_DEGRADATION)||(yield null==(r=this.webrtcInternals)?void 0:r.start(),this.trackDegradationController=new class{constructor(e,t){this.store=e,this.eventBus=t,this.TAG="[TrackDegradationController]",this.MAX_RECOVER_GRACE_PERIOD=120,this.recoverAttemptCount=0,this.packetsLost=0;let i=this.store.getSubscribeDegradationParams();this.PACKETS_LOST_THRESHOLD=i.packetLossThreshold,this.MIN_DEGRADE_GRACE_PERIOD=i.degradeGracePeriodSeconds,this.MIN_RECOVER_GRACE_PERIOD=i.recoverGracePeriodSeconds,this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD}get isAttemptingRecover(){return Boolean(this.recoveringTrack)}handleRtcStatsChange(e){let t=e>this.packetsLost+this.PACKETS_LOST_THRESHOLD;this.packetsLost=e,t?this.degrade():this.recover()}degrade(){if(!(this.degradeGracePeriod>0))return this.isAttemptingRecover?this.cancelRecovery():(Lt.d(this.TAG,"Packet loss increased, Degrading",{packetsLost:this.packetsLost}),this.degradeActiveTracksByHalf(),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,void(this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD));this.degradeGracePeriod--}recover(){this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,this.recoverGracePeriod>0?this.recoverGracePeriod--:(this.recoveringTrack=this.getActiveTracks(!0).find((e=>e.degraded)),this.recoveringTrack&&(Lt.d(this.TAG,"Packet lost stable, recovering track",this.recoveringTrack),this.recoveringTrack.setDegradedFromSdk(!1),this.eventBus.trackRestored.publish(this.recoveringTrack),this.recoverGracePeriod=this.MIN_RECOVER_GRACE_PERIOD))}cleanUp(){this.eventBus.trackDegraded.removeAllListeners(),this.eventBus.trackRestored.removeAllListeners()}degradeActiveTracksByHalf(){let e=this.getActiveTracks(!1);if(!e.length)return;Lt.d(this.TAG,{activeTracks:[...e]});let t=Math.ceil(e.length/2);for(;t--;){let t=e.pop();t.setDegradedFromSdk(!0),this.eventBus.trackDegraded.publish(t)}}getActiveTracks(e){return this.store.getRemoteVideoTracks().filter((t=>t.hasSinks()&&(!t.degraded||e))).sort(((e,t)=>{let i=this.store.getComparator().getTrackComparators();return-1*(i.screenShare(e,t)||i.rolePriority(e,t)||i.peerAudioLevel(e,t)||this.store.getComparator().stringComparator(e.trackId,t.trackId))})).slice(0)}cancelRecovery(){this.recoveringTrack&&(this.recoveringTrack.setDegradedFromSdk(!0),this.eventBus.trackDegraded.publish(this.recoveringTrack)),this.recoveringTrack=void 0,this.recoverAttemptCount++,this.recoverGracePeriod=this.getDelayForRecoverCount(this.recoverAttemptCount),this.degradeGracePeriod=this.MIN_DEGRADE_GRACE_PERIOD,Lt.d(this.TAG,"Recover Attempt Failed",{count:this.recoverAttemptCount,delay:this.recoverGracePeriod})}getDelayForRecoverCount(e){let t=this.MIN_RECOVER_GRACE_PERIOD+this.MIN_RECOVER_GRACE_PERIOD*e;return Math.min(t,this.MAX_RECOVER_GRACE_PERIOD)}}(this.store,this.eventBus),this.eventBus.statsUpdate.subscribe((e=>{var t,i,r;null==(r=this.trackDegradationController)||r.handleRtcStatsChange((null==(i=null==(t=e.getLocalPeerStats())?void 0:t.subscribe)?void 0:i.packetsLost)||0)}))),this.eventBus.trackDegraded.subscribe((e=>{this.eventBus.analytics.publish(pr.degradationStats(e,!0)),this.observer.onTrackDegrade(e)})),this.eventBus.trackRestored.subscribe((e=>{this.eventBus.analytics.publish(pr.degradationStats(e,!1)),this.observer.onTrackRestore(e)})))}))}doesRoleNeedWebRTC(e){var t,i;if(!this.isFlagEnabled(Sr.FLAG_NON_WEBRTC_DISABLE_OFFER))return!0;let r=Boolean(e.publishParams.allowed&&(null==(t=e.publishParams.allowed)?void 0:t.length)>0),n=Boolean(e.subscribeParams.subscribeToRoles&&(null==(i=e.subscribeParams.subscribeToRoles)?void 0:i.length)>0);return r||n}doesLocalPeerNeedWebRTC(){var e;let t=null==(e=this.store.getLocalPeer())?void 0:e.role;return!t||this.doesRoleNeedWebRTC(t)}setTransportStateForConnect(){if(this.state===Tr.Failed&&(this.state=Tr.Disconnected),this.state!==Tr.Disconnected&&this.state!==Tr.Reconnecting)throw zt.AlreadyJoined(Vt.JOIN,`Cannot join a meeting in ${this.state} state`);this.state===Tr.Disconnected&&(this.state=Tr.Connecting,this.observer.onStateChange(this.state))}sendErrorAnalyticsEvent(e,t){let i,r=this.getAdditionalAnalyticsProperties();switch(t){case kr.ConnectFailed:i=pr.connect(e,r);break;case kr.SignalDisconnect:i=pr.disconnect(e,r);break;case kr.PublishNegotiationFailed:i=pr.join({error:e,time:this.analyticsTimer.getTimeTaken(vr.JOIN),init_response_time:this.analyticsTimer.getTimeTaken(vr.INIT),ws_connect_time:this.analyticsTimer.getTimeTaken(vr.WEBSOCKET_CONNECT),on_policy_change_time:this.analyticsTimer.getTimeTaken(vr.ON_POLICY_CHANGE),local_tracks_time:this.analyticsTimer.getTimeTaken(vr.LOCAL_TRACKS)});break;case kr.PublishIceConnectionFailed:i=pr.publish({error:e});break;case kr.SubscribeIceConnectionFailed:i=pr.subscribeFail(e)}this.eventBus.analytics.publish(i)}getAdditionalAnalyticsProperties(){var e,t,i,r,n,s,a,o;let l=(()=>{if(!Ri||void 0===navigator.connection)return;let e=navigator.connection;return{downlink:e.downlink,downlinkMax:e.downlinkMax,effectiveType:e.effectiveType,rtt:e.rtt,saveData:e.saveData,type:e.type}})(),c="undefined"!=typeof document&&document.hidden,d=this.store.getRemoteVideoTracks().filter((e=>e.degraded)).length;return{network_info:l,document_hidden:c,num_degraded_tracks:d,bitrate:{publish:null==(r=null==(i=null==(t=null==(e=this.getWebrtcInternals())?void 0:e.getCurrentStats())?void 0:t.getLocalPeerStats())?void 0:i.publish)?void 0:r.bitrate,subscribe:null==(o=null==(a=null==(s=null==(n=this.getWebrtcInternals())?void 0:n.getCurrentStats())?void 0:s.getLocalPeerStats())?void 0:a.subscribe)?void 0:o.bitrate},max_sub_bitrate:this.maxSubscribeBitrate,recent_pong_response_times:this.signal.getPongResponseTimes(),transport_state:this.state}}}(this.observer,this.deviceManager,this.store,this.localTrackManager,this.eventBus,this.analyticsEventsService,this.analyticsTimer),this.eventBus.analytics.subscribe(this.sendAnalyticsEvent),this.eventBus.deviceChange.subscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.subscribe(this.handleAudioPluginError)}validateJoined(e){if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,`Not connected - ${e}`)}refreshDevices(){return _t(this,null,(function*(){this.validateJoined("refreshDevices"),yield this.deviceManager.init(!0)}))}getWebrtcInternals(){var e;return null==(e=this.transport)?void 0:e.getWebrtcInternals()}getPlaylistManager(){return this.playlistManager}getRecordingState(){var e;return null==(e=this.store.getRoom())?void 0:e.recording}getRTMPState(){var e;return null==(e=this.store.getRoom())?void 0:e.rtmp}getHLSState(){var e;return null==(e=this.store.getRoom())?void 0:e.hls}get localPeer(){var e;return null==(e=this.store)?void 0:e.getLocalPeer()}preview(e,t){return _t(this,null,(function*(){if(ri(),ii(),this.sdkState.isPreviewInProgress)return Promise.reject(Qt.PreviewAlreadyInProgress(Vt.PREVIEW,"Preview already called"));this.analyticsTimer.start(vr.PREVIEW),this.setUpPreview(e,t),e.alwaysRequestPermissions&&this.localTrackManager.requestPermissions().then((()=>_t(this,null,(function*(){yield this.initDeviceManagers()}))));let i=!1,r=!1,n=setTimeout((()=>{var e,t;(!i||!r)&&(null==(t=null==(e=this.listener)?void 0:e.onNetworkQuality)||t.call(e,-1))}),3e3);return new Promise(((s,a)=>{this.eventBus.policyChange.subscribeOnce((()=>_t(this,null,(function*(){var i;let r=yield this.localTrackManager.getTracksToPublish(e.settings||qr);r.forEach((e=>this.setLocalPeerTrack(e))),(null==(i=this.localPeer)?void 0:i.audioTrack)&&this.initPreviewTrackAudioLevelMonitor(),yield this.initDeviceManagers(),this.sdkState.isPreviewInProgress=!1,this.analyticsTimer.end(vr.PREVIEW),t.onPreview(this.store.getRoom(),r),this.sendPreviewAnalyticsEvent(),s()})))),this.transport.preview(e.authToken,e.initEndpoint,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.autoVideoSubscribe).then((t=>{var s;i=!0,clearTimeout(n),t&&e.captureNetworkQualityInPreview&&this.networkTestManager.start(null==(s=t.config)?void 0:s.networkHealth).then((()=>{r=!0}))})).catch((e=>{var t;this.analyticsTimer.end(vr.PREVIEW),null==(t=this.errorListener)||t.onError(e),this.sendPreviewAnalyticsEvent(e),this.sdkState.isPreviewInProgress=!1,a(e)}))}))}))}join(e,t){var i,r,n;if(ri(),ii(),this.sdkState.isPreviewInProgress)throw Qt.NotReady(Vt.JOIN,"Preview is in progress, can't join");this.analyticsTimer.start(vr.JOIN);let s=this.transportState===Tr.Preview,{roomId:a,userId:o,role:l}=Ur(e.authToken);null==(i=this.networkTestManager)||i.stop(),null==(n=null==(r=this.localPeer)?void 0:r.audioTrack)||n.destroyAudioLevelMonitor(),this.listener=t,this.commonSetup(e,a,t),this.removeDevicesFromConfig(e),this.store.setConfig(e),this.localPeer?(this.localPeer.name=e.userName,this.localPeer.role=this.store.getPolicyForRole(l),this.localPeer.customerUserId=o,this.localPeer.metadata=e.metaData||""):this.createAndAddLocalPeerToStore(e,l,o),this.roleChangeManager=new class{constructor(e,t,i,r,n){this.store=e,this.transport=t,this.publish=i,this.removeAuxiliaryTrack=r,this.listener=n,this.handleLocalPeerRoleUpdate=e=>_t(this,[e],(function*({oldRole:e,newRole:t}){var i,r;let n=this.store.getLocalPeer();if(!n)return;let s=new Set(e.publishParams.allowed||[]),a=new Set(t.publishParams.allowed||[]),o=this.removeTrack(s,a,"video"),l=this.removeTrack(s,a,"audio"),c=this.removeTrack(s,a,"screen");yield this.removeVideoTracks(o),yield this.removeAudioTrack(l),yield this.removeScreenTracks(c),this.store.setPublishParams(t.publishParams);let d=(null==(i=this.store.getConfig())?void 0:i.settings)||{isAudioMuted:!0,isVideoMuted:!0,audioInputDeviceId:"default",videoDeviceId:"default",audioOutputDeviceId:"default"};yield this.publish(Ct(Rt({},d),{isAudioMuted:!0,isVideoMuted:!0})),null==(r=this.listener)||r.onPeerUpdate(wt.ROLE_UPDATED,n)}))}removeVideoTracks(e){return _t(this,null,(function*(){var t;if(!e)return;let i=this.store.getLocalPeer();(null==i?void 0:i.videoTrack)&&(yield this.transport.unpublish([i.videoTrack]),null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,i.videoTrack,i),i.videoTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"video"===e.type))}))}removeAudioTrack(e){return _t(this,null,(function*(){var t;if(!e)return;let i=this.store.getLocalPeer();(null==i?void 0:i.audioTrack)&&(yield this.transport.unpublish([i.audioTrack]),null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,i.audioTrack,i),i.audioTrack=void 0),yield this.removeAuxTracks((e=>"screen"!==e.source&&"audio"===e.type))}))}removeScreenTracks(e){return _t(this,null,(function*(){!e||(yield this.removeAuxTracks((e=>"screen"===e.source)))}))}removeAuxTracks(e){return _t(this,null,(function*(){let t=this.store.getLocalPeer();if(null==t?void 0:t.auxiliaryTracks){let i=[...t.auxiliaryTracks];for(let t of i)e(t)&&(yield this.removeAuxiliaryTrack(t.trackId))}}))}removeTrack(e,t,i){return e.has(i)&&!t.has(i)}}(this.store,this.transport,this.publish.bind(this),this.removeTrack.bind(this),this.listener),this.eventBus.localRoleUpdate.subscribe(this.handleLocalRoleUpdate),Lt.d(this.TAG,"SDK Store",this.store),Lt.d(this.TAG,` Joining room ${a}`),Lt.time(`join-room-${a}`),this.transport.join(e.authToken,this.localPeer.peerId,{name:e.userName,metaData:e.metaData||""},e.initEndpoint,e.autoVideoSubscribe).then((()=>_t(this,null,(function*(){Lt.d(this.TAG,` Joined room ${a}`),mr.resumeContext(),this.notifyJoin(),this.sendJoinAnalyticsEvent(s),this.store.getPublishParams()&&!this.sdkState.published&&!bi&&(yield this.publish(e.settings||qr))})))).catch((e=>{var t;this.analyticsTimer.end(vr.JOIN),null==(t=this.listener)||t.onError(e),this.sendJoinAnalyticsEvent(s,e),Lt.e(this.TAG,"Unable to join room",e)})).then((()=>{Lt.timeEnd(`join-room-${a}`)}))}stringifyMetadata(e){e.metaData&&"string"!=typeof e.metaData&&JSON.stringify(e.metaData)}cleanUp(){var e,t;this.cleanDeviceManagers(),this.eventBus.analytics.unsubscribe(this.sendAnalyticsEvent),this.analyticsTimer.cleanUp(),tr.cleanup(),this.playlistManager.cleanup(),Lt.cleanUp(),this.sdkState=Rt({},zr),this.localPeer&&(null==(e=this.localPeer.audioTrack)||e.cleanup(),this.localPeer.audioTrack=void 0,null==(t=this.localPeer.videoTrack)||t.cleanup(),this.localPeer.videoTrack=void 0),this.store.cleanUp(),this.listener=void 0,this.roleChangeManager&&this.eventBus.localRoleUpdate.unsubscribe(this.roleChangeManager.handleLocalPeerRoleUpdate)}leave(){return _t(this,null,(function*(){var e,t;let i=this.store.getRoom();if(i){let r=i.id;null==(e=this.networkTestManager)||e.stop(),Lt.d(this.TAG,` Leaving room ${r}`),yield null==(t=this.transport)?void 0:t.leave(),this.cleanUp(),Lt.d(this.TAG,` Left room ${r}`)}}))}getLocalPeer(){return this.store.getLocalPeer()}getPeers(){let e=this.store.getPeers();return e.length<50&&Lt.d(this.TAG,"Got peers",e),e}getAudioOutput(){return this.audioOutput}sendMessage(e,t){this.sendMessageInternal({message:t,type:e})}sendBroadcastMessage(e,t){return _t(this,null,(function*(){return yield this.sendMessageInternal({message:e,type:t})}))}sendGroupMessage(e,t,i){return _t(this,null,(function*(){let r=this.store.getKnownRoles();if(0===(t.filter((e=>r[e.name]))||[]).length)throw Qt.ValidationFailed("No valid role is present",t);return yield this.sendMessageInternal({message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return _t(this,null,(function*(){var r;if(!this.store.getPeerById(t.peerId))throw Qt.ValidationFailed("Invalid peer - peer not present in the room",t);if((null==(r=this.localPeer)?void 0:r.peerId)===t.peerId)throw Qt.ValidationFailed("Cannot send message to self");return yield this.sendMessageInternal({message:e,recipientPeer:t,type:i})}))}sendMessageInternal(e){return _t(this,arguments,(function*({recipientRoles:e,recipientPeer:t,type:i="chat",message:r}){if(""===r.replace(/\u200b/g," ").trim())throw Lt.w(this.TAG,"sendMessage","Ignoring empty message send"),Qt.ValidationFailed("Empty message not allowed");let n=new xi({sender:this.localPeer,type:i,message:r,recipientPeer:t,recipientRoles:e,time:new Date});Lt.d(this.TAG,"Sending Message: ",n);let s=yield this.transport.sendMessage(n);return n.time=new Date(s.timestamp),n}))}startScreenShare(e){return _t(this,arguments,(function*(e,t={audioOnly:!1,videoOnly:!1}){var i,r,n;let s=this.store.getPublishParams();if(!s)return;let{allowed:a}=s;if(!a||!a.includes("screen"))return void Lt.e(this.TAG,`Role ${null==(i=this.localPeer)?void 0:i.role} cannot share screen`);if(null==(n=null==(r=this.localPeer)?void 0:r.auxiliaryTracks)?void 0:n.find((e=>"screen"===e.source)))throw Error("Cannot share multiple screens");let o=yield this.getScreenshareTracks(e,t);if(!this.localPeer)return Lt.d(this.TAG,"Screenshared when not connected"),void o.forEach((e=>{e.cleanup()}));yield this.transport.publish(o),o.forEach((e=>{var t,i,r;e.peerId=null==(t=this.localPeer)?void 0:t.peerId,null==(i=this.localPeer)||i.auxiliaryTracks.push(e),null==(r=this.listener)||r.onTrackUpdate(It.TRACK_ADDED,e,this.localPeer)}))}))}stopEndedScreenshare(e){return _t(this,null,(function*(){Lt.d(this.TAG," Screenshare ended natively"),yield this.stopScreenShare(),e()}))}stopScreenShare(){return _t(this,null,(function*(){var e;Lt.d(this.TAG," Screenshare ended from app");let t=null==(e=this.localPeer)?void 0:e.auxiliaryTracks.filter((e=>"screen"===e.source));if(t)for(let e of t)yield this.removeTrack(e.trackId)}))}addTrack(e,t="regular"){return _t(this,null,(function*(){var i,r,n,s;if(!e)return void Lt.w(this.TAG,"Please pass a valid MediaStreamTrack");if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot addTrack");if(this.localPeer.auxiliaryTracks.find((t=>t.trackId===e.id)))return;let a=e.kind,o=new MediaStream([e]),l=new hr(o),c=new("audio"===a?sr:Er)(l,e,t,this.eventBus);this.setPlaylistSettings({track:e,hmsTrack:c,source:t}),yield null==(i=this.transport)?void 0:i.publish([c]),c.peerId=null==(r=this.localPeer)?void 0:r.peerId,null==(n=this.localPeer)||n.auxiliaryTracks.push(c),null==(s=this.listener)||s.onTrackUpdate(It.TRACK_ADDED,c,this.localPeer)}))}removeTrack(e){return _t(this,null,(function*(){var t;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot removeTrack");let i=this.localPeer.auxiliaryTracks.findIndex((t=>t.trackId===e));if(i>-1){let e=this.localPeer.auxiliaryTracks[i];yield this.transport.unpublish([e]),"audioplaylist"===e.source?this.playlistManager.stop(Ft.audio):"videoplaylist"===e.source&&this.playlistManager.stop(Ft.video),this.localPeer.auxiliaryTracks.splice(i,1),null==(t=this.listener)||t.onTrackUpdate(It.TRACK_REMOVED,e,this.localPeer)}else Lt.w(this.TAG,`No track found for ${e}`)}))}setAnalyticsLevel(e){this.analyticsEventsService.level=e}setLogLevel(e){Lt.level=e}addAudioListener(e){this.audioListener=e,this.notificationManager.setAudioListener(e)}addConnectionQualityListener(e){this.notificationManager.setConnectionQualityListener(e)}changeRole(e,t,i=!1){return _t(this,null,(function*(){var r;!e.role||e.role.name===t||(yield null==(r=this.transport)?void 0:r.changeRole(e,t,i))}))}acceptChangeRole(e){return _t(this,null,(function*(){var t;yield null==(t=this.transport)?void 0:t.acceptRoleChange(e)}))}endRoom(e,t){return _t(this,null,(function*(){var i;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot end room");yield null==(i=this.transport)?void 0:i.endRoom(e,t),yield this.leave()}))}removePeer(e,t){return _t(this,null,(function*(){var i;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot remove peer");if(!this.store.getPeerById(e.peerId))throw Qt.ValidationFailed("Invalid peer, given peer not present in room",e);yield null==(i=this.transport)?void 0:i.removePeer(e.peerId,t)}))}startRTMPOrRecording(e){return _t(this,null,(function*(){var t;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot start streaming or recording");yield null==(t=this.transport)?void 0:t.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return _t(this,null,(function*(){var e;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot stop streaming or recording");yield null==(e=this.transport)?void 0:e.stopRTMPOrRecording()}))}startHLSStreaming(e){return _t(this,null,(function*(){var t;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot start HLS streaming");yield null==(t=this.transport)?void 0:t.startHLSStreaming(e)}))}stopHLSStreaming(e){return _t(this,null,(function*(){var t;if(!this.localPeer)throw Qt.NotConnected(Vt.VALIDATION,"No local peer present, cannot stop HLS streaming");yield null==(t=this.transport)?void 0:t.stopHLSStreaming(e)}))}changeName(e){return _t(this,null,(function*(){var t;this.validateJoined("changeName"),yield null==(t=this.transport)?void 0:t.changeName(e),this.notificationManager.updateLocalPeer({name:e})}))}changeMetadata(e){return _t(this,null,(function*(){var t;this.validateJoined("changeMetadata"),yield null==(t=this.transport)?void 0:t.changeMetadata(e),this.notificationManager.updateLocalPeer({metadata:e})}))}getRoles(){return Object.values(this.store.getKnownRoles())}changeTrackState(e,t){return _t(this,null,(function*(){var i;if(e.type===ti.VIDEO&&"regular"!==e.source)return void Lt.w(this.TAG,"Muting non-regular video tracks is currently not supported");if(e.enabled===t)return void Lt.w(this.TAG,`Aborting change track state, track already has enabled - ${t}`,e);if(!this.store.getTrackById(e.trackId))throw Qt.ValidationFailed("No track found for change track state",e);let r=this.store.getPeerByTrackId(e.trackId);if(!r)throw Qt.ValidationFailed("No peer found for change track state",e);yield null==(i=this.transport)?void 0:i.changeTrackState({requested_for:r.peerId,track_id:e.trackId,stream_id:e.stream.id,mute:!t})}))}changeMultiTrackState(e){return _t(this,null,(function*(){var t;if("boolean"!=typeof e.enabled)throw Qt.ValidationFailed("Pass a boolean for enabled");let{enabled:i,roles:r,type:n,source:s}=e;yield null==(t=this.transport)?void 0:t.changeMultiTrackState({value:!i,type:n,source:s,roles:null==r?void 0:r.map((e=>null==e?void 0:e.name))})}))}publish(e){return _t(this,null,(function*(){let t=yield this.localTrackManager.getTracksToPublish(e);yield this.setAndPublishTracks(t),this.sdkState.published=!0}))}setAndPublishTracks(e){return _t(this,null,(function*(){var t;for(let i of e)yield this.transport.publish([i]),this.setLocalPeerTrack(i),null==(t=this.listener)||t.onTrackUpdate(It.TRACK_ADDED,i,this.localPeer);yield this.initDeviceManagers()}))}setLocalPeerTrack(e){var t;switch(e.peerId=null==(t=this.localPeer)?void 0:t.peerId,e.type){case ti.AUDIO:this.localPeer.audioTrack=e;break;case ti.VIDEO:this.localPeer.videoTrack=e}}initDeviceManagers(){return _t(this,null,(function*(){var e,t,i;this.sdkState.deviceManagersInitialised||(this.sdkState.deviceManagersInitialised=!0,yield this.deviceManager.init(),this.deviceManager.updateOutputDevice(null==(t=null==(e=tr.getSelection())?void 0:e.audioOutput)?void 0:t.deviceId),this.audioSinkManager.init(null==(i=this.store.getConfig())?void 0:i.audioSinkElementId))}))}cleanDeviceManagers(){this.eventBus.deviceChange.unsubscribe(this.handleDeviceChange),this.eventBus.audioPluginFailed.unsubscribe(this.handleAudioPluginError),this.eventBus.autoplayError.unsubscribe(this.handleAutoplayError),this.deviceManager.cleanUp(),this.audioSinkManager.cleanUp()}initPreviewTrackAudioLevelMonitor(){var e;let t=null==(e=this.localPeer)?void 0:e.audioTrack;null==t||t.initAudioLevelMonitor(),this.eventBus.trackAudioLevelUpdate.subscribe((e=>{var i;let r=e&&e.track.trackId===(null==t?void 0:t.trackId)?[{audioLevel:e.audioLevel,peer:this.localPeer,track:t}]:[];this.store.updateSpeakers(r),null==(i=this.audioListener)||i.onAudioLevelUpdate(r)})),this.eventBus.localAudioSilence.subscribe(this.sendAudioPresenceFailed)}notifyJoin(){var e;let t=this.store.getLocalPeer(),i=this.store.getRoom();i.joinedAt=new Date,t&&(t.joinedAt=i.joinedAt),(null==t?void 0:t.role)?(this.analyticsTimer.end(vr.JOIN),null==(e=this.listener)||e.onJoin(i)):this.eventBus.policyChange.subscribeOnce((()=>{var e;this.analyticsTimer.end(vr.JOIN),null==(e=this.listener)||e.onJoin(i)}))}setUpPreview(e,t){this.listener=t,this.sdkState.isPreviewInProgress=!0;let{roomId:i,userId:r,role:n}=Ur(e.authToken);this.commonSetup(e,i,t),this.store.setConfig(e),this.createAndAddLocalPeerToStore(e,n,r),Lt.d(this.TAG,"SDK Store",this.store)}setPlaylistSettings(e){return _t(this,arguments,(function*({track:e,hmsTrack:t,source:i}){if("videoplaylist"===i){let i={};if("audio"===e.kind)i.maxBitrate=64;else{i.maxBitrate=1e3;let{width:t,height:r}=e.getSettings();i.width=t,i.height=r}yield t.setSettings(i)}else"audioplaylist"===i&&(yield t.setSettings({maxBitrate:64}))}))}createAndAddLocalPeerToStore(e,t,i){let r=this.store.getPolicyForRole(t),n=new Ki({name:e.userName||"",customerUserId:i,metadata:e.metaData||"",role:r});this.store.addPeer(n)}commonSetup(e,t,i){this.stringifyMetadata(e),e.initEndpoint||(e.initEndpoint="https://prod-init.100ms.live"),this.errorListener=i,this.deviceChangeListener=i,this.initStoreAndManagers(),this.store.setErrorListener(this.errorListener),this.store.getRoom()||this.store.setRoom(new class{constructor(e,t){this.id=e,this.store=t,this.recording={server:{running:!1},browser:{running:!1},hls:{running:!1}},this.rtmp={running:!1},this.hls={running:!1,variants:[]}}get localPeer(){return this.store.getLocalPeer()}get peers(){return this.store.getPeers()}}(t,this.store))}removeDevicesFromConfig(e){this.store.getConfig()&&e.settings&&(delete e.settings.audioOutputDeviceId,delete e.settings.videoDeviceId,delete e.settings.audioInputDeviceId)}getScreenshareTracks(e,t){return _t(this,null,(function*(){let{video:i,audio:r}=this.getScreenshareSettings(t.videoOnly),[n,s]=yield this.transport.getLocalScreen(i,r),a=()=>{this.stopEndedScreenshare(e)},o=[];if(t.audioOnly){if(n.nativeTrack.stop(),!s)throw Error("Select share audio when sharing screen");o.push(s),s.nativeTrack.onended=a}else o.push(n),n.nativeTrack.onended=a,s&&o.push(s);return o}))}},this.actions=new class{constructor(e,t,i){this.hmsSDKTracks={},this.hmsSDKPeers={},this.isRoomJoinCalled=!1,this.ignoredMessageTypes=[],this.setProgress=({type:e,progress:t})=>{this.setState((i=>{i.playlist[e].progress=t,i.playlist[e].currentTime=this.sdk.getPlaylistManager().getCurrentTime(e)}),"playlistProgress")},this.syncPlaylistState=e=>{this.setState((e=>{Object.assign(e.playlist,Cn.convertPlaylist(this.sdk.getPlaylistManager()))}),e)},this.sendPeerUpdateNotification=(e,t)=>{let i=this.store.getState(Cs(t.peerId)),r=$s[e];this.syncRoomState(r),i||(i=this.store.getState(Cs(t.peerId))),this.hmsNotifications.sendPeerUpdate(e,i)},this.setState=(e,t)=>this.store.namedSetState(e,t),this.store=e,this.sdk=t,this.hmsNotifications=i}refreshDevices(){return un(this,null,(function*(){yield this.sdk.refreshDevices()}))}unblockAudio(){return un(this,null,(function*(){yield this.sdk.getAudioOutput().unblockAutoplay()}))}setVolume(e,t){t?this.setTrackVolume(e,t):(this.sdk.getAudioOutput().setVolume(e),this.syncRoomState("setOutputVolume"))}setAudioOutputDevice(e){this.sdk.getAudioOutput().setDevice(e)&&this.setState((t=>{t.settings.audioOutputDeviceId=e}),"setAudioOutputDevice")}setPreferredLayer(e,t){let i=this.hmsSDKTracks[e];i?i instanceof yi?(i.preferLayer(t),this.updateVideoLayer(e,"setPreferredLayer")):Ss.w(`track ${e} is not an video track`):this.logPossibleInconsistency(`track ${e} not present, unable to set preffer layer`)}preview(e){return un(this,null,(function*(){if(this.isRoomJoinCalled)return void this.logPossibleInconsistency("attempting to call preview after join was called");let t=this.store.getState(rs);if(t!==Xr.Preview&&t!==Xr.Connecting)try{this.setState((e=>{e.room.roomState=Xr.Connecting}),"connecting"),yield this.sdkPreviewWithListeners(e)}catch(e){throw Ss.e("Cannot show preview. Failed to connect to room - ",e),e}else this.logPossibleInconsistency("attempting to call preview while room is in preview/connecting")}))}join(e){if(this.isRoomJoinCalled)this.logPossibleInconsistency("room join is called again");else try{this.isRoomJoinCalled=!0,this.setState((e=>{e.room.roomState=Xr.Connecting}),"join"),this.sdkJoinWithListeners(e)}catch(e){throw this.isRoomJoinCalled=!1,Ss.e("Failed to connect to room - ",e),e}}leave(){return un(this,null,(function*(){if(!this.store.getState(ns))return void this.logPossibleInconsistency("room leave is called when no room is connected");let e=this.store.getState(rs);return this.setState((e=>{e.room.roomState=Xr.Disconnecting}),"leaving"),this.sdk.leave().then((()=>{this.resetState("leave"),Ss.i("left room")})).catch((t=>{Ss.e("error in leaving room - ",t),this.setState((t=>{t.room.roomState=e}),"revertLeave")}))}))}setScreenShareEnabled(e,t){return un(this,null,(function*(){let i={audioOnly:!1,videoOnly:!1};"object"==typeof t?Object.assign(i,t):"boolean"==typeof t&&(i.audioOnly=t);try{e?yield this.startScreenShare(i):yield this.stopScreenShare()}catch(e){throw this.hmsNotifications.sendError(Cn.convertException(e)),e}}))}addTrack(e,t="regular"){return un(this,null,(function*(){yield this.sdk.addTrack(e,t),this.syncRoomState("addTrack")}))}removeTrack(e){return un(this,null,(function*(){yield this.sdk.removeTrack(e),this.syncRoomState("removeTrack")}))}setLocalAudioEnabled(e){return un(this,null,(function*(){let t=this.store.getState(Wn);t&&(yield this.setEnabledTrack(t,e))}))}setLocalVideoEnabled(e){return un(this,null,(function*(){let t=this.store.getState(Jn);t&&(yield this.setEnabledTrack(t,e))}))}setEnabledTrack(e,t){return un(this,null,(function*(){var i;if((null==(i=this.store.getState().tracks[e])?void 0:i.enabled)===t)return void this.logPossibleInconsistency(`local track[${e}] enabled state - ${t}`);this.setState((i=>{i.tracks[e]?i.tracks[e].displayEnabled=t:this.logPossibleInconsistency("track id not found for setEnabled")}),"displayEnabled");try{yield this.setEnabledSDKTrack(e,t),this.syncRoomState("setEnabled")}catch(i){throw this.setState((i=>{i.tracks[e].displayEnabled=!t}),"rollbackDisplayEnabled"),this.hmsNotifications.sendError(Cn.convertException(i)),i}let r=t?It.TRACK_UNMUTED:It.TRACK_MUTED;this.hmsNotifications.sendTrackUpdate(r,e)}))}setAudioSettings(e){return un(this,null,(function*(){let t=this.store.getState(Wn);t&&(yield this.setSDKLocalAudioTrackSettings(t,e),this.syncRoomState("setAudioSettings"))}))}setVideoSettings(e){return un(this,null,(function*(){let t=this.store.getState(Jn);t&&(yield this.setSDKLocalVideoTrackSettings(t,e),this.syncRoomState("setVideoSettings"))}))}sendMessage(e){this.sendBroadcastMessage(e)}sendBroadcastMessage(e,t){return un(this,null,(function*(){let i=yield this.sdk.sendBroadcastMessage(e,t);this.updateMessageInStore(i,{message:e,type:t})}))}sendGroupMessage(e,t,i){return un(this,null,(function*(){let r=this.store.getState(ss),n=t.map((e=>r[e])),s=yield this.sdk.sendGroupMessage(e,n,i);this.updateMessageInStore(s,{message:e,recipientRoles:t,type:i})}))}sendDirectMessage(e,t,i){return un(this,null,(function*(){let r=this.hmsSDKPeers[t],n=yield this.sdk.sendDirectMessage(e,r,i);this.updateMessageInStore(n,{message:e,recipientPeer:r.peerId,type:i})}))}updateMessageInStore(e,t){if(!e)throw Ss.w("sendMessage","Failed to send message",t),Error(`sendMessage Failed - ${JSON.stringify(t)}`);let i=Cn.convertMessage(e);return i.read=!0,i.senderName="You",i.ignored=this.ignoredMessageTypes.includes(i.type),this.putMessageInStore(i),i}setMessageRead(e,t){this.setState((i=>{t?i.messages.byID[t]?i.messages.byID[t].read=e:this.logPossibleInconsistency("no message with id is found"):i.messages.allIDs.forEach((t=>{i.messages.byID[t].read=e}))}),"setMessageRead")}attachVideo(e,t){return un(this,null,(function*(){if(this.localAndVideoUnmuting(e))return new Promise((i=>{let r=this.store.subscribe((n=>un(this,null,(function*(){n&&(yield this.attachVideoInternal(e,t),r(),i())}))),Yn)}));yield this.attachVideoInternal(e,t)}))}detachVideo(e,t){return un(this,null,(function*(){let i=this.hmsSDKTracks[e];i&&"video"===i.type?(yield i.removeSink(t),this.updateVideoLayer(e,"detachVideo")):this.logPossibleInconsistency("no video track found to remove sink")}))}addPluginToVideoTrack(e,t){return un(this,null,(function*(){return this.addRemoveVideoPlugin(e,"add",t)}))}addPluginToAudioTrack(e){return un(this,null,(function*(){return this.addRemoveAudioPlugin(e,"add")}))}validateVideoPluginSupport(e){let t={isSupported:!1};if(!e)return Ss.w("no plugin passed in for checking support"),t.errMsg="no plugin passed in for checking support",t;let i=this.store.getState(Jn);if(i){let r=this.hmsSDKTracks[i];r?t=r.validatePlugin(e):(Ss.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`)}return t}validateAudioPluginSupport(e){let t={isSupported:!1};if(!e)return Ss.w('no plugin passed in for checking support"'),t.errMsg='no plugin passed in for checking support"',t;let i=this.store.getState(Wn);if(i){let r=this.hmsSDKTracks[i];r?t=r.validatePlugin(e):(Ss.w(`track ${i} not present, unable to validate plugin`),t.errMsg=`track ${i} not present, unable to validate plugin`)}return t}removePluginFromVideoTrack(e){return un(this,null,(function*(){return this.addRemoveVideoPlugin(e,"remove")}))}removePluginFromAudioTrack(e){return un(this,null,(function*(){return this.addRemoveAudioPlugin(e,"remove")}))}changeRole(e,t,i=!1){return un(this,null,(function*(){let r=this.hmsSDKPeers[e];r?yield this.sdk.changeRole(r,t,i):this.logPossibleInconsistency(`Unknown peer ID given ${e} for changerole`)}))}acceptChangeRole(e){return un(this,null,(function*(){let t=e.requestedBy?this.hmsSDKPeers[e.requestedBy.id]:void 0;t||Ss.w(`peer for which role change is requested no longer available - ${e.requestedBy}`);let i={requestedBy:t,role:e.role,token:e.token};yield this.sdk.acceptChangeRole(i),this.removeRoleChangeRequest(e)}))}initAppData(e){this.setState((t=>{t.appData=e}),"initAppData")}setAppData(e,t,i){let r="Object"===(null==t?void 0:t.constructor.name);this.setState((n=>{if(n.appData)i&&r?Object.assign(n.appData[e],t):n.appData[e]=t;else{let i={[e]:t};n.appData=i}}),`setAppData-${e}`)}rejectChangeRole(e){this.removeRoleChangeRequest(e)}endRoom(e,t){return un(this,null,(function*(){let i=this.store.getState(os);if(!(null==i?void 0:i.endRoom))return void Ss.w("You are not allowed to perform this action - endRoom");let r=this.store.getState(rs);this.setState((e=>{e.room.roomState=Xr.Disconnecting}),"endingRoom");try{yield this.sdk.endRoom(e,t),this.resetState("endRoom")}catch(e){Ss.e("error in ending room - ",e),this.setState((e=>{e.room.roomState=r}),"revertEndRoom")}}))}removePeer(e,t){return un(this,null,(function*(){let i=this.hmsSDKPeers[e];i&&!i.isLocal?yield this.sdk.removePeer(i,t):this.logPossibleInconsistency(`No remote peer found for peerID - ${e}`)}))}startRTMPOrRecording(e){return un(this,null,(function*(){yield this.sdk.startRTMPOrRecording(e)}))}stopRTMPAndRecording(){return un(this,null,(function*(){yield this.sdk.stopRTMPAndRecording()}))}startHLSStreaming(e){return un(this,null,(function*(){yield this.sdk.startHLSStreaming(e)}))}stopHLSStreaming(e){return un(this,null,(function*(){yield this.sdk.stopHLSStreaming(e)}))}changeName(e){return un(this,null,(function*(){yield this.sdk.changeName(e)}))}changeMetadata(e){return un(this,null,(function*(){"string"!=typeof e&&(e=JSON.stringify(e)),yield this.sdk.changeMetadata(e)}))}setRemoteTrackEnabled(e,t){return un(this,null,(function*(){if("string"==typeof e){let i=this.hmsSDKTracks[e];i&&function(e){return e instanceof gi||e instanceof yi}(i)?yield this.sdk.changeTrackState(i,t):this.logPossibleInconsistency(`No remote track with ID ${e} found for change track state`)}else Array.isArray(e)&&e.forEach((e=>this.setRemoteTrackEnabled(e,t)))}))}setRemoteTracksEnabled(e){return un(this,null,(function*(){let t={enabled:e.enabled,type:e.type,source:e.source};if(e.roles){let i=this.store.getState(ss);t.roles=e.roles.map((e=>i[e]))}yield this.sdk.changeMultiTrackState(t)}))}setLogLevel(e){Ss.level=e,this.sdk.setLogLevel(e)}ignoreMessageTypes(e,t=!1){if(t)this.ignoredMessageTypes=e;else for(let t of e)this.ignoredMessageTypes.includes(t)||this.ignoredMessageTypes.push(t)}resetState(e="resetState"){this.setState((e=>{Object.assign(e,gn())}),e),this.isRoomJoinCalled=!1,this.hmsSDKTracks={},Ss.cleanUp()}sdkJoinWithListeners(e){this.sdk.join(e,{onJoin:this.onJoin.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onTrackUpdate:this.onTrackUpdate.bind(this),onMessageReceived:this.onMessageReceived.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onRoleChangeRequest:this.onRoleChangeRequest.bind(this),onRoleUpdate:this.onRoleUpdate.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onChangeTrackStateRequest:this.onChangeTrackStateRequest.bind(this),onChangeMultiTrackStateRequest:this.onChangeMultiTrackStateRequest.bind(this),onRemovedFromRoom:this.onRemovedFromRoom.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)}),this.sdk.addConnectionQualityListener({onConnectionQualityUpdate:this.onConnectionQualityUpdate.bind(this)})}onRemovedFromRoom(e){var t;let i=this.store.getState(Cs(null==(t=e.requestedBy)?void 0:t.peerId));this.hmsNotifications.sendLeaveRoom(dn(cn({},e),{requestedBy:i||void 0}));let r=e.roomEnded||!i?"roomEnded":"removedFromRoom";Ss.i(`resetting state after peer removed ${r}`,e),this.resetState(r)}onDeviceChange(e){let t=e.devices;if(!t)return;let i=this.store.getState($n);if(this.setState((e=>{bn(e.devices.audioInput,t.audioInput)||(e.devices.audioInput=t.audioInput),bn(e.devices.videoInput,t.videoInput)||(e.devices.videoInput=t.videoInput),bn(e.devices.audioOutput,t.audioOutput)||(e.devices.audioOutput=t.audioOutput),this.hmsSDKPeers[null==i?void 0:i.id]&&Object.assign(e.settings,this.getMediaSettings(this.hmsSDKPeers[null==i?void 0:i.id]))}),"deviceChange"),e.selection){let t=Cn.convertDeviceChangeUpdate(e);this.hmsNotifications.sendDeviceChange(t)}}sdkPreviewWithListeners(e){return un(this,null,(function*(){yield this.sdk.preview(e,{onPreview:this.onPreview.bind(this),onError:this.onError.bind(this),onReconnected:this.onReconnected.bind(this),onReconnecting:this.onReconnecting.bind(this),onDeviceChange:this.onDeviceChange.bind(this),onRoomUpdate:this.onRoomUpdate.bind(this),onPeerUpdate:this.onPeerUpdate.bind(this),onNetworkQuality:this.onNetworkQuality.bind(this)}),this.sdk.addAudioListener({onAudioLevelUpdate:this.onAudioLevelUpdate.bind(this)})}))}onNetworkQuality(e){this.setState((t=>{var i;let r=t.room.localPeer||(null==(i=this.sdk.getLocalPeer())?void 0:i.peerId);r&&(t.connectionQualities[r]={peerID:r,downlinkQuality:e})}),"ConnectionQuality")}startScreenShare(e){return un(this,null,(function*(){this.store.getState(Xn)?this.logPossibleInconsistency("start screenshare is called while it's on"):(yield this.sdk.startScreenShare((()=>this.syncRoomState("screenshareStopped")),e),this.syncRoomState("startScreenShare"))}))}stopScreenShare(){return un(this,null,(function*(){this.store.getState(Xn)?(yield this.sdk.stopScreenShare(),this.syncRoomState("stopScreenShare")):this.logPossibleInconsistency("stop screenshare is called while it's not on")}))}attachVideoInternal(e,t){return un(this,null,(function*(){let i=this.hmsSDKTracks[e];i&&"video"===i.type?(yield i.addSink(t),this.updateVideoLayer(e,"attachVideo")):this.logPossibleInconsistency("no video track found to add sink")}))}syncRoomState(e){Ss.time(`store-sync-${e}`);let t={},i=[],r={},n={},s={},a=this.sdk.getPeers();for(let e of a){let a=Cn.convertPeer(e);t[a.id]=a,i.push(a.id),this.hmsSDKPeers[a.id]=e;let o=[e.audioTrack,e.videoTrack,...e.auxiliaryTracks];for(let e of o){if(!e)continue;let t=Cn.convertTrack(e);r[t.id]=t,n[e.trackId]=e}a.isLocal&&Object.assign(s,this.getMediaSettings(e))}let o=this.sdk.getRecordingState(),l=this.sdk.getRTMPState(),c=this.sdk.getHLSState();this.setState((e=>{e.room.peers=i;let a=e.peers,d=e.tracks;((e,t)=>{let i=Rn(Object.keys(e),Object.keys(t));for(let r of i){let i=e[r],n=t[r];Sn(i,n)?(bn(i.auxiliaryTracks,n.auxiliaryTracks)&&(n.auxiliaryTracks=i.auxiliaryTracks),Object.assign(i,n)):kn(i,n)?delete e[r]:En(i,n)&&(e[r]=n)}})(a,t),((e,t)=>{let i=Rn(Object.keys(e),Object.keys(t));for(let r of i){let i=e[r],n=t[r];Sn(i,n)?(Tn(i,n),Object.assign(i,n)):kn(i,n)?delete e[r]:En(i,n)&&(e[r]=n)}})(d,r),Object.assign(e.settings,s),this.hmsSDKTracks=n,Object.assign(e.roles,Cn.convertRoles(this.sdk.getRoles())),Object.assign(e.playlist,Cn.convertPlaylist(this.sdk.getPlaylistManager())),Object.assign(e.room,Cn.convertRecordingStreamingState(o,l,c))}),e),Ss.timeEnd(`store-sync-${e}`)}onPreview(e){this.setState((t=>{Object.assign(t.room,Cn.convertRoom(e)),t.room.roomState=Xr.Preview}),"previewStart"),this.syncRoomState("previewSync")}onJoin(e){let t=this.sdk.getPlaylistManager();this.audioPlaylist=new Vs(t,mn.audio,this.syncPlaylistState.bind(this),this.store),this.videoPlaylist=new Vs(t,mn.video,this.syncRoomState.bind(this),this.store),this.syncRoomState("joinSync"),this.setState((t=>{Object.assign(t.room,Cn.convertRoom(e)),t.room.isConnected=!0,t.room.roomState=Xr.Connected}),"joined"),t.onProgress(this.setProgress),t.onNewTrackStart((e=>{this.syncPlaylistState(`${e.type}PlaylistUpdate`)})),t.onPlaylistEnded((e=>{this.syncPlaylistState(`${e}PlaylistEnded`)})),t.onCurrentTrackEnded((e=>{this.hmsNotifications.sendPlaylistTrackEnded(Cn.convertPlaylistItem(t,e)),this.syncPlaylistState(`${e.type}PlaylistItemEnded`)}))}onRoomUpdate(e,t){this.setState((e=>{Object.assign(e.room,Cn.convertRoom(t))}),"RoomUpdate")}onPeerUpdate(e,t){if(![wt.BECAME_DOMINANT_SPEAKER,wt.RESIGNED_DOMINANT_SPEAKER].includes(e)){if(Array.isArray(t)){this.syncRoomState("peersJoined");let e=[];for(let i of t){let t=this.store.getState(Cs(i.peerId));t&&e.push(t)}return void this.hmsNotifications.sendPeerList(e)}this.sendPeerUpdateNotification(e,t)}}onTrackUpdate(e,t,i){if(e===It.TRACK_REMOVED)this.hmsNotifications.sendTrackUpdate(e,t.trackId),this.handleTrackRemove(t,i);else{let i=e===It.TRACK_ADDED?"trackAdded":"trackUpdate";this.syncRoomState(i),this.hmsNotifications.sendTrackUpdate(e,t.trackId)}}onMessageReceived(e){let t=Cn.convertMessage(e);t.read=!1,t.ignored=this.ignoredMessageTypes.includes(t.type),this.putMessageInStore(t),this.hmsNotifications.sendMessageReceived(t)}putMessageInStore(e){e.ignored||this.setState((t=>{e.id=String(this.store.getState(ts)+1),t.messages.byID[e.id]=e,t.messages.allIDs.push(e.id)}),"newMessage")}onAudioLevelUpdate(e){this.setState((t=>{let i={};e.forEach((e=>{if(!e.track||!e.peer)return;let r=e.track.trackId;i[r]=e.audioLevel,t.speakers[r]||(t.speakers[r]={audioLevel:e.audioLevel,peerID:e.peer.peerId,trackID:r})}));let r=Object.entries(t.speakers);for(let[e,n]of r)n.audioLevel=i[e]||0,0===n.audioLevel&&delete t.speakers[e]}),"audioLevel")}onConnectionQualityUpdate(e){this.setState((t=>{let i=new Set;e.forEach((e=>{let r=e.peerID;!r||(i.add(r),t.connectionQualities[r]?Object.assign(t.connectionQualities[r],e):t.connectionQualities[r]=e)}));let r=Object.keys(t.connectionQualities);for(let e of r)i.has(e)||delete t.connectionQualities[e]}),"connectionQuality")}onChangeTrackStateRequest(e){var t;let i=this.store.getState(Cs(null==(t=e.requestedBy)?void 0:t.peerId)),r=this.getStoreLocalTrackIDfromSDKTrack(e.track),n=this.store.getState(Ps(r));if(!n)return this.logPossibleInconsistency(`Not found track for which track state change was requested, ${e.track}`);e.enabled||this.syncRoomState("changeTrackStateRequest"),this.hmsNotifications.sendChangeTrackStateRequest({requestedBy:i||void 0,track:n,enabled:e.enabled})}onChangeMultiTrackStateRequest(e){var t;let i=this.store.getState(Cs(null==(t=e.requestedBy)?void 0:t.peerId));e.enabled||this.syncRoomState("changeMultiTrackStateRequest");let r=[],n=this.store.getState(Fn);for(let t of e.tracks){let e=this.getStoreLocalTrackIDfromSDKTrack(t);e&&n[e]&&r.push(n[e])}this.hmsNotifications.sendChangeMultiTrackStateRequest({requestedBy:i||void 0,tracks:r,enabled:e.enabled,type:e.type,source:e.source})}onReconnected(){this.syncRoomState("reconnectedSync"),this.hmsNotifications.sendReconnected(),this.setState((e=>{e.room.roomState=e.room.isConnected?Xr.Connected:Xr.Preview}),"reconnected")}onReconnecting(e){let t=Cn.convertException(e);Ss.e("Reconnection: received error from sdk",t),this.hmsNotifications.sendReconnecting(t),this.setState((e=>{e.room.roomState=Xr.Reconnecting,e.errors.push(t)}),"reconnecting")}onError(e){let t=Cn.convertException(e);t.isTerminal?(this.leave().then((()=>Ss.e("error from SDK, left room."))),this.setState((e=>{e.room.roomState=Xr.Failed,e.errors.push(t)}),"errorTerminal")):this.store.getState().errors.length<50&&this.setState((e=>{e.errors.push(t)}),"error"),this.syncRoomState("errorSync"),this.hmsNotifications.sendError(t),Ss.e("received error from sdk",t)}updateVideoLayer(e,t){let i=this.hmsSDKTracks[e];i&&i instanceof yi&&this.setState((t=>{t.tracks[e].layer=i.getSimulcastLayer(),t.tracks[e].degraded=i.degraded}),t)}handleTrackRemove(e,t){this.setState((i=>{let r=i.peers[t.peerId],n=i.tracks,s=e.trackId;if(this.isSameStoreSDKTrack(s,null==r?void 0:r.audioTrack))null==r||delete r.audioTrack;else if(this.isSameStoreSDKTrack(s,null==r?void 0:r.videoTrack))null==r||delete r.videoTrack;else{let e=null==r?void 0:r.auxiliaryTracks.indexOf(s);e>-1&&this.isSameStoreSDKTrack(s,null==r?void 0:r.auxiliaryTracks[e])&&(null==r||r.auxiliaryTracks.splice(e,1))}delete n[s],delete this.hmsSDKTracks[s]}),"trackRemoved")}setEnabledSDKTrack(e,t){return un(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setEnabled(t):this.logPossibleInconsistency(`track ${e} not present, unable to enabled/disable`)}))}setSDKLocalVideoTrackSettings(e,t){return un(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}setSDKLocalAudioTrackSettings(e,t){return un(this,null,(function*(){let i=this.hmsSDKTracks[e];i?yield i.setSettings(t):this.logPossibleInconsistency(`local track ${e} not present, unable to set settings`)}))}getMediaSettings(e){var t;let i=this.store.getState(Gn),r=e.audioTrack,n=e.videoTrack;return{audioInputDeviceId:(null==r?void 0:r.settings.deviceId)||i.audioInputDeviceId,videoInputDeviceId:(null==n?void 0:n.settings.deviceId)||i.videoInputDeviceId,audioOutputDeviceId:null==(t=this.sdk.getAudioOutput().getDevice())?void 0:t.deviceId}}setTrackVolume(e,t){let i=this.hmsSDKTracks[t];i?i instanceof mi?(i.setVolume(e),this.setState((i=>{let r=i.tracks[t];r&&(r.volume=e)}),"trackVolume")):Ss.w(`track ${t} is not an audio track`):this.logPossibleInconsistency(`track ${t} not present, unable to set volume`)}localAndVideoUnmuting(e){if(this.store.getState($n).videoTrack!==e)return!1;let t=this.store.getState(Zn),i=this.store.getState(Yn);return t&&!i}logPossibleInconsistency(e){Ss.w("possible inconsistency detected - ",e)}addRemoveVideoPlugin(e,t,i){return un(this,null,(function*(){if(!e)return void Ss.w("Invalid plugin received in store");let r=this.store.getState(Jn);if(r){let n=this.hmsSDKTracks[r];n?("add"===t?yield n.addPlugin(e,i):"remove"===t&&(yield n.removePlugin(e)),this.syncRoomState(`${t}VideoPlugin`)):this.logPossibleInconsistency(`track ${r} not present, unable to remove plugin`)}}))}addRemoveAudioPlugin(e,t){return un(this,null,(function*(){if(!e)return void Ss.w("Invalid plugin received in store");let i=this.store.getState(Wn);if(i){let r=this.hmsSDKTracks[i];r?("add"===t?yield r.addPlugin(e):"remove"===t&&(yield r.removePlugin(e)),this.syncRoomState(`${t}AudioPlugin`)):this.logPossibleInconsistency(`track ${i} not present, unable to remove plugin`)}}))}isSameStoreSDKTrack(e,t){var i;return!!t&&(null==(i=this.hmsSDKTracks[t])?void 0:i.trackId)===e}onRoleChangeRequest(e){this.setState((t=>{0===t.roleChangeRequests.length&&t.roleChangeRequests.push(Cn.convertRoleChangeRequest(e))}),"roleChangeRequest")}removeRoleChangeRequest(e){this.setState((t=>{let i=t.roleChangeRequests.findIndex((t=>t.token===e.token));-1!==i&&t.roleChangeRequests.splice(i,1)}),"removeRoleChangeRequest")}onRoleUpdate(){this.syncRoomState("roleUpdate")}getStoreLocalTrackIDfromSDKTrack(e){return this.store.getState(zn).find((t=>this.hmsSDKTracks[t].trackId===e.trackId))}}(this.store,this.sdk,this.notifications)),this.initialTriggerOnSubscribe=!1,Ri&&(window.__hms=this)}triggerOnSubscribe(){this.initialTriggerOnSubscribe||(ra.makeStoreTriggerOnSubscribe(this.store),this.initialTriggerOnSubscribe=!0)}getStore(){return this.store}getHMSActions(){return this.actions}getActions(){return this.actions}getNotifications(){return{onNotification:this.notifications.onNotification}}static createNewHMSStore(e,t){let i=function(e){let t;const i=new Set,r=(e,r)=>{const n="function"==typeof e?e(t):e;if(n!==t){const e=t;t=r?n:Object.assign({},t,n),i.forEach((i=>i(t,e)))}},n=()=>t,s={setState:r,getState:n,subscribe:(e,r,s)=>r||s?((e,r=n,s=Object.is)=>{let a=r(t);function o(){const i=r(t);if(!s(a,i)){const t=a;e(a=i,t)}}return i.add(o),()=>i.delete(o)})(e,r,s):(i.add(e),()=>i.delete(e)),destroy:()=>i.clear()};return t=e(r,n,s),s}((()=>t())),r=i.setState;i.setState=e=>{let t="function"==typeof e?te(e):e;r(t)};let n=i.getState;i.getState=e=>{if(e){let t=e.name||"byIDSelector";window.selectorsCount||(window.selectorsCount={}),window.selectorsCount[t]=(window.selectorsCount[t]||0)+1;let i=performance.now(),r=e(n()),s=performance.now()-i;return s>1&&(window.expensiveSelectors=window.expensiveSelectors||new Map,window.expensiveSelectors.set(t,s)),r}return n()},ra.compareWithShallowCheckInSubscribe(i);let s=ra.setUpDevtools(i,e);return dn(cn({},i),{namedSetState:s})}static makeStoreTriggerOnSubscribe(e){let t=e.subscribe;e.subscribe=(i,r,n)=>(i(e.getState(r),void 0),t(i,r,n))}static compareWithShallowCheckInSubscribe(e){let t=e.subscribe;e.subscribe=(e,i,r)=>(i||(i=e=>e),t(e,i,r=r||ie))}static setUpDevtools(e,t){let i;try{i=window.__REDUX_DEVTOOLS_EXTENSION__||window.top.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!i)return t=>{e.setState(t)};let r=i.connect(ra.devtoolsOptions(t));r.prefix=t?`${t} > `:"";let n=e.setState;return e.setState=t=>{n(t),r.send(`${r.prefix}setState`,e.getState())},r.subscribe(ra.devtoolsSubscribe(r,e,n)),r.send("setUpStore",e.getState()),(t,i)=>{n(t);let s=i||`${r.prefix}action`;r.send(s,e.getState())}}static devtoolsOptions(e){return{name:e,actionsBlacklist:["audioLevel","playlistProgress","connectionQuality"]}}static devtoolsSubscribe(e,t,i){return r=>{var n,s,a,o;if("DISPATCH"===r.type&&r.state)["JUMP_TO_ACTION","JUMP_TO_STATE"].includes(r.payload.type)?i(JSON.parse(r.state)):t.setState(JSON.parse(r.state));else if("DISPATCH"===r.type&&"COMMIT"===(null==(n=r.payload)?void 0:n.type))e.init(t.getState());else if("DISPATCH"===r.type&&"IMPORT_STATE"===(null==(s=r.payload)?void 0:s.type)){let n=null==(a=r.payload.nextLiftedState)?void 0:a.actionsById;((null==(o=r.payload.nextLiftedState)?void 0:o.computedStates)||[]).forEach((({state:r},s)=>{let a=n[s]||`${e.prefix}setState`;0===s?e.init(r):(i(r),e.send(a,t.getState()))}))}}}});let na,sa,aa;window.HMSReactiveStore=ra;let oa,la=null,ca=!1,da=null;function ua(){if(!la)return;if(!sa||!sa.sdk)return;const e=sa.sdk.getWebrtcInternals().hmsStats,t=e.peerStats,i=e.trackStats,r=e.store.localPeerId;let n=t[r];n&&la(JSON.stringify({type:"HMS_STAT",event:"on_rtc_stats",data:JSON.stringify({bytes_sent:n.publish.bytesSent,bytes_received:n.subscribe.bytesReceived,bitrate_sent:n.publish.bitrate,packets_received:n.subscribe.packetsReceived,packets_lost:n.subscribe.packetsLost,bitrate_received:n.subscribe.bitrate,round_trip_time:n.publish.totalRoundTripTime})})),Object.keys(i).forEach((e=>{const t=i[e],n="video"==t.kind,s=t.peerId==r,a=ga(sa.hmsSDKPeers[t.peerId]),o=fa(sa.hmsSDKTracks[e]);if(!o||!a)return;let l={type:"HMS_STAT",data:{peer:a,track:o}};s?n?(l.event="on_local_video_stats",l.data.local_video_stats={bytes_received:t.bytesSent||0,bitrate:t.bitrate||0,round_trip_time:0,frame_rate:t.framesPerSecond||0,resolution:{width:t.frameWidth||0,height:t.frameHeight||0}}):(l.event="on_local_audio_stats",l.data.local_audio_stats={bytes_received:t.bytesSent||0,bitrate:t.bitrate||0,round_trip_time:0}):n?(l.event="on_remote_video_stats",l.data.remote_video_stats={bytes_received:t.bytesReceived||0,jitter:t.jitter||0,bitrate:t.bitrate||0,packets_lost:t.packetsLost||0,packets_received:t.packetsReceived||0,frame_rate:t.frameRate||0,resolution:{width:t.frameWidth||0,height:t.frameHeight||0}}):(l.event="on_remote_audio_stats",l.data.remote_audio_stats={bytes_received:t.bytesReceived||0,jitter:t.jitter||0,bitrate:t.bitrate||0,packets_lost:t.packetsLost||0,packets_received:t.packetsReceived||0}),la(JSON.stringify(l))}))}function ha(e){return e?{end_room:e.endRoom,stop_presentation:e.stopPresentation,remove_others:e.removeOthers,mute:e.mute,un_mute:e.unMute,change_role_force:e.changeRoleForce,change_role:e.changeRole}:null}function pa(e){return e?{max_subs_bit_rate:e.maxSubsBitRate,map_display_tiles:e.maxDisplayTiles,subscribe_to_roles:e.subcribesToRoles}:null}function va(e){return e?{allowed:e.allowed,audio_setting:{bit_rate:e.audio.bitRate,codec:e.audio.codec},video_setting:{codec:e.video.codec,frame_rate:e.video.frameRate,width:e.video.width,height:e.video.height},screen_setting:{codec:e.screen.codec,frame_rate:e.screen.frameRate,width:e.screen.width,height:e.screen.height},video_simulCast:e.videoSimulCastLayers,screen_simulCast:e.screenSimulCastLayers}:null}function ma(e){return e?{name:e.name,publish_settings:va(e.publishParams),subscribe_settings:pa(e.subscribeParams),permissions:ha(e.permissions),priority:e.priority}:null}function ga(e){return e?{peer_id:e.peerId,name:e.name,is_local:e.isLocal,role:ma(e.role),metadata:e.metadata,customer_user_id:e.customerUserId,network_quality:e.networkQuality}:null}function fa(e){if(!e)return null;let t="audio"==e.type?e.settings:null,i="video"==e.type?e.settings:null;return t&&(t={bit_rate:t.maxBitrate,volume:t.volume,audio_codec:t.codec}),i&&(i={resolution:{height:i.height,width:i.width},video_codec:i.codec,bit_Rate:i.maxBitrate,max_frame_rate:i.maxFramerate,camera_facing:""}),{instance_of:"video"==e.type,track_id:e.publishedTrackId||e.sdpTrackId,track_description:"",track_source:e.source.toUpperCase(),track_kind:e.type.toUpperCase(),track_mute:!!e.enabled,volume:e.volume,is_degraded:!!e.degraded,hms_audio_track_settings:t,hms_video_track_settings:i}}function ya(e){if(!e)return null;let t=[];e.peers&&e.peers.forEach((e=>{t.push(ga(sa.hmsSDKPeers[e]))}));let i={browser_recording_state:e.recording.browser,rtmp_streaming_state:e.rtmp,server_recording_state:e.recording.server,hls_streaming_state:e.hls,hls_recording_state:e.recording.hls,id:e.id,name:e.name,peer_count:t.length,session_id:e.sessionId,peers:t};return i.browser_recording_state&&i.browser_recording_state.startedAt&&(i.browser_recording_state.started_at=i.browser_recording_state.startedAt),i.server_recording_state&&i.server_recording_state.startedAt&&(i.server_recording_state.started_at=i.server_recording_state.startedAt),i.hls_recording_state&&i.hls_recording_state.startedAt&&(i.hls_recording_state.started_at=i.hls_recording_state.startedAt),i}function Ta(e){if(!e)return null;let t=[];return e.forEach((e=>{t.push({meetingURL:e.meeting_url,metadata:e.meta_data})})),t}window.hmssdkjsVideoView=function(e,t){const i=JSON.parse(t);e&&i.track&&("attach"==i.type?(e.autoplay=!0,e.muted=!0,e.playsinline=!0,sa.attachVideo(i.track,e)):sa.detachVideo(i.track,e))},window.hmssdkjsSetNotificationsHandler=function(e){la=e},window.hmssdkjsHandleMethodCall=async function(e,t){switch(t=t?JSON.parse(t):null,console.log("Platform Call",e,t),e){case"build":return da&&clearInterval(da),da=null,na=new ra,na.triggerOnSubscribe(),sa=na.getActions(),aa=na.getStore(),oa=na.getNotifications(),aa.subscribe((e=>{la&&e&&la(JSON.stringify({type:"JOINED",data:ya(aa.getState(Mn))}))}),Vn),aa.subscribe(((e,t)=>{if(!la)return;if(!t)return;const i={type:"ROOM_UPDATED",data:{room:ya(e),update:""}};e.name!=t.name&&(i.data.update="room_name_updated",la(JSON.stringify(i))),e.recording.server.running!=t.recording.server.running&&(i.data.update="server_recording_state_updated",la(JSON.stringify(i))),e.recording.browser.running!=t.recording.browser.running&&(i.data.update="browser_recording_state_updated",la(JSON.stringify(i))),e.rtmp.running!=t.rtmp.running&&(i.data.update="rtmp_streaming_state_updated",la(JSON.stringify(i))),e.hls.running!=t.hls.running&&(i.data.update="hls_streaming_state_updated",la(JSON.stringify(i))),e.recording.hls.running!=t.recording.hls.running&&(i.data.update="hls_recording_state_updated",la(JSON.stringify(i)))}),Mn),oa.onNotification((e=>{switch(e.type){case"TRACK_ADDED":case"TRACK_REMOVED":case"TRACK_MUTED":case"TRACK_UNMUTED":case"TRACK_DESCRIPTION_CHANGED":case"TRACK_DEGRADED":case"TRACK_RESTORED":e.peer=ga(sa.hmsSDKPeers[e.data.peerId]),e.data=fa(sa.hmsSDKTracks[e.data.id]),e.update={TRACK_ADDED:"trackAdded",TRACK_REMOVED:"trackRemoved",TRACK_MUTED:"trackMuted",TRACK_UNMUTED:"trackUnMuted",TRACK_DESCRIPTION_CHANGED:"trackDescriptionChanged",TRACK_DEGRADED:"trackDegraded",TRACK_RESTORED:"trackRestored"}[e.type],e.type="TRACK_UPDATE";break;case"PEER_JOINED":case"PEER_LEFT":case"NAME_UPDATED":case"METADATA_UPDATED":case"ROLE_UPDATED":e.data=ga(sa.hmsSDKPeers[e.data.id]),e.update={PEER_JOINED:"peerJoined",PEER_LEFT:"peerLeft",NAME_UPDATED:"nameChanged",METADATA_UPDATED:"metadataChanged",ROLE_UPDATED:"roleUpdated"}[e.type],e.type="PEER_UPDATE";break;case"ROOM_ENDED":case"REMOVED_FROM_ROOM":e.data=(t=e.data)?{removed_from_room:{peer_who_removed:t.requestedBy?ga(sa.hmsSDKPeers[t.requestedBy]):null,reason:t.reason,room_was_ended:t.roomEnded}}:null,da&&clearInterval(da);break;case"NEW_MESSAGE":e.data={message:{sender:ga(sa.hmsSDKPeers[e.data.peerId]),hms_message_recipient:{recipient_peer:e.data.recipientPeer?ga(aa.getState(Cs(e.data.recipientPeer))):null,recipient_roles:e.data.recipientRoles?(()=>{let t=[];return e.data.recipientRoles.forEach((e=>{t.push(aa.getState((e=>en([ss],(t=>t[e])))(e)))})),t})():null,recipient_type:e.data.recipientPeer?"peer":e.data.recipientRoles?"roles":"broadCast"},message:e.data.message,type:e.data.type,time:`${e.data.time.getFullYear()}-${e.data.time.getMonth()+1}-${e.data.time.getDate()} ${e.data.time.getHours()}:${e.data.time.getMinutes()}:${e.data.time.getSeconds()}`}}}var t;e.inPreview=ca,la(JSON.stringify(e))})),!0;case"join":return sa.join({authToken:t.auth_token,userName:t.user_name,metaData:t.meta_data,initEndpoint:t.end_point,captureNetworkQualityInPreview:t.capture_network_quality_in_preview}),ca=!1,!0;case"preview":return sa.preview({authToken:t.auth_token,userName:t.user_name,metaData:t.meta_data,initEndpoint:t.end_point,captureNetworkQualityInPreview:t.capture_network_quality_in_preview}),ca=!0,!0;case"leave":return sa.leave(),null;case"get_room":return JSON.stringify(ya(aa.getState(Mn)));case"get_local_peer":{const e=sa.sdk.getWebrtcInternals().store.localPeerId;return JSON.stringify(ga(sa.hmsSDKPeers[e]))}case"get_remote_peers":{const e=sa.sdk.getWebrtcInternals().store.localPeerId;let t=[];return Object.keys(sa.hmsSDKPeers).forEach((i=>{if(i==e)return;const r=sa.hmsSDKPeers[i];t.push(ga(r))})),JSON.stringify(t)}case"get_peers":{let e=[];return Object.keys(sa.hmsSDKPeers).forEach((t=>{const i=sa.hmsSDKPeers[t];e.push(ga(i))})),JSON.stringify(e)}case"switch_audio":return await sa.setLocalAudioEnabled(!t.is_on),!0;case"is_audio_mute":{const e=t.peer_id;return e?aa.getState(Ds(e)):!aa.getState(Qn)}case"mute_all":return Object.keys(sa.hmsSDKTracks).forEach((e=>{const t=sa.hmsSDKTracks[e];"audio"==t.type&&(t.enabled=!1)})),!0;case"un_mute_all":return Object.keys(sa.hmsSDKTracks).forEach((e=>{const t=sa.hmsSDKTracks[e];"audio"==t.type&&(t.enabled=!0)})),!0;case"set_volume":{const e=t.track_id,i=t.volume;return await sa.setVolume(i,e),null}case"switch_video":return await sa.setLocalVideoEnabled(!t.is_on),!0;case"switch_camera":const i=aa.getState(Bn).videoInput,r=aa.getState(Gn).videoInputDeviceId;let n=0;for(let e=0;e<i.length;e++)if(r==i[e].deviceId){n=e;break}return++n>=i.length&&(n=0),await sa.setVideoSettings({deviceId:i[n].deviceId}),null;case"start_capturing":return await sa.setLocalVideoEnabled(!0),!0;case"stop_capturing":return await sa.setLocalVideoEnabled(!1),!0;case"is_video_mute":{const e=t.peed_id;return e?aa.getState(Os(e)):!aa.getState(Yn)}case"set_playback_allowed":{const e=t.allowed;return Object.keys(sa.hmsSDKTracks).forEach((t=>{const i=sa.hmsSDKTracks[t];"video"==i.type&&(i.enabled=e)})),!0}case"send_broadcast_message":{const e=t.message,i=t.type||"chat";return sa.sendBroadcastMessage(e,i)}case"send_direct_message":{const e=t.message,i=t.peer_id,r=t.type||"chat";return sa.sendDirectMessage(e,i,r)}case"send_group_message":{const e=t.message,i=t.roles,r=t.type||"chat";return sa.sendGroupMessage(e,i,r)}case"get_roles":{let e=[];const t=aa.getState(ss);return Object.keys(t).forEach((i=>{e.push(ma(t[i]))})),{roles:e}}case"change_role":return sa.changeRole(t.peer_id,t.role_name,t.force_change);case"accept_change_role":return sa.acceptChangeRole(aa.getState(Bs));case"end_room":return sa.endRoom(!!t.lock,t.reason||"End room invoked");case"remove_peer":return sa.removePeer(t.peer_id,t.reason||"Removed from room");case"on_change_track_state_request":return sa.setRemoteTrackEnabled(t.track_id,t.mute);case"change_track_state_for_role":return sa.setRemoteTracksEnabled({enabled:t.mute,roles:t.roles,type:t.type,source:t.source});case"change_metadata":return sa.changeMetadata(t.metadata);case"change_name":return sa.changeName(t.name);case"start_rtmp_or_recording":return sa.startRTMPOrRecording({meetingURL:t.meeting_url,rtmpURLs:t.rtmp_urls,record:t.to_record,resolution:t.resolution});case"stop_rtmp_and_recording":return sa.stopRTMPAndRecording();case"hls_start_streaming":return sa.startHLSStreaming({variants:Ta(t.meeting_url_variants),recording:t.recording_config?{singleFilePerLayer:t.recording_config.single_file_per_layer,hlsVod:t.recording_config.video_on_demand}:null});case"hls_stop_streaming":return sa.stopHLSStreaming({variants:Ta(t.meeting_url_variants)});case"start_screen_share":return await sa.setScreenShareEnabled(!0),!0;case"stop_screen_share":return await sa.setScreenShareEnabled(!1),!0;case"is_screen_share_active":return aa.getState(Xn);case"update_hms_video_track_settings":{const e=t.video_track_setting;return await sa.setVideoSettings({width:e.width,height:e.height,codec:e.video_codec,maxFramerate:e.max_frame_rate,maxBitrate:e.max_bit_rate})}case"get_track_by_id":return JSON.stringify(fa(sa.hmsSDKTracks[t.track_id]));case"get_all_tracks":{const e=t.peer_id,i=hmsState.getState(Cs(e));let r=[];i.videoTrack&&r.push(fa(sa.hmsSDKTracks[i.videoTrack])),i.audioTrack&&r.push(fa(sa.hmsSDKTracks[i.audioTrack]));for(let e=0;e<i.auxiliaryTracks.length;e++)r.push(fa(sa.hmsSDKTracks[i.auxiliaryTracks[e]]));return JSON.stringify(r)}case"start_stats_listener":return null==da&&(da=setInterval(ua,3e3)),null;case"remove_stats_listener":return da&&clearInterval(da),da=null,null;default:throw alert(e),alert(t),{code:"Unimplemented",details:`hmssdk_flutter for web doesn't implement '${e}`}}}})()})();